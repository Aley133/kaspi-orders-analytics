# Kaspi Orders Daily Count Service (LeoXpress, v0.2)

–ì–æ—Ç–æ–≤—ã–π –∫ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–∏—Å –Ω–∞ **FastAPI** –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ **LeoXpress** (Partner ID: 30295031).
–û–Ω –Ω–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ API Kaspi –∏ –≤—ã–¥–∞—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1) –õ–æ–∫–∞–ª—å–Ω–æ (Windows/Linux/Mac)
```bash
python -m venv .venv && . .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8899
```
–û—Ç–∫—Ä–æ–π: `http://localhost:8899`

### 2) Docker
```bash
docker build -t kaspi-orders:0.2 .
docker run --rm -p 8899:8899 --env-file .env kaspi-orders:0.2
```

### 3) –ë—ã—Å—Ç—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- Windows PowerShell: `./run_win.ps1` (–µ—Å–ª–∏ —Ä—É–≥–∞–µ—Ç—Å—è –ø–æ–ª–∏—Ç–∏–∫–∞ ‚Äì –∑–∞–ø—É—Å—Ç–∏ PowerShell ¬´–ó–∞–ø—É—Å–∫ –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞¬ª –∏ `Set-ExecutionPolicy Bypass -Scope Process`)
- Linux/Mac: `./run_unix.sh`

## –ü—Ä–æ–≤–µ—Ä–∫–∞
- `GET /health` ‚Äî –ø—Ä–æ—Å—Ç–æ–π ping —Å–µ—Ä–≤–∏—Å–∞.
- `GET /diagnostics/ping-kaspi` ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ Kaspi (1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π).
- `GET /orders/daily-count?start=YYYY-MM-DD&end=YYYY-MM-DD[&state=NEW][&tz=Asia/Almaty]` ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º.

–ü—Ä–∏–º–µ—Ä—ã:
```bash
curl "http://localhost:8899/health"
curl "http://localhost:8899/diagnostics/ping-kaspi"
curl "http://localhost:8899/orders/daily-count?start=2025-08-01&end=2025-08-19"
curl "http://localhost:8899/orders/daily-count?start=2025-08-01&end=2025-08-19&state=NEW"
```

## –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `http://localhost:8899/` ‚Äî –ø—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞: –≤—ã–±–∏—Ä–∞–µ—à—å –ø–µ—Ä–∏–æ–¥ –∏, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, state. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ä–∞–∑—É –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `KASPI_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –º–∞–≥–∞–∑–∏–Ω–∞ (—É–∂–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω).
- `PORT` ‚Äî –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8899).
- `TZ` ‚Äî —Ç–∞–π–º–∑–æ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Asia/Almaty).
- `DEFAULT_STATES` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä `NEW,PICKUP`.
- `CACHE_TTL` ‚Äî TTL –∫—ç—à–∞ (—Å–µ–∫).
- `PARTNER_ID`, `SHOP_NAME` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–¥–ª—è `/meta`).

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è: –¥–æ 100 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–π–¥—ë—Ç –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- –†–µ—Ç—Ä–∞–∏: –Ω–∞ 429/5xx –∏ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏.
- –¢–∞–π–º–∑–æ–Ω–∞: –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º –≤ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–∞–π–º–∑–æ–Ω–µ.

## –ù–æ–≤–æ–µ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–±–∏–∑–Ω–µ—Å-–¥–Ω—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20:00 ‚Üí 20:00): –∑–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `USE_BUSINESS_DAY=true` –∏ `BUSINESS_DAY_START=20:00`.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–∫–∏ –∏ –±–∞–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–Ω—è–º, —á—Ç–æ–±—ã –∑–∞–∫–∞–∑—ã 20:00‚Äì00:00 –Ω–µ –≤—ã–ø–∞–¥–∞–ª–∏.
- **–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞** (–∫–Ω–æ–ø–∫–∞ üåì ¬´–¢–µ–º–∞¬ª, –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ localStorage).
- –ì–æ—Ç–æ–≤—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ **Render** —á–µ—Ä–µ–∑ `render.yaml`.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Render)
1. Push –≤ GitHub.
2. –ù–∞ Render ‚Üí New ‚Üí **Blueprint** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. `render.yaml` –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
3. –í Variables –¥–æ–±–∞–≤—å—Ç–µ `KASPI_TOKEN` (**—Å–µ–∫—Ä–µ—Ç**), –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π. Healthcheck: `/meta`.

### –í–∞–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- `USE_BUSINESS_DAY=true`
- `BUSINESS_DAY_START=20:00` (—Ñ–æ—Ä–º–∞—Ç `HH:MM` –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞)
- `TZ=Asia/Almaty`

## –õ–æ–∫–∞–ª—å–Ω–æ
```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# Linux/Mac: source .venv/bin/activate

pip install -r requirements.txt
export KASPI_TOKEN=...  # Windows: set KASPI_TOKEN=...
uvicorn app.main:app --reload --port 8787
```
–û—Ç–∫—Ä–æ–π—Ç–µ: `http://127.0.0.1:8787/ui/`
