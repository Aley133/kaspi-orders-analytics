<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kaspi — Дашборд / Профит / Склад / Каталог</title>
  <link rel="stylesheet" href="/ui/assets/css/theme.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { --gap:16px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header.top { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    nav.tabs { display:flex; flex-wrap:wrap; gap:6px; }
    nav.tabs .tab { padding:8px 12px; border-radius:10px; background:var(--panel-bg); border:1px solid var(--border); cursor:pointer; }
    nav.tabs .tab.active { background: var(--accent-bg); color: var(--accent-fg); border-color: transparent; }
    .grid { display:grid; grid-template-columns: repeat(12,1fr); gap: var(--gap); }
    .col-12 { grid-column: span 12; }
    .col-6  { grid-column: span 6; }
    @media (max-width: 960px){ .col-6 { grid-column: span 12; } }
    .card { background: var(--panel-bg); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow: var(--shadow); }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap: 12px; }
    .kpi .k { font-size: 12px; opacity:.7; }
    .kpi .v { font-size: 20px; font-weight: 700; margin-top: 2px; }
    form.controls { display:flex; flex-wrap:wrap; gap: 8px; align-items: end; }
    form.controls label { display:flex; flex-direction:column; gap:4px; font-size:13px; }
    form.controls .btn { margin-left: 8px; }
    .row { display:flex; flex-wrap:wrap; gap: var(--gap); }
    .row > * { flex:1 1 320px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid var(--border); }
    th { text-align:left; font-weight:600; opacity:.8; }
    td.r { text-align:right; }
    .muted { opacity:.65; }
    .danger { color: #ff6b6b; font-weight:600; }
    .ok { color: #25c28a; font-weight:600; }
    canvas { width: 100%; height: 320px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
<div class="container">
  <header class="top">
    <h1>Kaspi — панель управления</h1>
    <nav class="tabs" id="tabs">
      <button class="tab active" data-pane="pane-dashboard">Дашборд</button>
      <button class="tab" data-pane="pane-profit">Профит</button>
      <button class="tab" data-pane="pane-inventory">Склад</button>
      <button class="tab" data-pane="pane-catalog">Каталог</button>
      <button class="tab" id="themeBtn" title="Светлая/тёмная тема">Тема</button>
    </nav>
  </header>

  <!-- ========== DASHBOARD ========== -->
  <section id="pane-dashboard" class="pane">
    <form id="fDash" class="controls card">
      <label>Начало <input type="date" id="d_start" required></label>
      <label>Конец <input type="date" id="d_end" required></label>
      <label>Дата по полю
        <select id="d_field">
          <option value="creationDate">creationDate</option>
          <option value="plannedShipmentDate">plannedShipmentDate</option>
          <option value="plannedDeliveryDate">plannedDeliveryDate</option>
          <option value="shipmentDate">shipmentDate</option>
          <option value="deliveryDate">deliveryDate</option>
        </select>
      </label>
      <label>Состояния (comma)
        <input type="text" id="d_states" placeholder="KASPI_DELIVERY">
      </label>
      <label class="chk"><input type="checkbox" id="d_excl" checked> Искл. отменённые</label>
      <label class="chk"><input type="checkbox" id="d_cutoff"> Cut-off</label>
      <label>Cut-off <input type="text" id="d_cutoff_time" placeholder="20:00"></label>
      <label>Lookback (дней) <input type="number" id="d_lookback" min="1" value="3" style="width:90px"></label>
      <div class="actions">
        <button class="btn primary" type="submit">Показать</button>
        <button class="btn" id="presetCreated" type="button">Пришло сегодня</button>
        <button class="btn" id="presetPlanned" type="button">План на сегодня</button>
        <button class="btn" id="presetDelivered" type="button">Доставлено сегодня</button>
        <button class="btn" id="presetPack" type="button">Kaspi: Упаковка (до 20:00)</button>
      </div>
    </form>

    <div class="card kpis" id="d_kpis"></div>

    <div class="grid">
      <div class="col-6 card">
        <h3>Заказы по дням</h3>
        <canvas id="chartOrders"></canvas>
      </div>
      <div class="col-6 card">
        <h3>Оборот по дням</h3>
        <canvas id="chartTurnover"></canvas>
      </div>
      <div class="col-12 card">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">Номера заказов (последние 100)</h3>
          <div class="actions">
            <button class="btn" id="d_copy">Скопировать номера</button>
            <a class="btn" id="d_csv" download>Скачать CSV</a>
          </div>
        </div>
        <div id="d_numbers" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size:12px; line-height:1.6;"></div>
      </div>
    </div>
  </section>

  <!-- ========== PROFIT ========== -->
  <section id="pane-profit" class="pane hidden">
    <div class="row">
      <div class="card">
        <h3>Настройки комиссий</h3>
        <form id="fProfitCfg" class="controls">
          <label>Комиссия, % <input type="number" step="0.01" id="p_comm"></label>
          <label>Эквайринг, % <input type="number" step="0.01" id="p_acq"></label>
          <label>Доставка, ₸ <input type="number" step="0.01" id="p_del"></label>
          <label>Прочие, ₸ <input type="number" step="0.01" id="p_other"></label>
          <button class="btn primary" type="submit">Сохранить</button>
        </form>
      </div>
      <div class="card">
        <h3>Расчёт прибыли</h3>
        <form id="fProfitRun" class="controls">
          <label>Начало <input type="date" id="p_start" required></label>
          <label>Конец <input type="date" id="p_end" required></label>
          <label>Дата по полю
            <select id="p_field">
              <option value="creationDate">creationDate</option>
              <option value="plannedShipmentDate">plannedShipmentDate</option>
              <option value="plannedDeliveryDate">plannedDeliveryDate</option>
              <option value="shipmentDate">shipmentDate</option>
              <option value="deliveryDate">deliveryDate</option>
            </select>
          </label>
          <label>Состояния (comma) <input id="p_states" placeholder="KASPI_DELIVERY,ARCHIVE"></label>
          <label class="chk"><input type="checkbox" id="p_cut_mode"> Cut-off</label>
          <label>Cut-off <input id="p_cut" placeholder="20:00"></label>
          <label>Lookback <input type="number" id="p_look" min="1" value="3" style="width:90px"></label>
          <button class="btn primary" type="submit">Посчитать</button>
        </form>
      </div>
    </div>
    <div class="card">
      <h3>Заказы (прибыль)</h3>
      <div id="p_table" class="muted">Пока пусто</div>
    </div>
  </section>

  <!-- ========== INVENTORY ========== -->
  <section id="pane-inventory" class="pane hidden">
    <div class="row">
      <div class="card">
        <h3>Новая поставка</h3>
        <form id="fBatch" class="controls">
          <label>Код товара <input id="i_code" required></label>
          <label>Название <input id="i_name" placeholder="опционально"></label>
          <label>Дата прихода <input type="datetime-local" id="i_date" required></label>
          <label>Себестоимость, ₸ <input type="number" step="0.01" id="i_cost" required></label>
          <label>Кол-во <input type="number" id="i_qty" min="1" required></label>
          <button class="btn primary" type="submit">Добавить</button>
        </form>
      </div>
      <div class="card">
        <h3>Порог и имя</h3>
        <form id="fThreshold" class="controls">
          <label>Код товара <input id="t_code" required></label>
          <label>Порог <input type="number" id="t_thr" required></label>
          <label>Витринное имя <input id="t_name"></label>
          <button class="btn" type="submit">Сохранить</button>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="actions">
        <button class="btn" id="i_reload">Обновить остатки</button>
      </div>
      <div id="i_stock" class="muted">Пока пусто</div>
    </div>
  </section>

  <!-- ========== CATALOG ========== -->
  <section id="pane-catalog" class="pane hidden">
    <div class="card">
      <div class="actions">
        <button class="btn" id="c_sync">Синхронизировать</button>
        <button class="btn" id="c_reload">Обновить список</button>
      </div>
      <div id="c_list" class="muted">Пока пусто</div>
    </div>
  </section>
</div>

<script type="module">
  // Тема
  import { initTheme } from '/ui/assets/js/state.js';
  initTheme();
</script>
<script>
  // Утилиты
  const $ = (s, el=document)=>el.querySelector(s);
  const tz = 'Asia/Almaty';
  const api = async (url, init)=>{ const r=await fetch(url, init); const t=await r.text(); try{return JSON.parse(t);}catch{ throw new Error(t);} };
  const fmt = (n)=> Number(n||0).toLocaleString(undefined, {maximumFractionDigits:2});
  function todayIso(d=new Date()){ return d.toISOString().slice(0,10); }
  function shiftDays(n){ const d=new Date(); d.setDate(d.getDate()+n); return todayIso(d); }

  // Навигация вкладок
  const tabs = document.querySelectorAll('#tabs .tab[data-pane]');
  tabs.forEach(t=>t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.add('hidden'));
    t.classList.add('active');
    document.getElementById(t.dataset.pane).classList.remove('hidden');
  }));

  // ==== DASHBOARD ====
  const d = {
    start: $('#d_start'), end: $('#d_end'), field: $('#d_field'), states: $('#d_states'),
    excl: $('#d_excl'), cutoff: $('#d_cutoff'), cutoffTime: $('#d_cutoff_time'),
    look: $('#d_lookback'), kpis: $('#d_kpis'), nums: $('#d_numbers'), csv: $('#d_csv'),
    copy: $('#d_copy')
  };
  d.end.value = todayIso();
  d.start.value = shiftDays(-6);
  d.cutoffTime.value = '20:00';

  let chartOrders, chartTurnover;
  function makeLineChart(id, label, labels, data){
    if (window[id]) window[id].destroy?.();
    const ctx = document.getElementById(id);
    window[id] = new Chart(ctx, {
      type:'line',
      data:{labels,datasets:[{label,data,borderWidth:2,tension:.3}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
    });
  }

  async function dashLoad(e){
    if (e) e.preventDefault();
    const q = new URLSearchParams();
    q.set('start', d.start.value);
    q.set('end', d.end.value);
    q.set('tz', tz);
    q.set('date_field', d.field.value || 'creationDate');
    const st = d.states.value.trim(); if (st) q.set('states', st);
    if (d.excl.checked) q.set('exclude_canceled', 'true');
    if (d.cutoff.checked){
      q.set('cutoff_mode','true');
      q.set('cutoff', d.cutoffTime.value || '20:00');
      q.set('lookback_days', d.look.value || '3');
    }

    const A = await api('/analytics?' + q.toString());
    const daily = A.daily || [];
    const totalOrders = daily.reduce((s,x)=>s+(x.count||0),0);
    const totalAmount = daily.reduce((s,x)=>s+(x.amount||0),0);
    const avg = totalOrders? totalAmount/totalOrders : 0;

    d.kpis.innerHTML = `
      <div class="kpi"><div class="k">Период</div><div class="v">${A.range?.start} → ${A.range?.end}</div></div>
      <div class="kpi"><div class="k">Всего заказов</div><div class="v">${fmt(totalOrders)}</div></div>
      <div class="kpi"><div class="k">Оборот, ₸</div><div class="v">${fmt(totalAmount)}</div></div>
      <div class="kpi"><div class="k">Средний чек, ₸</div><div class="v">${fmt(avg)}</div></div>`;

    const labels = daily.map(d=>d.date);
    makeLineChart('chartOrders','Заказы',labels,daily.map(d=>d.count||0));
    makeLineChart('chartTurnover','Оборот',labels,daily.map(d=>d.amount||0));

    // номера
    const idsQ = new URLSearchParams(q);
    const ids = await api('/orders/ids?' + idsQ.toString());
    d.nums.textContent = ids.items.slice(0,100).map(x=>x.number).filter(Boolean).join(', ');
    d.csv.href = '/orders/ids.csv?' + idsQ.toString();
    d.copy.onclick = ()=> navigator.clipboard.writeText(ids.items.map(x=>x.number).join('\n'));
  }
  $('#fDash').addEventListener('submit', dashLoad);
  $('#presetCreated').onclick = ()=>{ d.field.value='creationDate'; d.states.value=''; d.cutoff.checked=false; dashLoad(); };
  $('#presetPlanned').onclick = ()=>{ d.field.value='plannedDeliveryDate'; d.states.value=''; d.cutoff.checked=false; dashLoad(); };
  $('#presetDelivered').onclick = ()=>{ d.field.value='deliveryDate'; d.states.value=''; d.cutoff.checked=false; dashLoad(); };
  $('#presetPack').onclick = ()=>{ d.field.value='plannedShipmentDate'; d.states.value='KASPI_DELIVERY,ARCHIVE'; d.cutoff.checked=true; d.cutoffTime.value='20:00'; dashLoad(); };
  dashLoad();

  // ==== PROFIT ====
  const p = {
    comm: $('#p_comm'), acq: $('#p_acq'), del: $('#p_del'), other: $('#p_other'),
    start: $('#p_start'), end: $('#p_end'), field: $('#p_field'), states: $('#p_states'),
    cutMode: $('#p_cut_mode'), cut: $('#p_cut'), look: $('#p_look'),
    tbl: $('#p_table')
  };
  p.end.value = todayIso(); p.start.value = shiftDays(-6); p.cut.value='20:00';

  async function profitLoadCfg(){
    const cfg = await api('/profit/config');
    p.comm.value = cfg.commission_percent ?? 0;
    p.acq.value  = cfg.acquiring_percent ?? 0;
    p.del.value  = cfg.delivery_fixed ?? 0;
    p.other.value= cfg.other_fixed ?? 0;
  }
  $('#fProfitCfg').addEventListener('submit', async e=>{
    e.preventDefault();
    await api('/profit/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        commission_percent: Number(p.comm.value||0),
        acquiring_percent: Number(p.acq.value||0),
        delivery_fixed: Number(p.del.value||0),
        other_fixed: Number(p.other.value||0),
      })
    });
    await profitLoadCfg();
  });

  $('#fProfitRun').addEventListener('submit', async e=>{
    e.preventDefault();
    const q = new URLSearchParams();
    q.set('start', p.start.value); q.set('end', p.end.value);
    q.set('tz', tz); q.set('date_field', p.field.value||'creationDate');
    const st = p.states.value.trim(); if (st) q.set('states', st);
    if (p.cutMode.checked){ q.set('cutoff_mode','true'); q.set('cutoff', p.cut.value||'20:00'); q.set('lookback_days', p.look.value||'3'); }

    const R = await api('/profit/orders?' + q.toString());
    // R.orders: [{number,date,amount,cost,profit,...}]
    const rows = (R.orders||[]).map(o=>[
      o.number, (o.date||'').replace('T',' ').slice(0,16),
      fmt(o.amount), fmt(o.cost), fmt(o.profit)
    ]);
    p.tbl.innerHTML = '';
    p.tbl.insertAdjacentHTML('beforeend', `
      <div class="kpis" style="margin-bottom:8px">
        <div class="kpi"><div class="k">Выручка</div><div class="v">${fmt(R.total_amount)} ₸</div></div>
        <div class="kpi"><div class="k">Себестоимость</div><div class="v">${fmt(R.total_cost)} ₸</div></div>
        <div class="kpi"><div class="k">Прибыль</div><div class="v">${fmt(R.total_profit)} ₸</div></div>
        <div class="kpi"><div class="k">Маржа, %</div><div class="v">${fmt(R.margin_percent)}</div></div>
      </div>`);
    p.tbl.insertAdjacentHTML('beforeend', tableHtml(['№','Дата','Сумма','Себес-ть','Прибыль'], rows));
  });
  profitLoadCfg();

  // ==== INVENTORY ====
  $('#fBatch').addEventListener('submit', async e=>{
    e.preventDefault();
    const payload = {
      product_code: $('#i_code').value.trim(),
      product_name: $('#i_name').value.trim() || null,
      received_at: $('#i_date').value,
      unit_cost: Number($('#i_cost').value||0),
      qty_in: Number($('#i_qty').value||0)
    };
    await api('/inventory/batch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    await invReload();
    e.target.reset();
  });
  $('#fThreshold').addEventListener('submit', async e=>{
    e.preventDefault();
    const payload = { product_code: $('#t_code').value.trim(), threshold: Number($('#t_thr').value||0), preferred_name: $('#t_name').value.trim()||null };
    await api('/inventory/threshold', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    await invReload();
  });
  $('#i_reload').onclick = invReload;

  async function invReload(){
    const S = await api('/inventory/stock');
    const rows = (S.items||[]).map(x=>{
      const low = (x.threshold||0)>0 && (x.qty||0) <= x.threshold;
      return [ x.product_code, x.name||'', x.qty, x.threshold||'', low?'<span class="danger">Ниже порога</span>':'<span class="ok">OK</span>' ];
    });
    $('#i_stock').innerHTML = tableHtml(['Код','Название','Остаток','Порог','Статус'], rows);
  }
  invReload();

  // ==== CATALOG ====
  $('#c_sync').onclick = async ()=>{ await api('/catalog/sync', {method:'POST'}); await catReload(); };
  $('#c_reload').onclick = catReload;
  async function catReload(){
    const L = await api('/catalog/list');
    const rows = (L.items||[]).map(x=>[x.code||'', x.name||'', x.active?'Да':'Нет']);
    $('#c_list').innerHTML = tableHtml(['Код','Название','Активен'], rows);
  }
  catReload();

  // helpers
  function tableHtml(headers, rows){
    const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=>`<td class="${i===r.length-1?'r':''}">${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
    return `<table>${thead}${tbody}</table>`;
  }
</script>
</body>
</html>
