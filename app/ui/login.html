<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход — Kaspi Orders Analytics</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:#0b0d12;color:#e6e8f0}
    .wrap{max-width:420px;margin:6rem auto;padding:2rem;background:#121622;border:1px solid #242a3a;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    h1{margin:.2rem 0 1.2rem 0;font-size:1.35rem}
    .muted{opacity:.75}
    label{display:block;margin:.75rem 0 .35rem}
    input{width:100%;padding:.8rem 1rem;border-radius:10px;border:1px solid #2e3650;background:#0e1120;color:#fff;outline:none}
    input:focus{border-color:#5b8aff;box-shadow:0 0 0 3px rgba(91,138,255,.25)}
    button{display:inline-flex;align-items:center;gap:.6rem;padding:.72rem 1rem;border-radius:10px;border:1px solid #3554ff;background:#4460ff;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#161b2c;border-color:#2b3452}
    .row{display:flex;gap:.6rem;align-items:center}
    .row > *{flex:1}
    .mt{margin-top:1rem}
    .ok{color:#7bf59b}
    .err{color:#ff6c6c}
    .card{padding:1rem;border:1px solid #2b3452;border-radius:12px;background:#0e1220}
    .center{text-align:center}
    code{background:#0d1222;border:1px solid #253057;border-radius:8px;padding:2px 6px}
    .qr{display:flex;justify-content:center;margin:.6rem 0}
    a{color:#8db2ff;text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Вход в Kaspi Orders Analytics</h1>
  <p class="muted">Войдите по e-mail. После входа можно включить 2FA (TOTP).</p>

  <div id="state" class="card" style="display:none;"></div>

  <div id="step-send">
    <label for="email">Ваш e-mail</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
    <div class="row mt">
      <button id="btn-send">Выслать ссылку для входа</button>
      <button id="btn-to-app" class="secondary" type="button" title="Открыть приложение">Открыть /ui</button>
    </div>
    <p class="muted mt">Письмо придёт с нашего домена <code>leo-analytics.com</code>.  
      Разрешённый редирект — <code>/ui/login.html</code>.</p>
  </div>

  <div id="step-logged" style="display:none;">
    <p>Вы вошли как <b id="who"></b>.</p>
    <div id="aal" class="muted"></div>

    <div id="mfa-needed" class="card mt" style="display:none;">
      <b>Подтвердите вход 2FA</b>
      <p class="muted">Введите код из приложения-аутентификатора.</p>
      <div class="row">
        <input id="otp-login" placeholder="6-значный код" inputmode="numeric" />
        <button id="btn-verify-login">Подтвердить</button>
      </div>
      <div id="mfa-login-msg" class="mt"></div>
    </div>

    <div id="mfa-enroll" class="card mt" style="display:none;">
      <b>Подключить 2FA (TOTP)</b>
      <p class="muted">Сканируйте QR в Google Authenticator, 1Password, Authy и т.д., затем введите код.</p>
      <div class="qr" id="qr"></div>
      <div class="row">
        <input id="otp-enroll" placeholder="6-значный код" inputmode="numeric" />
        <button id="btn-verify-enroll">Активировать</button>
      </div>
      <div class="mt center"><span class="muted">Секрет:</span> <code id="secret"></code></div>
      <div id="enroll-msg" class="mt"></div>
    </div>

    <div class="row mt">
      <button id="btn-app">Перейти в приложение</button>
      <button id="btn-logout" class="secondary">Выйти</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
(async () => {
  // === Настройки Supabase (anon-key публичный) ===
  const SUPABASE_URL = "https://evmdqyngzleandtfkanv.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWRxeW5nemxlYW5kdGZrYW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg4NTIsImV4cCI6MjA3MjkzNDg1Mn0.9cd3U-CflWZlIaSfPonCYg0zaI9HCPs9qYcqbKPI7hw";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const el = (id) => document.getElementById(id);
  const show = (id, v=true) => (el(id).style.display = v ? "" : "none");
  const setMsg = (id, msg, cls="muted") => { el(id).className = cls; el(id).textContent = msg; el(id).style.display = msg ? "" : "none"; };
  const state = (m, ok=false) => { el("state").style.display=""; el("state").className="card " + (ok?"ok":"err"); el("state").textContent=m; };

  // Сохранение/парсинг access_token из хэша (после magic-link)
  const params = new URLSearchParams(location.hash.slice(1));
  if (params.get("access_token")) {
    const access_token = params.get("access_token");
    const refresh_token = params.get("refresh_token");
    localStorage.setItem("SUPA_JWT", access_token);
    try {
      await sb.auth.setSession({ access_token, refresh_token });
    } catch {}
    history.replaceState(null, "", location.pathname + location.search);
  }

  // UI helpers
  el("btn-to-app").onclick = () => location.href = "/ui/";
  el("btn-app").onclick = () => location.href = "/ui/";
  el("btn-logout").onclick = async () => { try { await sb.auth.signOut(); } catch {} localStorage.removeItem("SUPA_JWT"); location.reload(); };

  // Отправка magic-link
  el("btn-send").onclick = async () => {
    const email = el("email").value.trim();
    if (!email) return state("Укажите e-mail", false);
    state("Отправляем письмо…");
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: "https://leo-analytics.com/ui/login.html" }
    });
    if (error) return state("Ошибка: " + error.message, false);
    state("Проверьте почту: отправили письмо со ссылкой для входа ✔", true);
  };

  // Проверка авторизации
  async function refreshSessionUI() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      show("step-send", true);
      show("step-logged", false);
      return;
    }
    show("step-send", false);
    show("step-logged", true);
    el("who").textContent = user.email || user.user_metadata?.name || user.id;

    // AAL (уровень аутентификации)
    const { data: aalData } = await sb.auth.mfa.getAuthenticatorAssuranceLevel();
    const aal = aalData?.currentLevel || aalData?.current || 'aal1';
    el("aal").textContent = `Текущий уровень: ${aal}`;

    // Узнаем факторы пользователя
    const { data: factorsData } = await sb.auth.mfa.listFactors();
    const totpVerified = (factorsData?.totp?.filter(f => f.status === "verified") || [])[0];

    // Если TOTP подключен, а AAL не aal2 — предложим ввести код (challenge)
    if (totpVerified && aal !== "aal2") {
      show("mfa-needed", true);
      setMsg("mfa-login-msg", "");
      let challengeId = null;

      const startChallenge = async () => {
        const { data, error } = await sb.auth.mfa.challenge({ factorId: totpVerified.id });
        if (error) { setMsg("mfa-login-msg","Ошибка challenge: "+error.message,"err"); return; }
        challengeId = data.id;
      };
      await startChallenge();

      el("btn-verify-login").onclick = async () => {
        const code = el("otp-login").value.trim();
        if (!code) return;
        const { error } = await sb.auth.mfa.verify({ factorId: totpVerified.id, challengeId, code });
        if (error) { setMsg("mfa-login-msg","Код не подошёл: "+error.message,"err"); await startChallenge(); return; }
        setMsg("mfa-login-msg","Готово! Доступ повышен до AAL2 ✔","ok");
        // обновим отображение
        setTimeout(refreshSessionUI, 600);
      };
    } else {
      show("mfa-needed", false);
    }

    // Если TOTP ещё не подключен — предложим подключить (enroll)
    if (!totpVerified) {
      show("mfa-enroll", true);
      setMsg("enroll-msg", "");
      const { data, error } = await sb.auth.mfa.enroll({ factorType: "totp" });
      if (error) { setMsg("enroll-msg","Ошибка enroll: "+error.message,"err"); return; }
      const { id: factorId, totp } = data;
      el("secret").textContent = totp.secret;

      // QR
      const qrNode = el("qr");
      qrNode.innerHTML = "";
      new QRCode(qrNode, { text: totp.qr_code, width: 180, height: 180 });

      // Подтверждение кода
      el("btn-verify-enroll").onclick = async () => {
        const code = el("otp-enroll").value.trim();
        if (!code) return;
        const { error: vErr } = await sb.auth.mfa.verify({ factorId, code });
        if (vErr) { setMsg("enroll-msg","Код не подошёл: "+vErr.message,"err"); return; }
        setMsg("enroll-msg","2FA включена ✔","ok");
        setTimeout(refreshSessionUI, 800);
      };
    } else {
      show("mfa-enroll", false);
    }
  }

  // Восстанавливаем сессии из локального access_token (для совместимости с твоим UI)
  (function restoreLocalJWT(){
    const t = localStorage.getItem("SUPA_JWT");
    if (t) {
      // ничего не делаем — основной токен уже будет использован в authFetch, а Supabase сам держит свою сессию
    }
  })();

  await refreshSessionUI();
})();
</script>
</body>
</html>
