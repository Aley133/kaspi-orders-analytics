<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í—Ö–æ–¥ ‚Äî Kaspi Orders Analytics</title>

  <!-- Supabase JS -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--bg:#0b1020;--panel:#111827;--panel-2:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--primary:#3b82f6;--primary-2:#1d4ed8;--ok:#16a34a;--err:#ef4444;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1224);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center}
    .wrap{width:100%;max-width:460px;padding:24px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    .hdr{padding:18px 20px;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:10px}
    .hdr h1{margin:0;font-size:18px;font-weight:700}
    .body{padding:20px}
    .tabs{display:flex;gap:6px;margin-bottom:16px}
    .tabs button{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #263044;background:var(--panel-2);color:#cbd5e1;cursor:pointer}
    .tabs button.active{border-color:#3b82f6;background:#1e293b;color:#fff}
    label{display:block;margin-top:10px;margin-bottom:6px;color:#93c5fd;font-size:12px}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--text);outline:none}
    input:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.22)}
    .row{display:flex;gap:10px}
    .btn{width:100%;padding:12px 14px;border-radius:10px;border:0;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--primary-2)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px;margin-top:10px;text-align:center}
    .msg{margin:10px 0;padding:10px 12px;border-radius:10px;border:1px solid transparent;display:none}
    .msg.ok{display:block;background:rgba(22,163,74,.12);border-color:rgba(16,185,129,.35);color:#bbf7d0}
    .msg.err{display:block;background:rgba(239,68,68,.09);border-color:rgba(248,113,113,.35);color:#fecaca}
    .hidden{display:none}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:#94a3b8}
    .toggle{display:flex;gap:8px;align-items:center;cursor:pointer;font-size:12px}
    .kbd{background:#0b1220;border:1px solid #233047;padding:2px 6px;border-radius:6px}
    /* debug panel */
    .debug{margin-top:10px;background:#0b1220;border:1px dashed #334155;border-radius:10px;padding:10px 12px;display:none}
    .debug pre{white-space:pre-wrap;word-break:break-word;margin:0;max-height:220px;overflow:auto}
    .link{color:#cbd5e1;text-decoration:underline dotted}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hdr">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3l9 7-9 7-9-7 9-7z" stroke="#60a5fa" stroke-width="1.5"/><path d="M3 10l9 7 9-7" stroke="#60a5fa" opacity=".45"/></svg>
        <h1>–í—Ö–æ–¥ –≤ Kaspi Orders Analytics</h1>
      </div>

      <div class="body">
        <div class="tabs">
          <button id="tab-email" class="active">–ü–æ e-mail</button>
          <button id="tab-phone">–ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (SMS)</button>
        </div>

        <!-- EMAIL -->
        <form id="form-email">
          <label for="email">–í–∞—à e-mail</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required>
          <button class="btn" id="btn-email-send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥/—Å—Å—ã–ª–∫—É</button>

          <div class="msg ok" id="email-ok"></div>
          <div class="msg err" id="email-err"></div>

          <div id="email-verify" class="hidden">
            <label for="email-code">–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞ (–µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª)</label>
            <div class="row">
              <input id="email-code" inputmode="numeric" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥">
              <button class="btn" id="btn-email-verify" type="button" style="width:160px">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
          </div>

          <div class="foot">
            <span class="muted">–ü–∏—Å—å–º–æ –ø—Ä–∏–¥—ë—Ç —Å –¥–æ–º–µ–Ω–∞ <span class="kbd" id="mail-from">‚Ä¶</span></span>
            <a class="link" href="/ui/" title="–ï—Å–ª–∏ —É–∂–µ –≤–æ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ UI">–û—Ç–∫—Ä—ã—Ç—å /ui</a>
          </div>
        </form>

        <!-- PHONE -->
        <form id="form-phone" class="hidden">
          <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="phone" type="tel" inputmode="tel" placeholder="+7701XXXXXXX">
          <button class="btn" id="btn-sms-send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS-–∫–æ–¥</button>

          <div class="msg ok" id="sms-ok"></div>
          <div class="msg err" id="sms-err"></div>

          <div id="sms-verify" class="hidden">
            <label for="sms-code">–ö–æ–¥ –∏–∑ SMS</label>
            <div class="row">
              <input id="sms-code" inputmode="numeric" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥">
              <button class="btn" id="btn-sms-verify" type="button" style="width:160px">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
          </div>
        </form>

        <label class="toggle" id="dbg-toggle" style="margin-top:14px">
          <input id="dbg-check" type="checkbox">&nbsp;üêû –û—Ç–ª–∞–¥–∫–∞
        </label>
        <div class="debug" id="dbg">
          <div style="font-weight:600;margin-bottom:6px">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞</div>
          <pre id="dbg-pre">‚Äî</pre>
        </div>

        <p class="muted" style="margin-top:8px">
          –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Supabase Auth. –ï—Å–ª–∏ –ø–∏—Å—å–º–æ/–°–ú–° –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:
          –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å <em>rate limit</em> –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—É—é –æ—à–∏–±–∫—É (<em>504 timeout</em>).
        </p>
      </div>
    </div>
  </div>

<script>
  // ---------- UI –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  const tabEmail = document.getElementById('tab-email');
  const tabPhone = document.getElementById('tab-phone');
  const formEmail = document.getElementById('form-email');
  const formPhone = document.getElementById('form-phone');
  tabEmail.onclick = () => { tabEmail.classList.add('active'); tabPhone.classList.remove('active'); formEmail.classList.remove('hidden'); formPhone.classList.add('hidden'); }
  tabPhone.onclick = () => { tabPhone.classList.add('active'); tabEmail.classList.remove('active'); formPhone.classList.remove('hidden'); formEmail.classList.add('hidden'); }

  // ---------- –ú–∏–Ω–∏ debug-–ø–∞–Ω–µ–ª—å
  const dbg = document.getElementById('dbg');
  const dbgCheck = document.getElementById('dbg-check');
  const dbgPre = document.getElementById('dbg-pre');
  dbgCheck.addEventListener('change', () => dbg.style.display = dbgCheck.checked ? 'block' : 'none');
  function debugDump(title, obj){
    if (!dbgCheck.checked) return;
    const payload = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    dbgPre.textContent = `${title}\n${payload}`;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ hash (–µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –ø–æ magic-link)
  (() => {
    const p = new URLSearchParams(location.hash.slice(1));
    const token = p.get('access_token');
    if (token) {
      localStorage.setItem('SUPA_JWT', token);
      history.replaceState(null,'', location.pathname + location.search);
    }
  })();


  const FALLBACK_META = {
    SUPABASE_URL: 'https://evmdqyngzleandtfkanv.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bWRxeW5nemxlYW5kdGZrYW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg4NTIsImV4cCI6MjA3MjkzNDg1Mn0.9cd3U-CflWZlIaSfPonCYg0zaI9HCPs9qYcqbKPI7hw'
  };

  let supa, meta;

  async function loadMeta() {
    const attempts = [
      () => fetch('/auth/meta', { cache: 'no-store' }),  // <-- –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ
      () => fetch('/meta',      { cache: 'no-store' }),
    ];
    let lastErr;
    for (const attempt of attempts) {
      try {
        const r = await attempt();
        if (r.ok) return await r.json();
        lastErr = new Error(`GET ${r.url || 'meta'} -> ${r.status} ${r.statusText}`);
      } catch (e) { lastErr = e; }
    }
    console.warn('Using FALLBACK_META due to:', lastErr);
    return FALLBACK_META;
  }

  (async function init() {
    try {
      meta = await loadMeta();
      if (!meta?.SUPABASE_URL || !meta?.SUPABASE_ANON_KEY) {
        throw new Error('Meta keys missing');
      }
      supa = window.supabase.createClient(meta.SUPABASE_URL, meta.SUPABASE_ANON_KEY);
      // –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ: –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ–º–µ–Ω –∏–∑ Supabase URL
      document.getElementById('mail-from').textContent = new URL(meta.SUPABASE_URL).host;
    } catch (e) {
      const err = document.getElementById('email-err');
      err.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ /auth/meta.';
      err.style.display = 'block';
      const dbgCheck = document.getElementById('dbg-check');
      const dbg = document.getElementById('dbg'); const pre = document.getElementById('dbg-pre');
      dbgCheck.checked = true; dbg.style.display = 'block';
      pre.textContent = (e?.message || '') + '\n' + (e?.stack || '');
    }
  })();


  // ---------- –£—Ç–∏–ª–∏—Ç—ã –æ—à–∏–±–æ–∫
  function showOk(el, msg){ el.textContent = msg; el.classList.remove('err'); el.classList.add('ok'); el.style.display='block'; }
  function showErr(el, msg){ el.textContent = msg; el.classList.remove('ok'); el.classList.add('err'); el.style.display='block'; }

  function humanizeError(err){
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–µ–π—Å—ã GoTrue/Supabase
    const raw = err?.message || '';
    const status = err?.status ?? err?.code;

    if (status === 429 || /rate limit/i.test(raw)) {
      return '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1‚Äì2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
    }
    if (status === 504 || /timed out|timeout/i.test(raw)) {
      return '–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.';
    }
    if (/invalid email|invalid format/i.test(raw)) {
      return '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    }
    if (/SMS/i.test(raw) && /not enabled|disabled/i.test(raw)) {
      return '–í—Ö–æ–¥ –ø–æ SMS –≤—ã–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Supabase (Auth ‚Üí Providers ‚Üí Phone). –í–∫–ª—é—á–∏—Ç–µ –µ–≥–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.';
    }
    if (/FetchError|network/i.test(raw)) {
      return '–°–µ—Ç–µ–≤–æ–π —Å–±–æ–π –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Supabase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –ª–∏–±–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.';
    }
    // –ü—É—Å—Ç–∞—è –æ—à–∏–±–∫–∞ ‚Äî —Ç–æ–∂–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è ({}), –ø–æ–∫–∞–∂–µ–º —Ö–æ—Ç—è –±—ã —Å—Ç–∞—Ç—É—Å
    if (!raw && status) {
      return `–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω (HTTP ${status}). –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.`;
    }
    return raw || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π—Ç–µ ¬´–û—Ç–ª–∞–¥–∫–∞¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.';
  }

  // ---------- EMAIL: –æ—Ç–ø—Ä–∞–≤–∫–∞
  document.getElementById('form-email').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const ok = document.getElementById('email-ok');
    const err = document.getElementById('email-err');
    ok.style.display = err.style.display = 'none';

    if (!email) { showErr(err, '–£–∫–∞–∂–∏—Ç–µ e-mail.'); return; }
    if (!supa) { showErr(err, '–ö–ª–∏–µ–Ω—Ç Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.'); return; }

    const btn = document.getElementById('btn-email-send');
    btn.disabled = true;

    try{
      // –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥ ‚Äî Supabase –ø–æ—à–ª—ë—Ç –º–∞–≥–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –ò–õ–ò OTP-–∫–æ–¥,
      // –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ–ø—Ü–∏–∏ ¬´Email OTP¬ª –≤ Auth ‚Üí Providers ‚Üí Email
      const { error } = await supa.auth.signInWithOtp({
        email,
        options: {
          shouldCreateUser: true,
          emailRedirectTo: location.origin + '/ui/'
        }
      });

      if (error) {
        debugDump('signInWithOtp error', error);
        showErr(err, humanizeError(error));
        return;
      }

      showOk(ok, '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥—è—â–∏–µ/—Å–ø–∞–º. –ï—Å–ª–∏ –≤ –ø–∏—Å—å–º–µ –ø—Ä–∏—à—ë–ª –∫–æ–¥ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.');
      document.getElementById('email-verify').classList.remove('hidden');
    }catch(ex){
      debugDump('signInWithOtp exception', ex);
      showErr(err, humanizeError(ex));
    }finally{
      btn.disabled = false;
    }
  });

  // ---------- EMAIL: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω Email OTP)
  document.getElementById('btn-email-verify').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const token = document.getElementById('email-code').value.trim();
    const err = document.getElementById('email-err');
    err.style.display = 'none';

    if (!email || !token) { showErr(err, '–£–∫–∞–∂–∏—Ç–µ e-mail –∏ –∫–æ–¥.'); return; }
    if (!supa) { showErr(err, '–ö–ª–∏–µ–Ω—Ç Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.'); return; }

    try{
      const { data, error } = await supa.auth.verifyOtp({ email, token, type: 'email' });
      if (error) {
        debugDump('verifyOtp(email) error', error);
        showErr(err, humanizeError(error));
        return;
      }
      if (data?.session?.access_token) {
        localStorage.setItem('SUPA_JWT', data.session.access_token);
      }
      location.href = '/ui/';
    }catch(ex){
      debugDump('verifyOtp(email) exception', ex);
      showErr(err, humanizeError(ex));
    }
  });

  // ---------- PHONE: –æ—Ç–ø—Ä–∞–≤–∫–∞
  document.getElementById('form-phone').addEventListener('submit', async (e) => {
    e.preventDefault();
    const phone = document.getElementById('phone').value.trim();
    const ok = document.getElementById('sms-ok');
    const err = document.getElementById('sms-err');
    ok.style.display = err.style.display = 'none';

    if (!/^\+\d{7,15}$/.test(phone)) { showErr(err, '–§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞: +7701‚Ä¶'); return; }
    if (!supa) { showErr(err, '–ö–ª–∏–µ–Ω—Ç Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.'); return; }

    const btn = document.getElementById('btn-sms-send');
    btn.disabled = true;

    try{
      const { error } = await supa.auth.signInWithOtp({ phone, options: { shouldCreateUser: true } });
      if (error) {
        debugDump('signInWithOtp(SMS) error', error);
        showErr(err, humanizeError(error));
        return;
      }
      showOk(ok, '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.');
      document.getElementById('sms-verify').classList.remove('hidden');
    }catch(ex){
      debugDump('signInWithOtp(SMS) exception', ex);
      showErr(err, humanizeError(ex));
    }finally{
      btn.disabled = false;
    }
  });

  // ---------- PHONE: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  document.getElementById('btn-sms-verify').addEventListener('click', async () => {
    const phone = document.getElementById('phone').value.trim();
    const token = document.getElementById('sms-code').value.trim();
    const err = document.getElementById('sms-err');
    err.style.display = 'none';

    if (!phone || !token) { showErr(err, '–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –∫–æ–¥.'); return; }

    try{
      const { data, error } = await supa.auth.verifyOtp({ phone, token, type: 'sms' });
      if (error) {
        debugDump('verifyOtp(SMS) error', error);
        showErr(err, humanizeError(error));
        return;
      }
      if (data?.session?.access_token) {
        localStorage.setItem('SUPA_JWT', data.session.access_token);
      }
      location.href = '/ui/';
    }catch(ex){
      debugDump('verifyOtp(SMS) exception', ex);
      showErr(err, humanizeError(ex));
    }
  });
</script>
</body>
</html>
