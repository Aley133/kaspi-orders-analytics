<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <style>
    body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:1400px;margin:20px auto;padding:0 12px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#1f7aee;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.secondary{background:#e9eef6;color:#1f2a37}
    input[type="text"],input[type="number"],select{height:34px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px}
    .muted{color:#6b7280}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:middle}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#9ca3af}
    .dot.on{background:#10b981}
    .detail{background:#f8fafc}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .btn-link{background:transparent;color:#2563eb;border:0;cursor:pointer;padding:0}
    .col-right{text-align:right}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Мой склад</h1>

  <div class="row" style="margin-bottom:10px">
    <label><input id="onlyActive" type="checkbox" checked> Только активные</label>
    <input id="search" type="text" placeholder="Название, код, бренд..." style="min-width:260px">
    <button class="btn" id="btnLoadApi">Загрузить</button>
    <label class="btn secondary" for="fileInput">Импорт из файла (XML/XLSX)</label>
    <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
    <button class="btn secondary" id="btnLoadDb">Загрузить из БД</button>
    <button class="btn secondary" id="btnBackup">Бэкап БД</button>
    <label class="btn secondary" for="restoreFile">Восстановить БД</label>
    <input type="file" id="restoreFile" accept=".sqlite3" style="display:none">
  </div>

  <div id="note" class="muted" style="margin:6px 0 12px"></div>

  <div style="overflow:auto; max-height:70vh; border:1px solid #e5e7eb; border-radius:10px">
    <table id="tbl">
      <thead>
        <tr>
          <th style="min-width:160px">Код</th>
          <th style="min-width:360px">Название</th>
          <th>Бренд</th>
          <th>Категория</th>
          <th>ШТ</th>
          <th>Цена, KZT</th>
          <th>Активен</th>
          <th class="col-right">Партии</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Math.round((Number(n)||0)*100)/100);

let CATEGORIES = []; // [{name, commission_percent, tax_percent, extra_percent, delivery_flat}]
async function loadCategories(){
  const r = await fetch('/products/db/categories');
  const data = await r.json();
  CATEGORIES = data.items || [];
  return CATEGORIES;
}

function findCategory(name){
  return (CATEGORIES || []).find(c => (c.name||'') === (name||''));
}

function calcMarginPerUnit(price, cost, cat, manualCommission){
  const p = Number(price||0);
  const c = Number(cost||0);
  const delivery = Number((cat && cat.delivery_flat) || 0);
  const commission = manualCommission!=null && manualCommission!=='' ? Number(manualCommission) : Number((cat && cat.commission_percent)||0);
  const tax = Number((cat && cat.tax_percent)||0);
  const extra = Number((cat && cat.extra_percent)||0);
  const totalPercent = commission + tax + extra; // суммарные проценты
  // формула «выхлоп» с заказа:
  // чистая = p - p * total% - delivery - cost
  const net = p - (p * totalPercent / 100) - delivery - c;
  return net;
}

async function loadProducts(){
  const onlyActive = document.getElementById('onlyActive')?.checked ? 1 : 0;
  const q = document.getElementById('search')?.value?.trim() || '';
  const r = await fetch(`/products/db/list?active_only=${onlyActive}&search=${encodeURIComponent(q)}`);
  const data = await r.json();
  renderTable(data.items || []);
}

function renderTable(items){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  for(const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.code||''}</td>
      <td>${it.name||''}</td>
      <td>${it.brand||''}</td>
      <td>${it.category||''}</td>
      <td>${fmt(it.qty||0)}</td>
      <td>${fmt(it.price||0)}</td>
      <td>${it.active ? '<span class="dot dot--ok"></span>' : '<span class="dot dot--off"></span>'}</td>
      <td>
        <button class="btn btn-sm btn-batches" data-sku="${it.code}" data-name="${(it.name||'').replace(/"/g,'&quot;')}" data-price="${it.price||0}">Партии</button>
      </td>
    `;
    tb.appendChild(tr);

    // место под подстроку (форма партий)
    const sub = document.createElement('tr');
    sub.className = 'batch-row';
    sub.style.display = 'none';
    sub.innerHTML = `<td colspan="8">
      <div class="batch-panel">
        <div class="row" style="align-items:center; gap:8px; margin-bottom:8px;">
          <label>Категория / комиссия</label>
          <select class="cat-select"></select>
          <button class="btn btn-sm btn-save-cat">Сохранить категорию</button>
          <span class="muted" style="margin-left:8px">Маржа/шт:&nbsp;<b class="pp-margin">—</b></span>
        </div>

        <div class="row hdr">
          <div class="col">№ партии</div>
          <div class="col">Дата</div>
          <div class="col">Кол-во</div>
          <div class="col">Закуп., KZT</div>
          <div class="col">Комиссия, % (ручная)</div>
          <div class="col flex-2">Примечание</div>
          <div class="col"></div>
        </div>
        <div class="row">
          <div class="col"><span class="new-batch-no">—</span></div>
          <div class="col"><input type="date" class="in-date"/></div>
          <div class="col"><input type="number" min="0" step="1" class="in-qty" value="1"/></div>
          <div class="col"><input type="number" min="0" step="0.01" class="in-cost" value="0"/></div>
          <div class="col"><input type="number" min="0" step="0.01" class="in-commission" placeholder=""/></div>
          <div class="col flex-2"><input type="text" class="in-note" placeholder="Комментарий"/></div>
          <div class="col"><button class="btn btn-sm btn-add">Сохранить</button></div>
        </div>

        <div class="row" style="margin:10px 0 6px;"><b>История партий</b></div>
        <table class="table small bm-table">
          <thead><tr><th>№ партии</th><th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Комиссия, %</th><th>Цена (на дату)</th><th>Прим.</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </td>`;
    tb.appendChild(sub);
  }

  // кнопки «Партии»
  tb.querySelectorAll('.btn-batches').forEach(btn => {
    btn.addEventListener('click', async () => {
      const tr = btn.closest('tr');
      const sub = tr.nextElementSibling;
      const sku = btn.dataset.sku;
      const title = btn.dataset.name || sku;
      const price = Number(btn.dataset.price || 0);
      sub.style.display = (sub.style.display==='none') ? '' : 'none';
      if(sub.style.display==='none') return;

      // заполнить селектор категорий
      const sel = sub.querySelector('.cat-select');
      sel.innerHTML = '';
      CATEGORIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = `${c.name} — ${c.commission_percent}%`;
        sel.appendChild(opt);
      });
      // выставить текущую категорию (если была)
      const textCat = tr.children[3].textContent.trim();
      if(textCat && findCategory(textCat)) sel.value = textCat;

      // слушатели для live-маржи
      const inCost = sub.querySelector('.in-cost');
      const inComm = sub.querySelector('.in-commission');
      const marginEl = sub.querySelector('.pp-margin');
      const recalc = () => {
        const cat = findCategory(sel.value);
        const m = calcMarginPerUnit(price, Number(inCost.value||0), cat, inComm.value);
        marginEl.textContent = `${fmt(m)} KZT`;
      };
      sel.onchange = recalc; inCost.oninput = recalc; inComm.oninput = recalc; recalc();

      // сохранить категорию на товаре
      sub.querySelector('.btn-save-cat').onclick = async () => {
        await fetch(`/products/db/product-category/${encodeURIComponent(sku)}`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({category: sel.value})
        });
        tr.children[3].textContent = sel.value;
      };

      // дата по умолчанию — сегодня
      sub.querySelector('.in-date').value = new Date().toISOString().slice(0,10);

      // подгрузить существующие партии
      const loadBatches = async () => {
        const r = await fetch(`/products/db/price-batches/${encodeURIComponent(sku)}`);
        const data = await r.json();
        const tbm = sub.querySelector('.bm-table tbody');
        tbm.innerHTML = '';
        for(const b of (data.batches||[])){
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${b.batch_no||'—'}</td>
            <td>${b.date||''}</td>
            <td>${fmt(b.qty||0)}</td>
            <td>${fmt(b.unit_cost||0)}</td>
            <td>${b.commission_override ?? ''}</td>
            <td>${b.price_at_batch != null ? fmt(b.price_at_batch) : ''}</td>
            <td>${b.note||''}</td>
            <td><button class="btn btn-xs btn-del" data-id="${b.id}">Удалить</button></td>
          `;
          tbm.appendChild(row);
        }
        // удаление
        tbm.querySelectorAll('.btn-del').forEach(dbtn=>{
          dbtn.onclick = async () => {
            const id = dbtn.dataset.id;
            await fetch(`/products/db/price-batches/${encodeURIComponent(sku)}/${id}`, {method:'DELETE'});
            loadBatches();
          };
        });
      };
      await loadBatches();

      // сохранить новую партию
      sub.querySelector('.btn-add').onclick = async () => {
        const payload = {
          entries: [{
            date: sub.querySelector('.in-date').value,
            qty: Number(sub.querySelector('.in-qty').value||0),
            unit_cost: Number(sub.querySelector('.in-cost').value||0),
            commission_override: sub.querySelector('.in-commission').value ? Number(sub.querySelector('.in-commission').value) : null,
            price_at_batch: price,
            note: sub.querySelector('.in-note').value || null
          }]
        };
        const r = await fetch(`/products/db/price-batches/${encodeURIComponent(sku)}`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await r.json();
        // показать № новой партии (последняя запись списка)
        const arr = data.batches || [];
        const last = arr[arr.length-1];
        if(last && last.batch_no){
          sub.querySelector('.new-batch-no').textContent = last.batch_no;
        }
        // обновить таблицу партий
        await loadBatches();
        // очистить поля
        sub.querySelector('.in-qty').value = 1;
        sub.querySelector('.in-cost').value = 0;
        sub.querySelector('.in-commission').value = '';
        sub.querySelector('.in-note').value = '';
        // пересчитать маржу
        recalc();
      };
    });
  });
}

document.addEventListener('DOMContentLoaded', async () => {
  await loadCategories();
  document.getElementById('btnLoad')?.addEventListener('click', loadProducts);
  document.getElementById('onlyActive')?.addEventListener('change', loadProducts);
  document.getElementById('search')?.addEventListener('keyup', e => { if(e.key==='Enter') loadProducts(); });
  // импорт/экспорт/бэкап у вас уже подключены — оставляю без изменений
  loadProducts();
});
</script>

<style>
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;}
.dot--ok{background:#2ecc71;} .dot--off{background:#e0e0e0;}
.batch-panel{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;}
.batch-panel .row{display:flex; gap:8px; align-items:center;}
.batch-panel .row.hdr{font-weight:600; color:#666;}
.batch-panel .col{min-width:120px}
.batch-panel .col.flex-2{flex:2}
.table.small td,.table.small th{font-size:12px;padding:6px 8px;}
.btn-xs{font-size:12px;padding:2px 6px;}
</style>

</body>
</html>
