<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <style>
    body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:1400px;margin:20px auto;padding:0 12px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#1f7aee;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.secondary{background:#e9eef6;color:#1f2a37}
    input[type="text"],input[type="number"],select{height:34px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px}
    .muted{color:#6b7280}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:middle}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#9ca3af}
    .dot.on{background:#10b981}
    .detail{background:#f8fafc}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .btn-link{background:transparent;color:#2563eb;border:0;cursor:pointer;padding:0}
    .col-right{text-align:right}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Мой склад</h1>

  <div class="row" style="margin-bottom:10px">
    <label><input id="onlyActive" type="checkbox" checked> Только активные</label>
    <input id="search" type="text" placeholder="Название, код, бренд..." style="min-width:260px">
    <button class="btn" id="btnLoadApi">Загрузить</button>
    <label class="btn secondary" for="fileInput">Импорт из файла (XML/XLSX)</label>
    <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
    <button class="btn secondary" id="btnLoadDb">Загрузить из БД</button>
    <button class="btn secondary" id="btnBackup">Бэкап БД</button>
    <label class="btn secondary" for="restoreFile">Восстановить БД</label>
    <input type="file" id="restoreFile" accept=".sqlite3" style="display:none">
  </div>

  <div id="note" class="muted" style="margin:6px 0 12px"></div>

  <div style="overflow:auto; max-height:70vh; border:1px solid #e5e7eb; border-radius:10px">
    <table id="tbl">
      <thead>
        <tr>
          <th style="min-width:160px">Код</th>
          <th style="min-width:360px">Название</th>
          <th>Бренд</th>
          <th>Категория</th>
          <th>ШТ</th>
          <th>Цена, KZT</th>
          <th>Активен</th>
          <th class="col-right">Партии</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Number(n||0));

let CATEGORIES = [];

async function fetchJSON(url, opts){
  const r = await fetch(url, opts||{});
  if(!r.ok) throw new Error((await r.text())||r.statusText);
  return r.json();
}

function skuFromRow(tr){
  let sku = tr?.dataset?.sku;
  if(!sku){
    const text = tr?.cells?.[0]?.textContent?.trim();
    if(text) sku = text;
  }
  return sku;
}

function clearDetails(){
  qsa('tr.detail').forEach(tr => tr.remove());
}

function makeDetailRow(colspan){
  const tr = document.createElement('tr');
  tr.className = 'detail';
  const td = document.createElement('td');
  td.colSpan = colspan;
  tr.appendChild(td);
  return tr;
}

function renderProducts(items){
  const tb = qs('#tbl tbody');
  tb.innerHTML = '';
  items.forEach(it=>{
    const tr = document.createElement('tr');
    const sku = it.code || it.id || '';
    tr.dataset.sku = sku;
    tr.className = 'data-row';
    const on = it.qty>0 || it.active===true;
    tr.innerHTML = `
      <td>${sku}</td>
      <td>${it.name||''}</td>
      <td>${it.brand||''}</td>
      <td>${it.category||''}${it.commission_total!=null?` <span class="pill">${it.commission_total}%</span>`:''}</td>
      <td>${fmt(it.qty||0)}</td>
      <td>${fmt(it.price||0)}</td>
      <td><span class="dot ${on?'on':''}"></span></td>
      <td class="col-right"><button class="btn-link btn-parties">Партии</button></td>
    `;
    tb.appendChild(tr);
  });
}

async function loadAPI(){
  const p = new URLSearchParams();
  p.set('active', qs('#onlyActive').checked ? '1' : '0');
  const q = qs('#search').value.trim();
  if(q) p.set('q', q);
  p.set('page','1'); p.set('page_size','2000');
  const data = await fetchJSON(`/products/list?${p.toString()}`);
  if(data.note) qs('#note').textContent = data.note;
  renderProducts(data.items||[]);
}

async function loadDB(){
  const p = new URLSearchParams();
  p.set('active_only', qs('#onlyActive').checked ? '1' : '0');
  p.set('search', qs('#search').value.trim());
  const data = await fetchJSON(`/products/db/list?${p.toString()}`);
  renderProducts(data.items||[]);
}

async function importFile(file){
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch(`/products/manual-upload`, {method:'POST', body:fd});
  if(!res.ok){ const t = await res.text(); throw new Error(t||res.statusText); }
  const data = await res.json();
  qs('#note').textContent = `Файл загружен: ${file.name}. Позиции: ${data.count||0}`;
  renderProducts(data.items||[]);
}

async function openDetail(row){
  clearDetails();
  const sku = skuFromRow(row);
  if(!sku) { alert('У товара нет кода/sku — некуда сохранить партии.'); return; }

  // загрузим категории (для селектора)
  if(!CATEGORIES.length){
    const c = await fetchJSON('/products/db/categories');
    CATEGORIES = c.categories || [];
  }

  // вставляем строку ниже
  const tr = makeDetailRow(row.children.length);
  row.insertAdjacentElement('afterend', tr);
  const mount = tr.firstChild;

  // базовая разметка
  mount.innerHTML = `
    <div style="padding:12px">
      <div class="row" style="align-items:flex-end; gap:12px; margin-bottom:8px">
        <div>
          <div class="muted" style="margin-bottom:4px">Категория / комиссия</div>
          <div class="row" style="gap:6px">
            <select id="catSel"></select>
            <button class="btn secondary" id="btnSaveCat">Сохранить категорию</button>
          </div>
        </div>
      </div>

      <div style="margin:8px 0 6px; font-weight:600">Партии закупок — <span id="dTitle">${row.cells[1].textContent}</span></div>
      <table class="table" style="width:100%">
        <thead><tr><th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Примечание</th><th></th></tr></thead>
        <tbody id="btBody"></tbody>
      </table>
      <div class="row" style="margin-top:8px; gap:8px">
        <button class="btn secondary" id="btnAddRow">+ Добавить</button>
        <button class="btn" id="btnSaveRows">Сохранить</button>
      </div>
    </div>
  `;

  // заполнить селектор категорий
  const sel = qs('#catSel', mount);
  sel.innerHTML = CATEGORIES.map(c=>{
    const total = (Number(c.base_percent||0)+Number(c.extra_percent||0)+Number(c.tax_percent||0)).toFixed(2);
    return `<option value="${c.name}">${c.name} — ${total}%</option>`;
  }).join('');
  // установить текущую категорию из таблицы
  const currentCat = row.cells[3].childNodes[0]?.nodeValue?.trim() || '';
  if(currentCat) sel.value = currentCat;

  qs('#btnSaveCat', mount).onclick = async ()=>{
    const cat = sel.value || '';
    await fetchJSON(`/products/db/product-category/${encodeURIComponent(sku)}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({category: cat})
    });
    // перерисуем строку категории + плашку %
    const match = CATEGORIES.find(x=>x.name===cat);
    const total = match ? (Number(match.base_percent||0)+Number(match.extra_percent||0)+Number(match.tax_percent||0)).toFixed(2) : null;
    row.cells[3].innerHTML = cat + (total?` <span class="pill">${total}%</span>`:'');
  };

  const tbody = qs('#btBody', mount);

  function addRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="date" value="${data?.date || new Date().toISOString().slice(0,10)}"></td>
      <td><input type="number" min="0" step="1" value="${data?.qty ?? ''}" style="width:90px"></td>
      <td><input type="number" min="0" step="0.01" value="${data?.unit_cost ?? ''}" style="width:110px"></td>
      <td><input type="text" value="${data?.note ?? ''}"></td>
      <td>${data?.id ? `<button class="btn-link btnDel" data-id="${data.id}">Удалить</button>`:''}</td>
    `;
    tbody.appendChild(tr);
  }

  // текущие партии
  const data = await fetchJSON(`/products/db/price-batches/${encodeURIComponent(sku)}`);
  (data.batches||[]).forEach(addRow);

  qs('#btnAddRow', mount).onclick = ()=> addRow({});
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btnDel');
    if(!btn) return;
    await fetchJSON(`/products/db/price-batches/${encodeURIComponent(sku)}/${btn.dataset.id}`, {method:'DELETE'});
    btn.closest('tr').remove();
  });

  qs('#btnSaveRows', mount).onclick = async ()=>{
    const entries = qsa('tr', tbody).map(tr=>{
      const [d,q,c,n] = qsa('input', tr);
      return {date:d.value, qty:Number(q.value||0), unit_cost:Number(c.value||0), note:n.value||null};
    }).filter(e => e.qty>0 && e.unit_cost>0);
    if(!entries.length){ alert('Добавьте хотя бы одну строку партии.'); return; }
    await fetchJSON(`/products/db/price-batches/${encodeURIComponent(sku)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({entries})
    });
    alert('Сохранено.');
    // перезагрузим детали, чтобы появились кнопки "Удалить"
    openDetail(row);
  };
}

// ---------- events ----------
document.addEventListener('DOMContentLoaded', ()=>{
  qs('#btnLoadApi').onclick = loadAPI;
  qs('#btnLoadDb').onclick = loadDB;

  qs('#fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{ await importFile(f); } catch(err){ alert(err.message||err); }
    e.target.value = '';
  });

  qs('#restoreFile').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const fd = new FormData(); fd.append('file', f);
    try{
      await fetchJSON('/products/db/restore', {method:'POST', body:fd});
      alert('БД восстановлена.'); loadDB();
    }catch(err){ alert(err.message||err); }
    e.target.value = '';
  });

  qs('#btnBackup').onclick = ()=> { window.location = '/products/db/backup.sqlite3'; };

  qs('#tbl').addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-parties');
    if(!btn) return;
    const row = btn.closest('tr');
    openDetail(row);
  });

  // стартовый экран — подгружаем из БД
  loadDB();
});
</script>
</body>
</html>
