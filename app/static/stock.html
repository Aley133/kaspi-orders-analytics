<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --card:#f8fafc;
      --line:#e5e7eb; --pri:#1f7aee; --pri-weak:#e9eef6; --pill-bg:#eef2ff; --pill-fg:#3730a3;
    }
    body[data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --card:#0f1829;
      --line:#1f2a37; --pri:#3b82f6; --pri-weak:#132036; --pill-bg:#1e293b; --pill-fg:#bfdbfe;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;transition:background .2s,color .2s}
    a{color:inherit;text-decoration:none}

    .layout{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
    .sidebar{border-right:1px solid var(--line);padding:16px 12px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;font-size:18px;margin:4px 0 12px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
    .nav a{padding:8px 10px;border-radius:10px;color:var(--fg);opacity:.9;transition:background .15s,opacity .15s}
    .nav a:hover{background:var(--card);opacity:1}
    .switch{display:flex;gap:8px;align-items:center;margin-top:auto;padding-top:12px;border-top:1px solid var(--line)}
    .switch input{width:40px;height:22px;appearance:none;background:var(--line);border-radius:999px;position:relative;cursor:pointer;outline:none;transition:background .2s}
    .switch input:checked{background:var(--pri)}
    .switch input::after{content:"";position:absolute;inset:3px auto auto 3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s}
    .switch input:checked::after{left:21px}

    .content{padding:20px 16px}
    h1{margin:0 0 12px}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;transition:transform .04s ease, filter .15s}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:var(--pri-weak);color:var(--fg)}
    .btn-link{background:transparent;border:0;color:var(--pri);cursor:pointer;padding:0}
    input[type="text"],input[type="number"],select{height:34px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--fg)}
    input[type="date"]{height:34px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--fg)}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    thead th{position:sticky;top:0;background:var(--card);z-index:1}
    .muted{color:var(--muted)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#9ca3af;position:relative}
    .dot.on{background:#10b981}
    .dot.on::after{content:"";position:absolute;inset:-5px;border-radius:50%;border:2px solid rgba(16,185,129,.4);animation:pulse 1.8s ease-out infinite;}
    @keyframes pulse{0%{transform:scale(.6);opacity:1}70%{transform:scale(1.4);opacity:0}100%{opacity:0}}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill-bg);color:var(--pill-fg);font-size:12px}
    .col-right{text-align:right}
    .detail{background:var(--card)}
    .block{padding:12px}
    .shell{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a href="#" style="background:var(--card)">Мой склад</a>
        <a href="#">Предзаказ</a>
        <a href="#">Демпинг</a>
        <a href="#">WhatsApp-рассылка</a>
      </nav>
      <div class="switch">
        <input id="themeToggle" type="checkbox" />
        <label for="themeToggle">Тёмная тема</label>
      </div>
    </aside>

    <main class="content">
      <h1>Мой склад</h1>

      <div class="row" style="margin-bottom:10px">
        <label><input id="onlyActive" type="checkbox" checked> Только активные</label>
        <input id="search" type="text" placeholder="Название, код, бренд..." style="min-width:260px">
        <button class="btn" id="btnLoadApi">Загрузить</button>
        <label class="btn secondary" for="fileInput">Импорт из файла (XML/XLSX)</label>
        <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
        <button class="btn secondary" id="btnSaveDb">Сохранить таблицу в БД</button>
        <button class="btn secondary" id="btnExportDb">Экспорт CSV (БД)</button>
        <button class="btn secondary" id="btnLoadDb">Загрузить из БД</button>
        <button class="btn secondary" id="btnBackup">Бэкап БД</button>
        <label class="btn secondary" for="restoreFile">Восстановить БД</label>
        <input type="file" id="restoreFile" accept=".sqlite3" style="display:none">
      </div>

      <div id="note" class="muted" style="margin:6px 0 12px"></div>

      <div class="shell">
        <div style="overflow:auto; max-height:70vh">
          <table id="tbl">
            <thead>
              <tr>
                <th style="min-width:160px">Код</th>
                <th style="min-width:360px">Название</th>
                <th>Бренд</th>
                <th>Категория</th>
                <th>ШТ</th>
                <th>Цена, KZT</th>
                <th>Активен</th>
                <th>Кол-во партий</th>
                <th>Маржа (посл.), KZT</th>
                <th class="col-right">Партии</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

<script type="module">
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Number(n||0));

(function initTheme(){
  const saved = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', saved);
  qs('#themeToggle').checked = saved === 'dark';
  qs('#themeToggle').addEventListener('change', e=>{
    const t = e.target.checked ? 'dark' : 'light';
    document.body.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  });
})();

async function fetchJSON(url, opts){
  const r = await fetch(url, opts||{});
  if(!r.ok) throw new Error((await r.text())||r.statusText);
  return r.json();
}

function parsePriceCell(cell){ return Number((cell?.textContent||'0').toString().replace(/\s/g,'')); }

function renderProducts(items){
  const tb = qs('#tbl tbody');
  tb.innerHTML = '';
  items.forEach(it=>{
    const tr = document.createElement('tr');
    const sku = it.code || it.id || '';
    tr.dataset.sku = sku;
    tr.className = 'data-row';
    const on = (it.qty||0)>0 || it.active===true;
    tr.innerHTML = `
      <td>${sku}</td>
      <td>${it.name||''}</td>
      <td>${it.brand||''}</td>
      <td>${it.category||''}</td>
      <td>${fmt(it.qty||0)}</td>
      <td>${fmt(it.price||0)}</td>
      <td><span class="dot ${on?'on':''}"></span></td>
      <td>${fmt(it.batch_count||0)}</td>
      <td>${it.last_margin!=null ? fmt(it.last_margin) : '—'}</td>
      <td class="col-right"><button class="btn-link btn-parties">Партии</button></td>
    `;
    tb.appendChild(tr);
  });
}

async function loadAPI(){
  try{
    const p = new URLSearchParams();
    p.set('active', qs('#onlyActive').checked ? '1' : '0');
    const q = qs('#search').value.trim();
    if(q) p.set('q', q);
    p.set('page','1'); p.set('page_size','2000');
    const data = await fetchJSON('/products/list?'+p.toString());
    if(data.note) qs('#note').textContent = data.note;
    renderProducts(data.items||[]);
  }catch(e){
    qs('#note').textContent = 'Ошибка загрузки из API: '+(e.message||e);
    console.error(e);
  }
}

async function loadDB(){
  try{
    const p = new URLSearchParams();
    p.set('active_only', qs('#onlyActive').checked ? '1' : '0');
    const q = qs('#search').value.trim(); if(q) p.set('search', q);
    const data = await fetchJSON('/products/db/list?'+p.toString());
    renderProducts(data.items||[]);
    // доб. диагностику
    const h = await fetchJSON('/products/db/health');
    qs('#note').textContent = `Загружено из БД: ${data.count}. База: ${h.db_path} (${fmt(h.size)} байт). Товаров: ${h.products}, партий: ${h.batches}.`;
  }catch(e){
    qs('#note').textContent = 'Ошибка загрузки из БД: '+(e.message||e);
    console.error(e);
  }
}

async function importFile(file){
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/products/manual-upload', {method:'POST', body:fd});
  if(!res.ok){ const t = await res.text(); throw new Error(t||res.statusText); }
  const data = await res.json();
  qs('#note').textContent = `Файл загружен: ${file.name}. Позиции: ${data.count||0}`;
  renderProducts(data.items||[]);
}

function clearDetails(){ qsa('tr.detail').forEach(tr => tr.remove()); }
function makeDetailRow(colspan){
  const tr = document.createElement('tr');
  tr.className = 'detail';
  const td = document.createElement('td');
  td.colSpan = colspan;
  tr.appendChild(td);
  return tr;
}

async function openDetail(row){
  clearDetails();
  const sku = row?.dataset?.sku || row.cells?.[0]?.textContent?.trim();
  if(!sku) { alert('У товара нет кода/sku — некуда сохранить партии.'); return; }

  const tr = makeDetailRow(row.children.length);
  row.insertAdjacentElement('afterend', tr);
  const mount = tr.firstChild;

  mount.innerHTML = `
    <div class="block">
      <div style="margin:8px 0 6px; font-weight:600">Партии закупок — <span id="dTitle">${row.cells[1].textContent}</span></div>
      <table style="width:100%" id="btTable">
        <thead>
          <tr>
            <th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Комиссия, %</th><th>Маржа / шт</th><th>Код</th><th>Прим.</th><th></th>
          </tr>
        </thead>
        <tbody id="btBody"></tbody>
      </table>
      <div class="row" style="margin-top:8px; gap:8px">
        <button class="btn secondary" id="btnAddRow">+ Добавить</button>
        <button class="btn" id="btnSaveRows">Сохранить</button>
      </div>
    </div>
  `;

  const tbody = qs('#btBody', mount);
  const priceKZT = parsePriceCell(row.cells[5]);

  function recalc(tr){
    const [dEl, qEl, cEl, commEl] = qsa('input', tr);
    const uc = Number(cEl.value||0);
    const comm = Number(commEl.value||0);
    const net = priceKZT - (priceKZT * comm/100) - uc;
    tr.querySelector('.net').textContent = isFinite(net) ? fmt(net) : '—';
  }

  function addRow(data){
    const tr = document.createElement('tr');
    const delBtnHtml = data?.id
      ? ('<button class="btn-link btnDel" data-id="'+String(data.id)+'">Удалить</button>')
      : '';
    tr.innerHTML = `
      <td><input type="date" value="${data?.date || new Date().toISOString().slice(0,10)}"></td>
      <td><input type="number" min="0" step="1" value="${data?.qty ?? ''}" style="width:90px"></td>
      <td><input type="number" min="0" step="0.01" value="${data?.unit_cost ?? ''}" style="width:110px"></td>
      <td><input type="number" min="0" step="0.01" value="${data?.commission_pct ?? ''}" style="width:100px"></td>
      <td class="net">—</td>
      <td class="code">${data?.batch_code || '<span class="muted">— генерируется</span>'}</td>
      <td><input type="text" value="${data?.note ?? ''}"></td>
      <td>${delBtnHtml}</td>
    `;
    tbody.appendChild(tr);
    recalc(tr);
  }

  // текущие партии
  const data = await fetchJSON('/products/db/price-batches/'+encodeURIComponent(sku));
  (data.batches||[]).forEach(addRow);

  qs('#btnAddRow', mount).onclick = ()=> addRow({});

  tbody.addEventListener('input', e=>{
    const tr = e.target.closest('tr');
