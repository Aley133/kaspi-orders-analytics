<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Мой склад — Kaspi</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="toolbar">
    <label class="chk"><input id="onlyActive" type="checkbox" checked> Только активные</label>
    <input id="search" class="inp" placeholder="Название, код, бренд..."/>
    <button id="btnLoad" class="btn"><span class="btn__label">Загрузить</span><span class="btn__spin"></span></button>
    <label class="btn btn--ghost" for="fileInput">Импорт из файла (XML/XLSX)</label>
    <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
    <button id="btnLoadDB" class="btn btn--ghost">Загрузить из БД</button>
    <button id="btnBackupDB" class="btn btn--ghost">Бэкап БД</button>
    <label class="btn btn--ghost" for="restoreInput">Восстановить БД</label>
    <input type="file" id="restoreInput" accept=".sqlite3,.db,.sqlite,application/octet-stream" style="display:none">
  </div>

  <div id="note" class="note"></div>

  <div class="table-wrap">
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Код</th>
          <th>Название</th>
          <th>Бренд</th>
          <th>Категория</th>
          <th class="num">ШТ</th>
          <th class="num">Цена, KZT</th>
          <th class="num">Активен</th>
          <th class="num">Партии</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- шаблон разворота под строкой -->
  <template id="rowExpandTpl">
    <tr class="row-expand">
      <td colspan="8">
        <div class="expand">
          <div class="expand__header">
            <div class="expand__title"></div>
            <div class="expand__cat">
              <select class="select select-cat"></select>
              <button class="btn btn--sm btnSaveCat">Сохранить категорию</button>
            </div>
          </div>

          <div class="expand__form">
            <div class="grid">
              <label>Дата
                <input type="date" class="inp inp-date"/>
              </label>
              <label>Кол-во
                <input type="number" min="1" step="1" class="inp inp-qty" value="1"/>
              </label>
              <label>Закуп., KZT
                <input type="number" min="0" step="1" class="inp inp-cost" value="0"/>
              </label>
              <label>Примечание
                <input type="text" class="inp inp-note" placeholder="Например: поставка от ..."/>
              </label>
            </div>
            <div class="expand__summary">
              <div class="summary__price">Цена товара: <b class="sPrice">0</b> KZT</div>
              <div class="summary__margin">Маржа за 1 заказ: <b class="sMargin">0</b> KZT (<span class="sMarginPct">0</span>%)</div>
            </div>
            <div class="expand__actions">
              <button class="btn btn--sm btnAddBatch">+ Добавить партию</button>
            </div>
            <div class="expand__batches">
              <table class="table table--compact">
                <thead><tr><th>№ партии</th><th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Прим.</th><th></th></tr></thead>
                <tbody class="batchesBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </template>

<script>
const nf = new Intl.NumberFormat('ru-RU');
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];

let CATEGORIES = []; // {code,title,commission_percent,extra_percent,delivery_kzt}

function spin(btn, on) {
  const label = btn.querySelector('.btn__label');
  const sp = btn.querySelector('.btn__spin');
  if (on) {
    btn.classList.add('btn--spin');
    if (label) label.textContent = 'Загрузка...';
  } else {
    btn.classList.remove('btn--spin');
    if (label) label.textContent = 'Загрузить';
  }
}

async function api(url, opts={}) {
  const res = await fetch(url, opts);
  if (!res.ok) {
    let msg = 'HTTP '+res.status;
    try { const d = await res.json(); if (d.detail) msg = d.detail; } catch(e){}
    throw new Error(msg);
  }
  try { return await res.json(); } catch { return {}; }
}

function activeDot(qty) {
  const span = document.createElement('span');
  span.className = 'dot ' + (Number(qty)>0 ? 'dot--ok' : 'dot--off');
  return span;
}

function trButton(label) {
  const b = document.createElement('button');
  b.className = 'btn btn--pill btn--sm';
  b.textContent = label;
  return b;
}

function setNote(text) {
  qs('#note').textContent = text || '';
}

// -------- загрузки ----------
async function loadCategories() {
  const d = await api('/products/categories');
  CATEGORIES = d.items || [];
}

// сохраняем категорию к товару
async function saveProductCategory(sku, code) {
  await api(`/products/db/product-category/${encodeURIComponent(sku)}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({category: code})
  });
}

// синхронизируем из Kaspi в БД
async function syncFromApi() {
  const btn = qs('#btnLoad');
  spin(btn, true);
  try {
    const onlyActive = qs('#onlyActive')?.checked ? 1 : 0;
    const r = await api('/products/db/sync?active='+onlyActive, {method:'POST'});
    setNote(`Сохранено в БД: ${r.saved}. ${r.note || ''}`);
    await loadFromDB();
  } catch(e) {
    alert('Ошибка синхронизации: '+e.message);
  } finally {
    spin(btn, false);
  }
}

// читаем из БД и показываем
async function loadFromDB() {
  const onlyActive = qs('#onlyActive')?.checked ? 1 : 0;
  const q = qs('#search')?.value?.trim() || '';
  const d = await api(`/products/db/list?active_only=${onlyActive}&search=${encodeURIComponent(q)}`);
  renderTable(d.items || []);
}

function renderTable(items) {
  const tb = qs('#tbl tbody');
  tb.innerHTML = '';
  for (const it of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.code||''}</td>
      <td class="name">${it.name||''}</td>
      <td>${it.brand||''}</td>
      <td>${renderCategoryCell(it.category)}</td>
      <td class="num">${nf.format(it.quantity||0)}</td>
      <td class="num">${nf.format(it.price||0)}</td>
      <td class="num"></td>
      <td class="num"></td>
    `;
    tr.cells[6].appendChild(activeDot(it.quantity||0));
    const btn = trButton('Партии');
    tr.cells[7].appendChild(btn);
    btn.addEventListener('click', () => toggleExpand(tr, it));
    tb.appendChild(tr);
  }
}

function renderCategoryCell(code) {
  if (!code) return '';
  const cat = CATEGORIES.find(c => c.code===code) || {title: code, commission_percent: undefined};
  if (cat.commission_percent != null) {
    return `<span class="tag">${cat.title} <span class="tag__pct">${cat.commission_percent}%</span></span>`;
  }
  return cat.title;
}

function toggleExpand(tr, product) {
  // уже раскрыта?
  const next = tr.nextElementSibling;
  if (next && next.classList.contains('row-expand')) {
    next.remove();
    return;
  }
  // закрыть другие
  qsa('.row-expand').forEach(e=>e.remove());

  const tpl = qs('#rowExpandTpl').content.cloneNode(true);
  const row = tpl.querySelector('tr');
  const block = tpl.querySelector('.expand');
  tpl.querySelector('.expand__title').textContent = `${product.name} — ${product.code}`;
  const sel = tpl.querySelector('.select-cat');
  sel.innerHTML = CATEGORIES.map(c => `<option value="${c.code}" ${product.category===c.code?'selected':''}>
      ${c.title} — ${c.commission_percent.toFixed(2)}%
    </option>`).join('');
  const sPrice = tpl.querySelector('.sPrice');
  sPrice.textContent = nf.format(product.price||0);

  const inpDate = tpl.querySelector('.inp-date');
  const today = new Date().toISOString().slice(0,10);
  inpDate.value = today;

  const inpQty = tpl.querySelector('.inp-qty');
  const inpCost = tpl.querySelector('.inp-cost');
  const sMargin = tpl.querySelector('.sMargin');
  const sMarginPct = tpl.querySelector('.sMarginPct');

  function recomputeMargin() {
    const cat = CATEGORIES.find(c => c.code===sel.value);
    const price = Number(product.price)||0;
    const cost = Number(inpCost.value)||0;
    let commission = 0, extra = 0, delivery = 0;
    if (cat) {
      commission = price * (Number(cat.commission_percent)||0) / 100.0;
      extra      = price * (Number(cat.extra_percent)||0) / 100.0;
      delivery   = Number(cat.delivery_kzt)||0;
    }
    const margin = price - cost - commission - extra - delivery;
    const pct = price ? (margin/price*100.0) : 0;
    sMargin.textContent = nf.format(Math.round(margin));
    sMarginPct.textContent = pct.toFixed(2);
  }
  inpCost.addEventListener('input', recomputeMargin);
  sel.addEventListener('change', recomputeMargin);
  recomputeMargin();

  // Сохранить категорию
  tpl.querySelector('.btnSaveCat').addEventListener('click', async () => {
    try {
      await saveProductCategory(product.code, sel.value);
      product.category = sel.value;
      // перерисовать строку
      tr.cells[3].innerHTML = renderCategoryCell(sel.value);
    } catch(e) { alert('Ошибка: '+e.message); }
  });

  // Добавить партию
  tpl.querySelector('.btnAddBatch').addEventListener('click', async () => {
    const payload = {
      entries: [{
        date: inpDate.value || today,
        qty: Number(inpQty.value||0),
        unit_cost: Number(inpCost.value||0),
        note: (tpl.querySelector('.inp-note').value||'').trim() || null
      }]
    };
    if (!product.code) { alert('У товара нет кода/sku — некуда сохранить партию.'); return; }
    if (!(payload.entries[0].qty>0) || !(payload.entries[0].unit_cost>0)) {
      alert('Укажите количество и закупочную цену'); return;
    }
    await api(`/products/db/price-batches/${encodeURIComponent(product.code)}`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    await fillBatches(product.code, tpl.querySelector('.batchesBody'));
  });

  // список партий
  fillBatches(product.code, tpl.querySelector('.batchesBody'));

  tr.after(row);
  // плавное появление
  setTimeout(() => block.classList.add('expand--in'), 0);
}

async function fillBatches(sku, tbody) {
  tbody.innerHTML = '<tr><td colspan="6">Загрузка…</td></tr>';
  try {
    const d = await api(`/products/db/price-batches/${encodeURIComponent(sku)}`);
    tbody.innerHTML = '';
    (d.batches || []).forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.batch_no}</td>
        <td>${b.date}</td>
        <td>${nf.format(b.qty||0)}</td>
        <td>${nf.format(b.unit_cost||0)}</td>
        <td>${b.note||''}</td>
        <td class="num"><button class="btn btn--xs btn--ghost">Удалить</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async () => {
        await api(`/products/db/price-batches/${encodeURIComponent(sku)}/${b.id}`, {method:'DELETE'});
        tr.remove();
      });
      tbody.appendChild(tr);
    });
    if (!tbody.children.length) {
      tbody.innerHTML = '<tr><td colspan="6">Партии пока не добавлены.</td></tr>';
    }
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6">Ошибка: ${e.message}</td></tr>`;
  }
}

// ---------- события ----------
document.addEventListener('DOMContentLoaded', async () => {
  await loadCategories();
  await loadFromDB();

  qs('#btnLoad').addEventListener('click', syncFromApi);
  qs('#btnLoadDB').addEventListener('click', loadFromDB);

  qs('#onlyActive').addEventListener('change', loadFromDB);
  qs('#search').addEventListener('keyup', e => { if (e.key==='Enter') loadFromDB(); });

  // импорт XML/XLSX
  const fi = qs('#fileInput');
  fi.addEventListener('change', async () => {
    if (!fi.files || !fi.files[0]) return;
    const fd = new FormData(); fd.append('file', fi.files[0]);
    try {
      const d = await api('/products/manual-upload', {method:'POST', body:fd});
      setNote(`Файл загружен: ${fi.files[0].name}. Позиции: ${d.count||0}`);
      await loadFromDB();
    } catch(e){ alert('Ошибка: '+e.message); }
    fi.value='';
  });

  // бэкап
  qs('#btnBackupDB').addEventListener('click', async () => {
    try {
      const url = '/products/db/backup.sqlite3';
      const a = document.createElement('a');
      a.href = url; a.download = 'kaspi-db-backup.sqlite3';
      document.body.appendChild(a); a.click(); a.remove();
    } catch(e){ alert('Ошибка: '+e.message); }
  });

  // восстановление
  const rIn = qs('#restoreInput');
  rIn.addEventListener('change', async () => {
    if (!rIn.files || !rIn.files[0]) return;
    if (!confirm('Заменить текущую БД на выбранный файл?')) { rIn.value=''; return; }
    const fd = new FormData(); fd.append('file', rIn.files[0]);
    try {
      await api('/products/db/restore', {method:'POST', body:fd});
      await loadCategories();
      await loadFromDB();
      alert('База восстановлена.');
    } catch(e){ alert('Ошибка: '+e.message); }
    rIn.value='';
  });
});
</script>
</body>
</html>
