<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Мой склад — загрузка прайса</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/ui/style.css">
  <style>
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { cursor:pointer; padding:8px 12px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    .btn:hover { background:#f5f5f5; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align:right; }
    .status { font-size: 12px; color:#666; }
    .input-price { width:120px; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
    .pill { font-size:12px; padding:2px 6px; border-radius:999px; background:#f0f0f0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Мой склад</h1>

    <div class="toolbar">
      <label class="btn">
        Загрузить Excel/XML
        <input id="fileInput" type="file" accept=".xlsx,.xls,.xml" style="display:none">
      </label>
      <span class="status" id="status"></span>
    </div>

    <div id="tableWrap">
      <table id="stocks">
        <thead>
          <tr>
            <th>Артикул</th>
            <th>Наименование</th>
            <th class="right">Цена продажи</th>
            <th class="right">Закупка</th>
            <th class="right">Чистый доход</th>
            <th>Валюта</th>
            <th>Штрихкод</th>
          </tr>
        </thead>
        <tbody id="stocksBody"></tbody>
      </table>
    </div>
  </div>

<script>
const $$ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => n === null || n === undefined || isNaN(n) ? "" : (+n).toFixed(2);

function setStatus(text) { $$('#status').textContent = text || ''; }

async function fetchList() {
  const res = await fetch('/products/list');
  const data = await res.json();
  renderTable(data.items || []);
  setStatus(`Всего позиций: ${data.total}`);
}

function renderTable(items) {
  const tbody = $$('#stocksBody');
  tbody.innerHTML = '';
  for (const it of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${it.sku || ''}</td>
      <td>${it.name || ''}</td>
      <td class="right">${fmt(it.price)}</td>
      <td class="right">
        <input class="input-price" type="number" step="0.01" inputmode="decimal"
               value="${it.purchase_price ?? ''}" data-sku="${it.sku || ''}">
      </td>
      <td class="right"><span class="pill">${fmt(it.net)}</span></td>
      <td>${it.currency || ''}</td>
      <td class="mono">${it.barcode || ''}</td>
    `;
    tbody.appendChild(tr);
  }
  bindEditors();
}

let debounceTimer = null;
function bindEditors() {
  $all('input.input-price').forEach(inp => {
    inp.addEventListener('input', () => {
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(pushUpdates, 400);
      // update net in-place
      const tr = inp.closest('tr');
      const price = parseFloat(tr.children[2].textContent.replace(',', '.')) || 0;
      const pp = parseFloat(inp.value.replace(',', '.'));
      const net = (isNaN(pp) ? '' : (price - pp).toFixed(2));
      tr.children[4].firstElementChild.textContent = net;
    });
  });
}

async function pushUpdates() {
  const updates = $all('input.input-price').map(inp => ({
    sku: inp.getAttribute('data-sku'),
    purchase_price: inp.value === '' ? null : parseFloat(inp.value.replace(',', '.'))
  })).filter(u => u.sku);
  if (!updates.length) return;
  setStatus('Сохраняем...');
  const res = await fetch('/products/purchase-price', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ updates })
  });
  if (!res.ok) {
    setStatus('Ошибка сохранения');
    return;
  }
  const data = await res.json();
  setStatus(`Сохранено: ${data.changed}`);
}

async function importFile(file) {
  const form = new FormData();
  form.append('file', file);
  setStatus('Импортируем...');
  const res = await fetch('/products/import', { method: 'POST', body: form });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    setStatus('Ошибка: ' + (err.detail || res.statusText));
    return;
  }
  const data = await res.json();
  renderTable(data.items || []);
  setStatus(`Импортировано: ${data.count}`);
}

$('#fileInput').addEventListener('change', async (e) => {
  const f = e.target.files && e.target.files[0];
  if (f) await importFile(f);
  e.target.value = '';
});

// init
fetchList();
</script>
</body>
</html>
