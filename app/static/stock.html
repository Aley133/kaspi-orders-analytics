<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --card:#f8fafc; --line:#e5e7eb;
      --pri:#1f7aee; --pri-weak:#e9eef6; --pill-bg:#eef2ff; --pill-fg:#3730a3;
      --ok-bg:#ecfdf5; --ok-fg:#065f46; --ok-border:#a7f3d0;
      --err-bg:#fef2f2; --err-fg:#991b1b; --err-border:#fecaca;
      --chip:#e2e8f0; --warn:#f59e0b; --danger:#ef4444; --success:#10b981;
      --focus:#94a3b8;
    }
    body[data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --card:#0f1829; --line:#1f2a37;
      --pri:#3b82f6; --pri-weak:#132036; --pill-bg:#1e293b; --pill-fg:#bfdbfe;
      --ok-bg:#112a1f; --ok-fg:#a7f3d0; --ok-border:#134e4a;
      --err-bg:#3b0d0d; --err-fg:#fecaca; --err-border:#7f1d1d;
      --chip:#0f172a; --warn:#f59e0b; --danger:#ef4444; --success:#10b981;
      --focus:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    /* layout */
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
    .sidebar{border-right:1px solid var(--line);padding:16px 12px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;font-size:18px;margin:4px 0 12px}
    .nav{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
    .nav a{padding:8px 10px;border-radius:10px;color:var(--fg);opacity:.9;text-decoration:none}
    .nav a:hover{background:var(--card);opacity:1}
    .switch{display:flex;gap:8px;align-items:center;margin-top:auto;padding-top:12px;border-top:1px solid var(--line)}
    .switch input{width:40px;height:22px;appearance:none;background:var(--line);border-radius:999px;position:relative}
    .switch input:checked{background:var(--pri)}
    .switch input::after{content:"";position:absolute;inset:3px auto auto 3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s}
    .switch input:checked::after{left:21px}
    .content{padding:20px 16px}

    /* ui bits */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      background:var(--pri);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease, background-color .2s ease;
      will-change:transform
    }
    .btn.secondary{background:var(--pri-weak);color:var(--fg)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(31,122,238,.18)}
    .btn:active{transform:translateY(0);box-shadow:inset 0 1px 3px rgba(0,0,0,.25)}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
    .btn-link{background:transparent;border:0;color:var(--pri);cursor:pointer;padding:0;transition:opacity .12s ease}
    .btn-link:hover{text-decoration:underline;text-underline-offset:3px}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;transform:none}

    input[type="text"],input[type="number"],input[type="date"],select{
      height:34px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--fg);outline:none
    }
    input:focus,select:focus{box-shadow:0 0 0 3px var(--focus)}

    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    thead th{position:sticky;top:0;background:var(--card);z-index:1;user-select:none;cursor:pointer}
    thead th[data-nosort]{cursor:default}

    .muted{color:var(--muted)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#9ca3af}
    .dot.on{background:var(--success)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--fg);padding:4px 8px;border-radius:999px;font-size:12px}
    .chip .dot{width:8px;height:8px}
    .pill{background:var(--pill-bg);color:var(--pill-fg);padding:4px 8px;border-radius:999px;font-weight:600}
    .kpi{font-weight:700}

    .panel{border:1px solid var(--line);border-radius:12px;background:var(--card);padding:12px;margin:12px 0}
    .note{margin:10px 0 14px; padding:8px 10px;border-radius:10px;display:none}
    .note.ok{display:block;background:var(--ok-bg);color:var(--ok-fg);border:1px solid var(--ok-border)}
    .note.err{display:block;background:var(--err-bg);color:var(--err-fg);border:1px solid var(--err-border)}
    .statbar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .stat{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .stat .badge{font-weight:700}
    .stat.ok .badge{color:var(--success)}
    .stat.err .badge{color:var(--danger)}

    /* History (collapsible) */
    details.hist{border:1px solid var(--line);border-radius:12px;background:var(--card);margin-bottom:12px;overflow:hidden}
    details.hist>summary{
      list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; position:sticky; top:0; background:var(--card); z-index:2
    }
    details.hist>summary::-webkit-details-marker{display:none}
    .caret{width:12px;height:12px;border-right:2px solid var(--fg);border-bottom:2px solid var(--fg);transform:rotate(-45deg);transition:transform .2s}
    details[open] .caret{transform:rotate(45deg)}
    .hist-body{padding:0 12px 12px}
    .hist-controls{display:flex;gap:8px;align-items:end;flex-wrap:wrap;padding:0 12px 12px}
    .hist-stats{padding:0 12px 10px}
    .hist-table-wrap{overflow:auto;max-height:60vh;margin:0 12px 12px}
    .progress{height:8px;background:var(--line);border-radius:999px; overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--pri);width:0;transition:width .2s}

    /* details row in products table */
    tr.detail{background:var(--card)}
    .block{padding:12px}

    /* Tabs */
    .tabs{display:flex;gap:6px;align-items:center}
    .tab{border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:999px;padding:6px 10px;cursor:pointer}
    .tab.active{background:var(--pri);color:#fff;border-color:transparent}
    .tab .badge{font-weight:700;margin-left:4px}

    /* Low-stock + recommendations */
    td.lowcell{color:var(--danger);font-weight:700}
    #recoPanel{display:none}
    .reco{display:flex;flex-wrap:wrap;gap:10px}
    .reco .card{border:1px solid var(--line);background:var(--card);padding:10px;border-radius:12px;width:280px}
    .reco .card .badge{font-weight:700}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a href="#" style="background:var(--card)">Мой склад</a>
        <a href="/ui/index.html">Аналитика</a>
      </nav>
      <div class="switch">
        <input id="themeToggle" type="checkbox" />
        <label for="themeToggle">Тёмная тема</label>
      </div>
    </aside>

    <main class="content">
      <h1 style="margin:0 0 8px">Мой склад</h1>

      <!-- История (сворачивается) -->
      <details class="hist" id="history">
        <summary>
          <span class="caret"></span>
          <b style="font-size:16px">История списаний (FIFO)</b>
          <span class="muted">за период</span>
          <div class="pill" id="histRangeLabel">—</div>
          <div class="row" style="margin-left:auto">
            <button class="btn ghost small" id="btnHistRefresh">Обновить</button>
          </div>
        </summary>

        <div class="hist-controls">
          <div>
            <div class="muted">Период</div>
            <div class="row">
              <input type="date" id="histFrom"> —
              <input type="date" id="histTo">
              <button class="btn secondary" id="btnHistLoad">Показать</button>
            </div>
          </div>
          <div class="row" style="gap:10px;margin-left:auto">
            <div class="chip" title="Строк в истории"><span class="badge">Строк:</span> <span id="hstRows">0</span></div>
            <div class="chip" title="Уникальных заказов"><span class="badge">Заказов:</span> <span id="hstOrders">0</span></div>
            <div class="chip" title="Уникальных SKU"><span class="badge">SKU:</span> <span id="hstSkus">0</span></div>
            <div class="chip" title="Суммарное количество"><span class="badge">qty:</span> <span id="hstQty">0</span></div>
            <div class="chip" title="Выручка"><span class="badge">Выручка:</span> <span id="hstRevenue">0</span> KZT</div>
            <div class="chip" title="Себестоимость"><span class="badge">Себестоимость:</span> <span id="hstCost">0</span> KZT</div>
            <div class="chip" title="Прибыль"><span class="badge">Прибыль:</span> <span id="hstProfit">0</span> KZT</div>
          </div>
          <div class="grow" style="width:100%">
            <div class="progress" title="Прогресс загрузки"><span id="histProgress"></span></div>
          </div>
        </div>

        <div class="hist-table-wrap">
          <table id="histTable">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Заказ</th>
                <th>SKU</th>
                <th>Название</th>
                <th>Кол-во</th>
                <th>Цена/шт</th>
                <th>Выручка</th>
                <th>Комиссия</th>
                <th>Себестоимость</th>
                <th>Прибыль</th>
                <th>Партия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- СИГНАЛЫ -->
      <div id="signals" class="statbar">
        <div class="stat" id="sig-last"><span class="badge">Последнее списание:</span><span class="muted">—</span></div>
        <div class="stat" id="sig-cogs-today"><span class="badge">Себестоимость сегодня:</span><span class="muted">—</span></div>
        <div class="stat" id="sig-stock">
          <span class="badge">Стоимость остатков:</span>
          <span id="stockRetail" class="kpi muted">—</span>
          <span class="muted">·</span>
          <span id="stockCost" class="muted">себестоим.: —</span>
          <button class="btn-link small" id="btnCalcCost" title="Рассчитать по сред. себестоимости (через партии)">пересчитать</button>
        </div>
      </div>

      <!-- Рекомендации к закупке -->
      <div class="panel" id="recoPanel">
        <div class="row" style="justify-content:space-between">
          <div><b>Рекомендации к закупке</b> <span class="muted">(по скорости продаж, последние 14 дней)</span></div>
          <div class="row"><span class="muted">Период:</span> <div class="pill" id="recoRange">последние 14 дней</div></div>
        </div>
        <div id="recoList" class="reco"></div>
      </div>

      <!-- ПАНЕЛЬ FIFO -->
      <div class="panel" id="fifo-panel">
        <div class="row" style="align-items:end">
          <div>
            <div class="muted">Период</div>
            <input type="date" id="fifo-from"> —
            <input type="date" id="fifo-to">
          </div>
          <label class="row" title="Если включить — для пропусков создадим товар и добавим партию на недостающее кол-во.">
            <input id="fifo-fill-missing" type="checkbox"><span>Добить партии для пропусков</span>
          </label>
          <div>
            <div class="muted">Себестоимость по умолчанию</div>
            <input id="fifo-default-cost" type="number" min="0" step="1" value="3000" style="width:120px">
          </div>
          <div>
            <div class="muted">Комиссия, %</div>
            <input id="fifo-default-comm" type="number" min="0" step="0.1" value="15" style="width:120px">
          </div>
          <button class="btn" id="fifo-run">Списать со склада</button>
        </div>
        <div class="muted" style="margin-top:6px">
          Внимание: автоматического списания нет — списание выполняется только по кнопке «Списать со склада».
        </div>
        <div id="fifo-log" class="panel" style="max-height:260px;overflow:auto"></div>
      </div>

      <!-- Управление товарами: вкладки и действия -->
      <div class="row" style="margin-top:6px">
        <div class="tabs" id="tabs">
          <button class="tab active" id="tabIn"><span>В продаже</span><span class="badge" id="cntIn">0</span></button>
          <button class="tab" id="tabOut"><span>Сняты/Нет</span><span class="badge" id="cntOut">0</span></button>
        </div>
        <div class="grow"></div>
        <span class="pill" id="rowsBadge" title="Строк в таблице">0 позиций</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label class="btn secondary" for="fileInput">Импорт XML/XLSX</label>
        <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
        <button class="btn" id="btnSaveDb">Сохранить таблицу в БД</button>
        <button class="btn secondary" id="btnLoadDb">Загрузить из БД</button>

        <div class="grow"></div>

        <label class="row" style="gap:6px">
          <span class="muted">Порог «мало»</span>
          <input id="lowThreshold" type="number" min="1" step="1" value="3" style="width:70px">
        </label>
        <label class="row" style="gap:6px">
          <input id="mergeMode" type="checkbox" checked>
          <span class="muted">Merge-режим (не удалять старые)</span>
        </label>
        <label class="row" style="gap:6px">
          <input id="priceOnly" type="checkbox" checked>
          <span class="muted">Только цены (qty/активность не менять)</span>
        </label>
      </div>

      <div class="row" style="margin-top:6px">
        <input id="findSku" type="text" placeholder="SKU" style="width:160px">
        <button class="btn secondary" id="btnFindSku">Открыть SKU</button>
      </div>

      <div id="note" class="note"></div>

      <div class="panel" style="padding:0">
        <div style="overflow:auto; max-height:70vh">
          <table id="tbl">
            <thead>
              <tr>
                <th style="min-width:160px">Код</th>
                <th style="min-width:360px">Название</th>
                <th>Бренд</th>
                <th>Категория</th>
                <th>ШТ</th>
                <th>Цена, KZT</th>
                <th>Активен</th>
                <th>Остаток (партии)</th>
                <th>Кол-во партий</th>
                <th>Маржа (посл.), KZT</th>
                <th class="col-right" data-nosort>Партии / История</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

<script type="module">
/* ───────────────── helpers ───────────────── */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Number(n||0));
const sleep = ms => new Promise(r => setTimeout(r, ms));
const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const parseNum = (txt) => Number(String(txt||'0').replace(/\s/g,'').replace(',', '.'))||0;
function setNote(msg, ok=false){ const el = qs('#note'); el.textContent = msg; el.className = 'note ' + (ok ? 'ok':'err'); }

/* theme */
(function initTheme(){
  const saved = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', saved);
  qs('#themeToggle').checked = saved === 'dark';
  qs('#themeToggle').addEventListener('change', e=>{
    const t = e.target.checked ? 'dark' : 'light';
    document.body.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  });
})();

/* API key injector via fetch wrapper */
async function fetchJSON(url, opts, _retry){
  const r = await fetch(url, opts||{});
  if(r.status===401 || r.status===403){
    if(!_retry){
      const curr = window.KASPI_API_KEY || "";
      const v = prompt("Укажите X-API-Key (сохранится в этом браузере):", curr);
      if(v!==null){ window.setApiKey(v.trim()); return fetchJSON(url, opts, true); }
    }
    const txt = await r.text(); throw new Error(txt || 'Unauthorized');
  }
  if(!r.ok){ const txt = await r.text(); throw new Error(txt || r.statusText || ('HTTP ' + r.status)); }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

/* ───────── глобальное состояние ───────── */
let sortState = { idx: 1, dir: 1 };
let _view = 'in';              // in | out
let _recoDays = 14;
const LOW_KEY='LOW_THRESHOLD';
const getLow = () => Number(localStorage.getItem(LOW_KEY) || '3');
const setLow = (v) => { const n = Math.max(1, Number(v)||3); localStorage.setItem(LOW_KEY, String(n)); };

function updateRowsBadge(){ const n = qsa('#tbl tbody tr').length; const b = qs('#rowsBadge'); if(b) b.textContent = nf.format(n) + ' позиций'; }

function sortTable(idx, type='str'){
  const tb = qs('#tbl tbody'); if(!tb) return;
  const rows = qsa('tr', tb);
  rows.sort((a,b)=>{
    const ax = a.children[idx]?.textContent?.trim() ?? '';
    const bx = b.children[idx]?.textContent?.trim() ?? '';
    return (type==='num' ? (parseNum(ax)-parseNum(bx)) : ax.localeCompare(bx,'ru'))*sortState.dir;
  });
  tb.innerHTML = ''; rows.forEach(r=>tb.appendChild(r));
}
function attachSorting(){
  const ths = qsa('#tbl thead th');
  ths.forEach((th,i)=>{
    if (th.hasAttribute('data-nosort')) return;
    th.addEventListener('click', ()=>{
      const txt = th.textContent || '';
      const type = /ШТ|Цена|Остаток|Кол-во|Маржа/i.test(txt) ? 'num' : 'str';
      sortState.dir = (sortState.idx === i) ? -sortState.dir : 1;
      sortState.idx = i; sortTable(i, type);
    });
  });
}

/* фильтрация для вкладок */
function filterByView(items){
  const list = items||[];
  if(_view==='in'){
    return list.filter(it=>{
      const left = Number(it.left_total ?? it.qty ?? 0) || 0;
      const active = !!it.active;
      return left>0 && active;  // реально есть и активен
    });
  }else{
    return list.filter(it=>{
      const left = Number(it.left_total ?? it.qty ?? 0) || 0;
      const active = !!it.active;
      return left<=0 || !active; // нет остатков или снят
    });
  }
}

function renderProducts(items){
  const tb = qs('#tbl tbody'); tb.innerHTML = '';
  const low = getLow();
  const viewItems = filterByView(items);
  viewItems.forEach(it=>{
    const tr = document.createElement('tr');
    const sku = it.code || it.id || '';
    const left = Number(it.left_total ?? it.qty ?? 0) || 0;
    const lowClass = (left > 0 && left <= low) ? 'lowcell' : '';
    tr.dataset.sku = sku;
    tr.innerHTML = `
      <td>${escapeHtml(sku)}</td>
      <td title="${escapeHtml(it.name||'')}">${escapeHtml(it.name||'')}</td>
      <td>${escapeHtml(it.brand||'')}</td>
      <td>${escapeHtml(it.category||'')}</td>
      <td>${fmt(it.qty||0)}</td>
      <td>${fmt(it.price||0)}</td>
      <td><span class="dot ${((it.qty||0)>0 || it.active===true) ? 'on':''}" title="${it.active?'активен':'нет'}"></span></td>
      <td class="${lowClass}">${fmt(left)}</td>
      <td>${fmt(it.batch_count||0)}</td>
      <td>${it.last_margin!=null ? fmt(it.last_margin) : '—'}</td>
      <td class="col-right">
        <button class="btn-link btn-parties">Партии</button>
        <span class="muted"> · </span>
        <button class="btn-link btn-history">История</button>
      </td>`;
    tb.appendChild(tr);
  });
  updateRowsBadge();
  const th = qs('#tbl thead th:nth-child('+(sortState.idx+1)+')');
  sortTable(sortState.idx, /ШТ|Цена|Остаток|Кол-во|Маржа/i.test(th?.textContent||'')?'num':'str');
}

/* сохранение таблицы обратно */
function tableToRows(){
  return qsa('#tbl tbody tr').map(tr=>{
    const t = tr.children;
    const code = t[0].textContent.trim(); const name = t[1].textContent.trim();
    const brand = t[2].textContent.trim() || null; const category = t[3].textContent.trim() || null;
    const qty = parseNum(t[4].textContent); const price = parseNum(t[5].textContent);
    const active = t[6].querySelector('.dot')?.classList.contains('on') || false;
    return { code, name, brand, category, qty, price, active };
  });
}

/* ───────── склад: суммы ───────── */
function recomputeStockTotals(items){
  let totalRetail=0, totalQty=0;
  for (const it of (items||[])){
    const left = Number(it.left_total ?? it.qty ?? 0) || 0;
    const price = Number(it.price || 0) || 0;
    totalQty += left; totalRetail += left * price;
  }
  qs('#stockRetail').textContent = `${fmt(Math.round(totalRetail))} KZT`;
  qs('#sig-stock').classList.add(totalQty>0 ? 'ok':'err');
}
async function computeStockValueFromApi(){
  const spanCost = qs('#stockCost');
  const spanRetail = qs('#stockRetail');
  const btn = qs('#btnCalcCost');
  btn.disabled = true; spanCost.textContent = 'себестоим.: считаю…';
  try{
    const data = await fetchJSON('/products/db/stock-value?with_retail=1&details=0');
    const totalCost = Math.round(Number(data.total_cost || 0));
    const totalRetail = Math.round(Number(data.total_retail || 0));
    spanCost.textContent = `себестоим.: ${fmt(totalCost)} KZT`;
    if (!isNaN(totalRetail) && totalRetail>0) spanRetail.textContent = `${fmt(totalRetail)} KZT`;
  }catch(e){
    spanCost.textContent = 'себестоим.: ошибка';
    setNote('Расчёт себестоимости не удался: ' + e.message);
  }finally{ btn.disabled = false; }
}

/* ───────── загрузка/импорт ───────── */
async function loadDB(){
  try{
    const p = new URLSearchParams({ active_only:'0', page:'1', page_size:'20000' });
    const data = await fetchJSON('/products/db/list?'+p.toString());
    setNote('Загружено строк из БД: ' + (data.items?.length||0), true);
    window._productsCache = data.items||[];

    // counters для вкладок
    const inCount  = filterByView(window._productsCache.filter(x=>true && (x.active))).length;
    const outCount = filterByView(window._productsCache.filter(x=>true && (!x.active || (Number(x.left_total ?? x.qty ?? 0)||0)<=0))).length;
    qs('#cntIn').textContent = fmt(inCount);
    qs('#cntOut').textContent = fmt(outCount);

    renderProducts(window._productsCache);
    recomputeStockTotals(window._productsCache);
  }catch(e){ setNote('Сеть: ' + e.message); }
}
async function importFile(file){
  const fd = new FormData();
  fd.append('file', file);
  const priceOnly = qs('#priceOnly')?.checked ? 1 : 0;
  try{
    const url = `/products/manual-upload?price_only=${priceOnly}`;
    const data = await fetchJSON(url, { method:'POST', body: fd });
    setNote(`Файл загружен: ${file.name}. Вставлено: ${fmt(data.inserted||0)}, обновлено: ${fmt(data.updated||0)}. Обновляю таблицу…`, true);
    await loadDB();
  }catch(e){ setNote('Импорт не удался: ' + e.message); }
}

/* ───────── даты ───────── */
function isoDay(d){ return d.toISOString().slice(0,10); }
function dayStartTs(dateStr){ return new Date(dateStr+'T00:00:00.000Z').getTime(); }
function dayEndTs(dateStr){   return new Date(dateStr+'T23:59:59.999Z').getTime(); }
function addDays(dateStr, d){ const dt = new Date(dateStr+'T00:00:00Z'); dt.setUTCDate(dt.getUTCDate()+d); return isoDay(dt); }

/* ───────── заказы/леджер ───────── */
async function getOrderCodes(start, end){
  const qs1 = new URLSearchParams({
    start, end, tz:'Asia/Almaty', date_field:'creationDate',
    order:'asc', grouped:'1', limit:'0', with_items:'1',
    use_bd:'1', business_day_start:'20:00',
    assign_mode:'smart', store_accept_until:'17:00',
    items_mode:'all', exclude_states:'CANCELED',
  });
  const j = await fetchJSON('/orders/ids?' + qs1.toString());
  if (Array.isArray(j.ids)) return j.ids.map(x => String(x));
  if (Array.isArray(j.items)) {
    const codes = j.items.map(r => r.order_code || r.number || r.code).filter(Boolean).map(String);
    return [...new Set(codes)];
  }
  return [];
}
async function getLedgerByCodes(orderCodes, chunk=50, perLimit=10000, onProgress){
  const res = [];
  for (let i=0; i<orderCodes.length; i+=chunk){
    const part = orderCodes.slice(i, i+chunk).map(encodeURIComponent).join(',');
    const url = `/profit/bridge/fifo/ledger?codes=${part}&limit=${perLimit}`;
    const j = await fetchJSON(url);
    if (Array.isArray(j.items)) res.push(...j.items);
    if (typeof onProgress==='function') onProgress(Math.min(i+chunk, orderCodes.length), orderCodes.length);
    if (orderCodes.length>chunk) await sleep(30);
  }
  return res;
}

/* ───────── история ───────── */
function setHistRangeLabel(){
  const f = qs('#histFrom').value, t=qs('#histTo').value;
  qs('#histRangeLabel').textContent = (f && t) ? `${f} — ${t}` : '—';
}
function paintHistTotals(rows){
  const st = {rows:0, orders:new Set(), skus:new Set(), qty:0, revenue:0, cost:0, profit:0};
  for (const r of rows){
    st.rows++; if (r.order_code) st.orders.add(String(r.order_code));
    if (r.sku) st.skus.add(String(r.sku));
    st.qty += (r.qty||0); st.revenue += (r.total_price||0); st.cost += (r.cost_amount||0); st.profit += (r.profit_amount||0);
  }
  qs('#hstRows').textContent = fmt(st.rows);
  qs('#hstOrders').textContent = fmt(st.orders.size);
  qs('#hstSkus').textContent = fmt(st.skus.size);
  qs('#hstQty').textContent = fmt(st.qty);
  qs('#hstRevenue').textContent = fmt(st.revenue);
  qs('#hstCost').textContent = fmt(st.cost);
  qs('#hstProfit').textContent = fmt(st.profit);
}
async function loadHistoryRange(){
  const FROM = qs('#histFrom').value, TO = qs('#histTo').value;
  setHistRangeLabel();
  const tbody = qs('#histTable tbody'); tbody.innerHTML='';
  const progress = qs('#histProgress'); progress.style.width='0';
  try{
    const orderCodes = await getOrderCodes(FROM, TO);
    if(!orderCodes.length){ paintHistTotals([]); return; }
    const startTs = dayStartTs(FROM), endTs = dayEndTs(TO);
    const rowsAll = await getLedgerByCodes(orderCodes, 50, 10000, (done,total)=>{ progress.style.width = Math.round(done/total*100)+'%'; });
    const list = rowsAll.filter(x => x.date_utc_ms>=startTs && x.date_utc_ms<=endTs)
                        .sort((a,b)=>b.date_utc_ms - a.date_utc_ms);
    paintHistTotals(list);
    for (const r of list){
      const tr = document.createElement('tr');
      const dt = new Date(Number(r.date_utc_ms||0));
      tr.innerHTML = `
        <td>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</td>
        <td>${escapeHtml(r.order_code||'')}</td>
        <td>${escapeHtml(r.sku||'')}</td>
        <td>${escapeHtml(r.title||'')}</td>
        <td>${fmt(r.qty)}</td>
        <td>${fmt(r.unit_price)} KZT</td>
        <td>${fmt(r.total_price)} KZT</td>
        <td>${fmt(r.commission_amount)} KZT</td>
        <td>${fmt(r.cost_amount)} KZT</td>
        <td>${fmt(r.profit_amount)} KZT</td>
        <td>${r.batch_id ? ('#'+r.batch_id) : ''}</td>`;
      tbody.appendChild(tr);
    }
  }catch(e){ setNote('История: ' + e.message); }
}

/* ───────── FIFO / bridge ───────── */
function logFIFO(msg, obj){
  const el = qs("#fifo-log"); const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div>[${time}] ${escapeHtml(msg)}</div>`;
  if (obj) el.innerHTML += `<pre style="white-space:pre-wrap;margin:4px 0">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>`;
  el.scrollTop = el.scrollHeight;
}
function setDefaultDates(){
  const today = new Date();
  const y = new Date(Date.now()-24*3600*1000);
  qs("#fifo-from").value = y.toISOString().slice(0,10);
  qs("#fifo-to").value   = today.toISOString().slice(0,10);
  qs("#histFrom").value  = y.toISOString().slice(0,10);
  qs("#histTo").value    = today.toISOString().slice(0,10);
  setHistRangeLabel();
}
async function ensureSkuAndBatch(sku, need, cost, comm){
  try{ await fetchJSON(`/products/db/ensure-sku/${encodeURIComponent(sku)}?name=${encodeURIComponent(sku)}&price=0&qty=0&active=1`, { method:'POST' }); }catch(_){}
  return fetchJSON(`/products/db/price-batches/${encodeURIComponent(sku)}`, {
    method:'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ entries: [{ date: new Date().toISOString().slice(0,10), qty:Number(need), unit_cost:Number(cost), commission_pct:Number(comm), note:'auto-fill' }]})
  });
}
async function getBridgeLinesForPeriod(FROM, TO){
  const p = new URLSearchParams({
    start: FROM, end: TO, tz:'Asia/Almaty', date_field:'creationDate',
    order: 'asc', grouped:'0', limit:'100000', with_items:'1',
    use_bd:'1', business_day_start:'20:00', assign_mode:'smart',
    store_accept_until:'17:00', items_mode:'all', exclude_states:'CANCELED',
  });
  const j = await fetchJSON('/orders/ids?' + p.toString());
  const rows = Array.isArray(j.items) ? j.items : [];
  const counters = new Map(); const lines = [];
  for (const r of rows){
    const orderId   = String(r.id || r.order_id || r.orderId || r.code || '').trim(); if (!orderId) continue;
    const orderCode = String(r.order_code || r.number || r.code || '').trim();
    const idx = (counters.set(orderId, (counters.get(orderId)||0) + 1), counters.get(orderId));
    const qty  = Number(r.qty ?? r.quantity ?? 1) || 1;
    const unit = Number(r.unit_price ?? r.price ?? (Number(r.total_price || r.amount || 0) / qty)) || 0;
    const total = Number(r.total_price ?? r.amount ?? (unit * qty)) || 0;
    lines.push({ id: orderId, code: orderCode||null, date: r.creationDate || r.date || null, state: r.state || null,
      sku: String(r.sku || r.vendorCode || r.barcode || r.code || '').trim() || null, title: r.title || r.name || null,
      qty, unit_price: unit, total_price: total, line_index: idx });
  }
  return lines;
}
async function syncBridgeLines(lines){
  let synced=0, codes=[];
  const key = window.KASPI_API_KEY || null;
  if (!key) { logFIFO('⚠ Нет KASPI_API_KEY — синхронизация bridge пропущена.'); return { synced:0, codes:[] }; }
  for (let i=0; i<lines.length; i+=200){
    const chunk = lines.slice(i, i+200);
    const res = await fetchJSON('/profit/bridge/sync-by-ids', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(chunk)
    });
    synced += Number(res?.synced||0);
    if (Array.isArray(res?.codes)) codes.push(...res.codes);
    await sleep(60);
  }
  return { synced, codes:[...new Set(codes)] };
}
async function runFIFO(){
  const FROM = qs('#fifo-from').value;
  const TO   = qs('#fifo-to').value;
  const FILL = qs('#fifo-fill-missing').checked;
  const DEFAULT_COST = Number(qs('#fifo-default-cost').value||0);
  const DEFAULT_COMM = Number(qs('#fifo-default-comm').value||0);

  const btn = qs('#fifo-run'); btn.disabled = true; btn.textContent = 'Работаю…';
  qs('#fifo-log').innerHTML = '';

  try{
    logFIFO('Пинг БД…'); const ping = await fetchJSON('/products/db/ping');
    if (!ping.ok) throw new Error('DB ping failed'); logFIFO('OK', ping);

    logFIFO(`Получаю строки заказов ${FROM}..${TO}…`);
    const lines = await getBridgeLinesForPeriod(FROM, TO);
    logFIFO(`Найдено строк: ${lines.length}`);

    if (lines.length){
      logFIFO('Синхронизация bridge…');
      const syncRes = await syncBridgeLines(lines);
      logFIFO('Bridge sync', syncRes);
    }

    logFIFO('FIFO apply #1…');
    const apply1 = await fetchJSON(`/profit/bridge/fifo/apply?date_from=${FROM}&date_to=${TO}`, { method:'POST' });
    logFIFO('Apply #1 результат', apply1);
    let gaps = Array.isArray(apply1.gaps) ? apply1.gaps : [];

    if (gaps.length && FILL) {
      const agg = {};
      gaps.forEach(g => { const s=String(g.sku||'').trim(); const n=Number(g.not_covered_qty||0); if(s&&n>0) agg[s]=(agg[s]||0)+n; });
      logFIFO('Дефицит по SKU:', agg);
      for (const [sku, need] of Object.entries(agg)) {
        logFIFO(`Добавляю партию: ${sku} → ${need}шт по ${DEFAULT_COST} KZT, комиссия ${DEFAULT_COMM}%`);
        const r = await ensureSkuAndBatch(sku, need, DEFAULT_COST, DEFAULT_COMM);
        logFIFO('OK', r); await sleep(40);
      }
      const affectedCodes = [...new Set(gaps.map(g => g.order_code).filter(Boolean))];
      if (affectedCodes.length){
        logFIFO('FIFO apply #2 по заказам:', affectedCodes);
        const apply2 = await fetchJSON(`/profit/bridge/fifo/apply?codes=${affectedCodes.map(encodeURIComponent).join(',')}`, { method:'POST' });
        logFIFO('Apply #2 результат', apply2);
        gaps = Array.isArray(apply2.gaps) ? apply2.gaps : [];
      }
    }

    logFIFO('Пересчитываю qty_sold по партиям…');
    const rec = await fetchJSON('/products/batches/recount-sold', { method:'POST' });
    logFIFO('recalc-batches', rec);

    if (gaps.length===0) logFIFO('✅ Готово: дыры отсутствуют, полное списание выполнено.');
    else                 logFIFO('⚠ Есть незакрытые дыры:', gaps);

    await loadHistoryRange();
    await refreshSignals();
  }catch(e){
    logFIFO('❌ Ошибка: ' + (e?.message || e));
  }finally{
    btn.disabled = false; btn.textContent = 'Списать со склада';
  }
}

/* ───────── сигналы за сегодня ───────── */
function calcSignalsFromLedger(items, startTs, endTs){
  const rows = items.filter(x => typeof x.date_utc_ms==='number' && x.date_utc_ms>=startTs && x.date_utc_ms<=endTs);
  const qtySum    = rows.reduce((a,r)=>a+(Number(r.qty)||0),0);
  const profitSum = rows.reduce((a,r)=>a+(Number(r.profit_amount)||0),0);
  const costSum   = rows.reduce((a,r)=>a+(Number(r.cost_amount)||0),0);
  const revSum    = rows.reduce((a,r)=>a+(Number(r.total_price)||0),0);
  const orders = new Set(rows.map(x => x.order_code));
  const skus   = new Set(rows.map(x => x.sku));
  return { rows, orders: orders.size, skus: skus.size, qty: qtySum, profit: profitSum, cost: costSum, revenue: revSum };
}
async function refreshSignals(){
  try{
    const today = isoDay(new Date());
    const codesToday = await getOrderCodes(today, today);
    const ledToday = codesToday.length ? await getLedgerByCodes(codesToday) : [];
    const stToday = calcSignalsFromLedger(ledToday, dayStartTs(today), dayEndTs(today));

    const elCogs = qs('#sig-cogs-today');
    elCogs.classList.remove('ok','err');
    elCogs.classList.add(stToday.cost > 0 ? 'ok' : 'err');
    elCogs.innerHTML = `<span class="badge">Себестоимость сегодня:</span><span class="kpi">${fmt(stToday.cost)} KZT</span>`;

    const pick = (arr)=>arr.reduce((acc,r)=>{ const ts = Number(r.date_utc_ms || r.created_at || 0); return (!isNaN(ts) && (!acc || ts>acc)) ? ts : acc; }, null);
    const lastCreated = pick(ledToday);
    const elLast = qs('#sig-last');
    elLast.classList.remove('ok','err');
    if(lastCreated){
      elLast.classList.add('ok');
      const dt = new Date(Number(lastCreated));
      elLast.innerHTML = `<span class="badge">Последнее списание:</span><span>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</span>`;
    }else{
      elLast.classList.add('err');
      elLast.innerHTML = `<span class="badge">Последнее списание:</span><span class="muted">не найдено</span>`;
    }
  }catch{
    const el = qs('#sig-last'); el.classList.add('err'); el.innerHTML = `<span class="badge">Последнее списание:</span><span class="muted">ошибка</span>`;
  }
}

/* ───────── рекомендации к закупке ───────── */
function renderRecs(items){
  const box = qs('#recoPanel'); const list = qs('#recoList');
  if(!box || !list) return;
  if(!items || !items.length){ box.style.display='none'; list.innerHTML=''; return; }
  box.style.display='block';
  list.innerHTML = items.map(it => `
    <div class="card">
      <div style="font-weight:600">${escapeHtml(it.name)}</div>
      <div class="muted" style="font-size:12px">${escapeHtml(it.sku)}</div>
      <div class="row" style="gap:8px;margin-top:6px">
        <span class="chip"><span class="badge">продаж за ${_recoDays}д:</span> ${fmt(it.sold)}</span>
        <span class="chip"><span class="badge">в день:</span> ${fmt(it.daily.toFixed(2))}</span>
        <span class="chip"><span class="badge">остаток:</span> ${fmt(it.left)}</span>
        <span class="chip"><span class="badge">реком. докупить:</span> ${fmt(it.suggested)}</span>
      </div>
      <div class="row" style="gap:8px;margin-top:6px">
        <button class="btn small btnOpen" data-sku="${escapeHtml(it.sku)}">Открыть</button>
      </div>
    </div>
  `).join('');
  list.querySelectorAll('.btnOpen').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const row = qsa('#tbl tbody tr').find(tr => (tr.dataset.sku||tr.cells[0].textContent.trim()) === btn.dataset.sku);
      if(row){ row.scrollIntoView({behavior:'smooth', block:'center'}); openDetail(row); }
    });
  });
}

async function recomputeRecommendations(){
  try{
    const to = isoDay(new Date());
    const from = addDays(to, -(_recoDays-1));
    const orderCodes = await getOrderCodes(from, to);
    const rows = orderCodes.length ? await getLedgerByCodes(orderCodes) : [];

    const salesBySku = new Map();
    const nameBySku  = new Map();
    for (const r of rows){
      const sku = String(r.sku||'').trim(); if(!sku) continue;
      salesBySku.set(sku, (salesBySku.get(sku)||0) + (Number(r.qty)||0));
      if (r.title && !nameBySku.has(sku)) nameBySku.set(sku, r.title);
    }

    const stockBySku = new Map((window._productsCache||[]).map(it => [String(it.code), Number(it.left_total ?? it.qty ?? 0)]));
    const recs = [];
    const days = _recoDays;
    for (const [sku, sold] of salesBySku.entries()){
      const daily = sold / days;
      const left  = stockBySku.get(sku) || 0;
      if (sold >= 5 && left <= Math.max(2, Math.ceil(daily * 7))){
        const name = nameBySku.get(sku) || (window._productsCache.find(x=>x.code===sku)?.name) || sku;
        const suggested = Math.max(0, Math.ceil(daily * 14 - left));
        recs.push({ sku, name, left, sold, daily, suggested });
      }
    }
    recs.sort((a,b)=> b.daily - a.daily);
    renderRecs(recs.slice(0, 12));
  }catch(e){ /* тихо */ }
}

/* ───────── SKU details (партии / история по SKU) ───────── */
function clearDetails(){ qsa('tr.detail').forEach(tr => tr.remove()); }
function makeDetailRow(colspan){ const tr = document.createElement('tr'); tr.className='detail'; const td=document.createElement('td'); td.colSpan=colspan; tr.appendChild(td); return tr; }
async function openDetail(row){
  clearDetails();
  const sku = row?.dataset?.sku || row.cells?.[0]?.textContent?.trim();
  if(!sku){ setNote('У товара нет кода/sku — некуда сохранять партии.'); return; }

  const tr = makeDetailRow(row.children.length); row.insertAdjacentElement('afterend', tr);
  const mount = tr.firstChild;

  mount.innerHTML = `
    <div class="block">
      <div style="display:flex;align-items:center;gap:10px;margin:8px 0 6px">
        <div style="font-weight:600">Партии — <span id="dTitle">${escapeHtml(row.cells[1].textContent)}</span> <span class="muted">(${escapeHtml(sku)})</span></div>
        <button class="btn secondary" id="btnRecount">Пересчитать списания (FIFO)</button>
      </div>

      <table style="width:100%" id="btTable">
        <thead>
          <tr>
            <th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Комиссия, %</th>
            <th>Маржа / шт</th><th>Продано</th><th>Остаток</th><th>Код</th><th>Прим.</th><th></th>
          </tr>
        </thead>
        <tbody id="btBody"></tbody>
      </table>

      <div class="row" style="margin-top:8px; gap:8px">
        <button class="btn secondary" id="btnAddRow">+ Добавить</button>
        <button class="btn" id="btnSaveRows">Сохранить новые</button>
      </div>
    </div>`;

  const tbody = qs('#btBody', mount);
  const priceKZT = parseNum(row.cells[5].textContent);

  function recalc(tr){
    const inputs = tr.querySelectorAll('input');
    const uc = Number(inputs[2].value||0), comm = Number(inputs[3].value||0);
    const net = priceKZT - (priceKZT * comm/100) - uc;
    tr.querySelector('.net').textContent = isFinite(net) ? fmt(net) : '—';
  }
  function addRow(data={}){
    const tr = document.createElement('tr');
    const codeCell = (data && data.batch_code) ? escapeHtml(data.batch_code) : '<span class="muted">— генерируется</span>';
    const delBtn = (data && data.id) ? `<button class="btn-link btnDel" data-id="${data.id}">Удалить</button>` : '';
    const sold = data.qty_sold ?? data.sold ?? null;
    const left = data.left ?? (typeof sold === 'number' && typeof data.qty === 'number' ? (data.qty - sold) : null);
    tr.innerHTML = `
      <td><input type="date" value="${data.date || new Date().toISOString().slice(0,10)}"></td>
      <td><input type="number" min="0" step="1" value="${data.qty ?? ''}" style="width:90px"></td>
      <td><input type="number" min="0" step="0.01" value="${data.unit_cost ?? ''}" style="width:110px"></td>
      <td><input type="number" min="0" step="0.01" value="${data.commission_pct ?? ''}" style="width:100px"></td>
      <td class="net">—</td>
      <td>${sold != null ? fmt(sold) : '—'}</td>
      <td>${left != null ? fmt(left) : '—'}</td>
      <td class="code">${codeCell}</td>
      <td><input type="text" value="${escapeHtml(data.note ?? '')}"></td>
      <td>${delBtn}</td>`;
    tbody.appendChild(tr); recalc(tr);
  }

  try{ const data = await fetchJSON('/products/db/price-batches/'+encodeURIComponent(sku)); (data.batches||[]).forEach(addRow); }
  catch(e){ setNote('Не удалось загрузить партии: ' + e.message); }

  qs('#btnAddRow', mount).onclick = ()=> addRow({});
  tbody.addEventListener('input', e=>{ const tr = e.target.closest('tr'); if(tr) recalc(tr); });
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btnDel'); if(!btn) return;
    try{ await fetchJSON('/products/db/price-batches/'+encodeURIComponent(sku)+'/'+btn.dataset.id, {method:'DELETE'}); btn.closest('tr').remove(); setNote('Партия удалена.', true); }
    catch(err){ setNote('Удаление не удалось: ' + err.message); }
  });

  qs('#btnSaveRows', mount).onclick = async ()=>{
    const entries = qsa('tr', tbody).map(tr=>{
      const ins = tr.querySelectorAll('input');
      const codeText = tr.querySelector('.code')?.textContent?.trim() || '';
      const gen = codeText.startsWith('—') ? null : codeText;
      return { date: ins[0].value, qty:Number(ins[1].value||0), unit_cost:Number(ins[2].value||0),
        commission_pct:Number(ins[3].value||0)||null, note: ins[4].value||null, batch_code: gen };
    }).filter(e => e.qty>0 && e.unit_cost>0);
    if(!entries.length){ setNote('Добавьте хотя бы одну строку партии.'); return; }
    try{
      await fetchJSON('/products/db/price-batches/'+encodeURIComponent(sku), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({entries})
      });
      setNote('Партии сохранены.', true); openDetail(row);
    }catch(e){ setNote('Сохранение партий не удалось: ' + e.message); }
  };

  qs('#btnRecount', mount).onclick = async ()=>{
    try{ const res = await fetchJSON('/products/batches/recount-sold', {method:'POST'}); setNote(`Пересчёт списаний выполнен (затронуто партий: ${res.updated_batches||0}).`, true); openDetail(row); }
    catch(e){ setNote('Пересчёт не удался: ' + e.message); }
  };
}

/* ───────── init ───────── */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    const ping = await fetchJSON('/products/db/ping');
    const backend = ping?.driver ? ('db=' + ping.driver) : (ping?.db_path || '');
    setNote('Бэкенд OK (integrity=' + (ping.ok ? 'ok':'fail') + '; ' + backend + ')', true);
  }catch(e){ setNote('Не найден /products/db/ping. Проверь main.py -> include_router(..., prefix="/products").'); }

  setDefaultDates(); attachSorting();

  // вкладки
  qs('#tabIn').onclick = ()=>{ _view='in'; qs('#tabIn').classList.add('active'); qs('#tabOut').classList.remove('active'); renderProducts(window._productsCache||[]); };
  qs('#tabOut').onclick= ()=>{ _view='out';qs('#tabOut').classList.add('active'); qs('#tabIn').classList.remove('active'); renderProducts(window._productsCache||[]); };

  // низкий остаток
  qs('#lowThreshold').value = getLow();
  qs('#lowThreshold').addEventListener('change', e => { setLow(e.target.value); renderProducts(window._productsCache||[]); });

  qs('#btnLoadDb').onclick  = loadDB;
  qs('#fileInput').addEventListener('change', async (e)=>{ const f = e.target.files?.[0]; if(!f) return; await importFile(f); e.target.value = ''; });
  qs('#btnFindSku').onclick = ()=>{
    const sku = qs('#findSku').value.trim(); if(!sku) return;
    const row = qsa('#tbl tbody tr').find(tr => (tr.dataset.sku||tr.cells[0].textContent.trim()) === sku);
    if(!row){ setNote('SKU не найден. Нажми «Загрузить из БД».'); return; }
    row.scrollIntoView({behavior:'smooth', block:'center'}); openDetail(row);
  };
  qs('#tbl').addEventListener('click', (e)=>{
    const btn1 = e.target.closest('.btn-parties'); if(btn1) { openDetail(btn1.closest('tr')); return; }
    const btn2 = e.target.closest('.btn-history'); if(btn2) { openDetail(btn2.closest('tr')); return; }
  });

  qs('#btnSaveDb').onclick = async ()=>{
    const rows = tableToRows(); if(!rows.length){ setNote('Нет строк для сохранения. Сначала импортируйте файл или загрузите БД.'); return; }
    const merge = qs('#mergeMode')?.checked; const priceOnly = qs('#priceOnly')?.checked;
    try{
      let payload = rows, msgExtra = '';
      if (merge){
        const p = new URLSearchParams({ active_only:'0', page:'1', page_size:'20000' });
        const dbAll = await fetchJSON('/products/db/list?'+p.toString()).then(x=>x.items||[]);
        const map = new Map(dbAll.map(o => [String(o.code), {...o}]));
        let added=0, updated=0;
        for (const r of rows){
          const key = String(r.code || '').trim(); if (!key) continue;
          if (map.has(key)){
            const o = map.get(key);
            o.name = r.name || o.name; o.brand = r.brand ?? o.brand; o.category = r.category ?? o.category;
            if (typeof r.price === 'number') o.price = r.price;
            if (!priceOnly){ if (typeof r.qty === 'number') o.qty = r.qty; if (typeof r.active === 'boolean') o.active = r.active; }
            map.set(key, o); updated++;
          } else {
            map.set(key, { code:key, name:r.name||key, brand:r.brand??null, category:r.category??null, price:typeof r.price==='number'?r.price:0, qty:0, active:true }); added++;
          }
        }
        payload = [...map.values()]; msgExtra = ` Режим MERGE: обновлено цен у ${fmt(updated)}, добавлено новых ${fmt(added)}, всего в БД станет ${fmt(payload.length)}.`;
      }
      const res = await fetchJSON('/products/db/bulk-upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      setNote(`Сохранено в БД: вставлено ${fmt(res.inserted||0)}, обновлено ${fmt(res.updated||0)}.${msgExtra}`, true);
      await loadDB();
    }catch(e){ setNote('Сохранение в БД не удалось: ' + e.message); }
  };

  // история
  qs('#btnHistLoad').onclick = async ()=>{ await loadHistoryRange(); await recomputeRecommendations(); };
  qs('#btnHistRefresh').onclick = async ()=>{ await loadHistoryRange(); await recomputeRecommendations(); };

  // FIFO и сигналы
  qs('#fifo-run').onclick = runFIFO;
  qs('#btnCalcCost').onclick = computeStockValueFromApi;

  await loadDB();
  await refreshSignals();
  await loadHistoryRange();
  await recomputeRecommendations();
});
</script>

<!-- X-API-Key инжектор -->
<script>
(()=> {
  const KEY = "KASPI_API_KEY";
  window.KASPI_API_KEY = localStorage.getItem(KEY) || "";

  const _origFetch = window.fetch.bind(window);
  window.fetch = function(input, init) {
    try{
      let urlStr = typeof input === "string" ? input : (input && input.url) || "";
      if (urlStr.startsWith("/products/") || urlStr.startsWith("/profit/")) {
        init = init || {};
        const k = window.KASPI_API_KEY || "";
        let headers = init.headers instanceof Headers ? init.headers : new Headers(init.headers || {});
        if (k) headers.set("X-API-Key", k);
        init.headers = headers;
        if (k) {
          const u = new URL(urlStr, location.origin);
          if (!u.searchParams.has("api_key")) u.searchParams.set("api_key", k);
          if (typeof input === "string") input = u.pathname + u.search;
          else input = new Request(u.toString(), init);
        }
      }
    }catch(e){}
    return _origFetch(input, init);
  };
  window.setApiKey = function(k){ localStorage.setItem(KEY, k || ""); window.KASPI_API_KEY = k || ""; console.log("API key set"); };
})();
</script>
</body>
</html>
