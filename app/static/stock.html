<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .details-row td{background:var(--surface-2,#fafafa);padding:12px 16px}
    .mini-table{width:100%;border-collapse:collapse}
    .mini-table th,.mini-table td{border-bottom:1px solid rgba(0,0,0,.06);padding:6px 8px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;font-size:12px}
    .clickable{cursor:pointer}
    .btn.small{padding:4px 8px;font-size:12px}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a class="nav-item" href="index.html">Главная</a>
        <a class="nav-item" href="stock.html">Мой склад</a>
        <a class="nav-item" href="#">Предзаказ</a>
        <a class="nav-item" href="#">Демпинг</a>
        <a class="nav-item" href="#">WhatsApp Рассылка</a>
      </nav>
      <div class="theme-switch">
        <label class="switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>Тёмная тема</span>
      </div>
    </aside>

    <div class="content">
      <h1>Мой склад</h1>

      <section class="shell">
        <div class="filters">
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <label class="chk"><input type="checkbox" id="onlyActive" checked> Только активные</label>
            <label>Поиск</label>
            <input type="text" id="search" placeholder="Название или код...">
            <button class="btn" id="btnLoad">Загрузить (API)</button>
            <label class="btn" for="fileInput">Импорт из файла (XML/XLSX)</label>
            <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
            <button class="btn" id="btnExport">Экспорт CSV (из таблицы)</button>

            <!-- работа с локальной БД -->
            <button class="btn" id="btnLoadDB">Загрузить из БД</button>
            <a class="btn" id="btnBackup" href="/products/db/backup.sqlite3">Бэкап БД</a>
            <label class="btn" for="restoreInput">Восстановить БД</label>
            <input type="file" id="restoreInput" accept=".sqlite,.sqlite3" style="display:none">
          </div>
        </div>

        <div id="note" class="muted" style="margin:6px 0 10px"></div>

        <div class="muted" style="margin:6px 0 10px">
          Для расчёта прибыли укажи партии закупок (под строкой товара). Средняя закупочная берётся из БД.
        </div>

        <div class="shell" style="padding:0">
          <div style="overflow:auto; max-height:70vh">
            <table class="table" id="tbl">
              <thead>
                <tr>
                  <th style="min-width:110px">Код</th>
                  <th style="min-width:260px">Название</th>
                  <th>Бренд</th>
                  <th>Категория</th>
                  <th>ШТ</th>
                  <th>Цена, KZT</th>
                  <th>Активен</th>
                  <th>ШК</th>
                  <th>Закупочная, KZT</th>
                  <th>Маржа, %</th>
                  <th>Прибыль, KZT</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="10" style="text-align:right;font-weight:700">Итого прибыль:</td>
                  <td id="sumProfit" style="font-weight:800">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Math.round((Number(n)||0)*100)/100);
const marginPercent = (price, cost) => {
  price = Number(price)||0; cost = Number(cost)||0;
  return price ? ((price - cost)/price*100) : 0;
};

async function loadProducts(){
  const onlyActive = document.getElementById('onlyActive').checked;
  const q = document.getElementById('search').value.trim();
  const qs = new URLSearchParams({active: (onlyActive?1:0), page: 1, page_size: 2000});
  if(q) qs.set('q', q);

  const [catalogRes, dbRes] = await Promise.all([
    fetch(`/products/list?${qs.toString()}`),
    fetch(`/products/db/list?active_only=${onlyActive?1:0}&search=${encodeURIComponent(q)}`)
  ]);
  const catalog = await catalogRes.json();
  const db = await dbRes.json();

  const avgMap = {};
  (db.items || []).forEach(it => { if (it.avg_cost != null) avgMap[it.code] = it.avg_cost; });

  if(catalog.note){ document.getElementById('note').textContent = catalog.note; }
  renderTable(catalog.items || [], avgMap);
}

async function loadFromDB(){
  const onlyActive = document.getElementById('onlyActive').checked;
  const q = document.getElementById('search').value.trim();
  const data = await fetch(`/products/db/list?active_only=${onlyActive?1:0}&search=${encodeURIComponent(q)}`).then(r=>r.json());
  const avgMap = {};
  (data.items || []).forEach(it => { if (it.avg_cost != null) avgMap[it.code] = it.avg_cost; });
  // преобразуем к единому формату
  const items = (data.items||[]).map(it => ({
    id: it.code,
    code: it.code,
    name: it.name,
    brand: it.brand,
    category: it.category,
    qty: it.qty,
    price: it.price,
    active: it.active,
    barcode: it.barcode
  }));
  renderTable(items, avgMap);
}

function renderTable(items, avgMap){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  let sumProfit = 0;

  for(const it of items){
    // ключ: code -> id -> barcode (чтобы не было пустых SKU)
    const key = it.code || it.id || it.barcode || '';
    const shownCode = it.code || it.id || '';

    const avg = avgMap[key] ?? 0;
    const profit = (Number(it.price)||0) - avg;
    const totalProfit = (Number(it.qty)||0) * profit;
    sumProfit += totalProfit;

    const tr = document.createElement('tr');
    tr.setAttribute('data-sku', key);
    tr.setAttribute('data-name', it.name || shownCode);
    tr.classList.add('clickable');
    tr.innerHTML = `
      <td>${shownCode}</td>
      <td>${it.name||''}</td>
      <td>${it.brand||''}</td>
      <td>${it.category||''}</td>
      <td>${fmt(it.qty||0)}</td>
      <td>${fmt(it.price||0)}</td>
      <td>${it.active===true ? 'Да' : it.active===false ? 'Нет' : ''}</td>
      <td>${it.barcode||''}</td>
      <td><input data-role="avg" type="number" value="${avg}" step="0.01" readonly style="width:120px"><span class="chip" style="margin-left:6px">цены</span></td>
      <td data-role="margin">${fmt(marginPercent(it.price, avg))}</td>
      <td data-role="profit">${fmt(totalProfit)}</td>
    `;
    tb.appendChild(tr);
  }

  document.getElementById('sumProfit').textContent = fmt(sumProfit);
}

// постоянный делегированный обработчик
document.querySelector('#tbl tbody').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr[data-sku]');
  if(!tr) return;
  if(e.target.closest('input')) return;
  await toggleDetails(tr);
});

function closeDetails(tr){
  const next = tr.nextElementSibling;
  if(next && next.classList.contains('details-row')) next.remove();
}

async function toggleDetails(tr){
  const sku = (tr.getAttribute('data-sku')||'').trim();
  const name = tr.getAttribute('data-name') || sku;
  if(!sku){ alert('У товара нет кода/sku — некуда сохранять партии.'); return; }

  const already = tr.nextElementSibling;
  if(already && already.classList.contains('details-row')){ already.remove(); return; }
  closeDetails(tr);

  const det = document.createElement('tr');
  det.className = 'details-row';
  det.innerHTML = `<td colspan="11"><div id="d-body">Загрузка партий...</div></td>`;
  tr.after(det);

  const data = await fetch(`/products/db/price-batches/${encodeURIComponent(sku)}`).then(r=>r.json());
  renderDetails(det.querySelector('#d-body'), sku, name, data, tr);
}

function renderDetails(container, sku, name, data, hostRow){
  container.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <div style="font-weight:700;">Партии закупок — ${name}</div>
      <div style="font-size:12px; color:#666;">Средняя закупочная: <b id="avgVal">${data.avg_cost ?? '—'}</b></div>
    </div>
    <table class="mini-table">
      <thead><tr><th>№ партии</th><th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Прим.</th><th style="width:80px"></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="btn small" data-action="add">+ Добавить</button>
      <button class="btn small" data-action="save">Сохранить</button>
    </div>
  `;

  const tbody = container.querySelector('tbody');
  for(const r of (data.batches||[])){
    tbody.appendChild(makeMiniRow(r.batch_no || '', r.date, r.qty, r.unit_cost, r.note));
  }

  container.addEventListener('click', async (e)=>{
    const action = e.target.getAttribute('data-action');
    if(action === 'add'){
      const maxNo = [...tbody.querySelectorAll('tr')].reduce((m,tr)=>{
        const v = Number(tr.querySelector('[name="batch_no"]').value||0);
        return Math.max(m, v);
      }, 0);
      tbody.appendChild(makeMiniRow(maxNo?maxNo+1:'', new Date().toISOString().slice(0,10), '', '', ''));
    }
    if(action === 'del'){
      e.target.closest('tr').remove();
    }
    if(action === 'save'){
      const payload = gatherMini(tbody);
      if(!payload.entries.length){ alert('Заполните хотя бы одну партию'); return; }
      const res = await fetch(`/products/db/price-batches/${encodeURIComponent(sku)}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json());
      container.querySelector('#avgVal').textContent = res.avg_cost ?? '—';
      // обновим строку таблицы
      const avgInput = hostRow.querySelector('input[data-role="avg"]');
      avgInput.value = res.avg_cost ?? 0;
      const price = Number(hostRow.children[5].textContent.replace(/\s/g,'') || 0);
      const qty   = Number(hostRow.children[4].textContent.replace(/\s/g,'') || 0);
      hostRow.querySelector('[data-role="margin"]').textContent = fmt(marginPercent(price, res.avg_cost||0));
      hostRow.querySelector('[data-role="profit"]').textContent = fmt((price - (res.avg_cost||0)) * qty);
    }
  });
}

function makeMiniRow(batch_no, date, qty, unit_cost, note){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="batch_no" type="number" step="1" value="${batch_no ?? ''}" style="width:90px"></td>
    <td><input name="date" type="date" value="${date || new Date().toISOString().slice(0,10)}"></td>
    <td><input name="qty"  type="number" min="0" step="1" value="${qty ?? ''}" style="width:90px"></td>
    <td><input name="unit_cost" type="number" min="0" step="0.01" value="${unit_cost ?? ''}" style="width:110px"></td>
    <td><input name="note" type="text" value="${note ?? ''}"></td>
    <td><button class="btn small" data-action="del">Удалить</button></td>
  `;
  return tr;
}

function gatherMini(tbody){
  const entries = [...tbody.querySelectorAll('tr')].map(tr=>{
    const g = n => tr.querySelector(`[name="${n}"]`).value;
    return {
      batch_no: Number(g('batch_no')||0) || null,
      date: g('date') || new Date().toISOString().slice(0,10),
      qty: Number(g('qty')||0),
      unit_cost: Number(g('unit_cost')||0),
      note: g('note') || null
    };
  }).filter(e => e.qty>0 && e.unit_cost>0);
  return { entries };
}

async function uploadManual(file){
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/products/manual-upload', { method: 'POST', body: fd });
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    alert('Ошибка: '+(err.detail || ('HTTP '+res.status)));
    return;
  }
  const data = await res.json();
  renderTable(data.items || [], {}); // среднюю можно подмешать после кнопки "Загрузить из БД"
  const note = document.getElementById('note');
  if(note){ note.textContent = `Файл загружен: ${file.name}. Позиций: ${data.count||0}`; }
}

function exportCsvFromTable(){
  const rows = [];
  const header = ["code","name","brand","category","qty","price","active","barcode","avg_cost","margin_percent","profit_total"];
  rows.push(header);
  const tb = document.querySelector('#tbl tbody');
  tb.querySelectorAll('tr[data-sku]').forEach(tr => {
    const td = Array.from(tr.children).map(x => x.textContent);
    const avg = Number(tr.querySelector('input[data-role="avg"]').value||0);
    const price = Number((td[5]||'0').replace(/\s/g,''));
    const qty   = Number((td[4]||'0').replace(/\s/g,''));
    const margin = marginPercent(price, avg);
    const profit = (price - avg) * qty;
    rows.push([td[0],td[1],td[2],td[3],qty,price,td[6],td[7],avg,margin,profit]);
  });
  const esc = s => { s=(s??'').toString(); return /[",\n,]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; };
  const csv = rows.map(r => r.map(esc).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products-table.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

async function restoreDB(file){
  const fd = new FormData(); fd.append('file', file);
  const r = await fetch('/products/db/restore', {method:'POST', body: fd});
  if(!r.ok){ alert('Не удалось восстановить БД'); return; }
  alert('БД восстановлена'); loadFromDB();
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnLoad').addEventListener('click', loadProducts);
  document.getElementById('btnLoadDB').addEventListener('click', loadFromDB);
  document.getElementById('btnExport').addEventListener('click', exportCsvFromTable);

  const fi = document.getElementById('fileInput');
  fi.addEventListener('change', async ()=>{ if(fi.files && fi.files[0]){ await uploadManual(fi.files[0]); fi.value=''; } });

  const rfi = document.getElementById('restoreInput');
  rfi.addEventListener('change', async ()=>{ if(rfi.files && rfi.files[0]){ await restoreDB(rfi.files[0]); rfi.value=''; } });

  const t = document.getElementById('themeToggle');
  if(t){ t.addEventListener('change', (e)=> document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light')); }

  loadProducts();
});
</script>
</body>
</html>
