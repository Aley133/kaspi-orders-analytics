<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой склад — Kaspi</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a class="nav-item" href="index.html">Главная</a>
        <a class="nav-item active" href="stock.html">Мой склад</a>
        <a class="nav-item" href="#">Предзаказ</a>
        <a class="nav-item" href="#">Демпинг</a>
        <a class="nav-item" href="#">WhatsApp Рассылка</a>
      </nav>
      <div class="theme-switch">
        <label class="switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>Тёмная тема</span>
      </div>
    </aside>

    <div class="content">
      <h1>Мой склад</h1>

      <section class="shell">
        <div class="filters">
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <label class="chk"><input type="checkbox" id="onlyActive" checked> Только активные</label>
            <label>Поиск</label>
            <input type="text" id="search" placeholder="Название или код..." style="min-width:260px">
            <button class="btn" id="btnLoad">Загрузить</button>
            <button class="btn" id="btnLoadDB">Загрузить из БД</button>
            <label class="btn" for="fileInput">Импорт из файла (XML/XLSX)</label>
            <input type="file" id="fileInput" accept=".xml,.xlsx,.xls" style="display:none">
            <button class="btn" id="btnSaveToDB">Сохранить в БД</button>
            <button class="btn" id="btnExport">Экспорт CSV (из таблицы)</button>
          </div>
        </div>

        <div id="note" class="muted" style="margin:6px 0 10px"></div>

        <div class="muted" style="margin:6px 0 10px">
          Для расчёта прибыли укажи закупочную цену (KZT). Теперь можно хранить <b>несколько партий</b> для позиции
          (дата, кол-во, закупка). Средняя закупочная считается автоматически.
        </div>

        <div class="shell" style="padding:0">
          <div style="overflow:auto; max-height:70vh">
            <table class="table" id="tbl">
              <thead>
                <tr>
                  <th style="min-width:110px">Код</th>
                  <th style="min-width:360px">Название</th>
                  <th>Бренд</th>
                  <th>Категория</th>
                  <th>ШТ</th>
                  <th>Цена, KZT</th>
                  <th>Активен</th>
                  <th>ШК</th>
                  <th>Закупочная, KZT</th>
                  <th>Маржа, %</th>
                  <th>Прибыль, KZT</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="10" style="text-align:right;font-weight:700">Итого прибыль:</td>
                  <td id="sumProfit" style="font-weight:800">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
let currentItems = []; // что сейчас в таблице
const nf = new Intl.NumberFormat('ru-RU');
const fmt = n => nf.format(Math.round((Number(n)||0)*100)/100);

function getCostLocal(id){
  const m = JSON.parse(localStorage.getItem('purchase_costs') || '{}');
  return Number(m[id] || 0);
}
function setCostLocal(id, v){
  const m = JSON.parse(localStorage.getItem('purchase_costs') || '{}');
  m[id] = Number(v)||0;
  localStorage.setItem('purchase_costs', JSON.stringify(m));
}

async function loadProducts(){
  const onlyActive = document.getElementById('onlyActive').checked;
  const q = document.getElementById('search').value.trim();
  const p = new URLSearchParams();
  p.set('active', onlyActive ? '1' : '0');
  if(q) p.set('q', q);
  p.set('page', '1'); p.set('page_size', '2000');
  const r = await fetch(`/products/list?${p.toString()}`);
  const data = await r.json();
  if(data.note){ document.getElementById('note').textContent = data.note; }
  currentItems = data.items || [];
  renderTable(currentItems);
  // подхватить средние закупочные из БД
  try { await hydrateAvgCostsFromDB(currentItems); } catch(e){}
}

async function hydrateAvgCostsFromDB(items){
  // тянем список из БД и маппим avg_cost по sku
  const res = await fetch(`/products/db/list?active_only=0&search=`);
  const db = await res.json();
  const set = new Set(items.map(it => (it.code || it.id || '').toString()));
  const map = {};
  (db.items || []).forEach(it => {
    if (it.avg_cost != null && set.has((it.code||'').toString())) {
      map[it.code] = it.avg_cost;
    }
  });
  applyAvgCostsToTable(map);
}

function renderTable(items){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  let sumProfit = 0;

  for(const it of items){
    const sku = (it.code || it.id || '').toString();
    const cost = getCostLocal(sku);
    const price = Number(it.price)||0;
    const qty = Number(it.qty)||0;
    const profitOne = price - cost;
    const totalProfit = qty * profitOne;
    sumProfit += totalProfit;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${sku}</td>
      <td>${(it.name||'').toString()}</td>
      <td>${it.brand||''}</td>
      <td>${it.category||''}</td>
      <td>${fmt(qty)}</td>
      <td>${fmt(price)}</td>
      <td>${it.active===true ? 'Да' : it.active===false ? 'Нет' : ''}</td>
      <td>${it.barcode||''}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <input data-sku="${sku}" class="cost-input" type="number" min="0" step="1" value="${cost}" style="width:120px">
          <button class="btn btn-batches" data-sku="${sku}">Цены</button>
        </div>
      </td>
      <td>${fmt(price ? ((price - cost)/price*100) : 0)}</td>
      <td>${fmt(totalProfit)}</td>
    `;
    tb.appendChild(tr);
  }

  document.getElementById('sumProfit').textContent = fmt(sumProfit);

  // события
  tb.querySelectorAll('input.cost-input').forEach(inp => {
    inp.addEventListener('change', () => {
      const sku = inp.getAttribute('data-sku');
      setCostLocal(sku, Number(inp.value)||0);
      renderTable(currentItems); // пересчитать строку и итог
    });
  });
  tb.querySelectorAll('.btn-batches').forEach(btn => {
    btn.addEventListener('click', () => {
      const sku = btn.getAttribute('data-sku');
      const row = btn.closest('tr');
      const title = row?.children?.[1]?.textContent?.trim() || sku;
      openBatchesModal(sku, title);
    });
  });
}

function exportCsvFromTable(){
  const rows = [];
  const header = ["code","name","brand","category","qty","price","active","barcode","cost","margin_percent","profit_total"];
  rows.push(header);
  const tb = document.querySelector('#tbl tbody');
  tb.querySelectorAll('tr').forEach(tr => {
    const td = Array.from(tr.children).map(x => x.textContent);
    const input = tr.querySelector('input.cost-input');
    const cost = input ? Number(input.value||0) : 0;
    const price = Number((td[5]||'0').replace(/\s/g,'')); // Цена
    const qty   = Number((td[4]||'0').replace(/\s/g,'')); // ШТ
    const margin = price ? ((price - cost)/price*100) : 0;
    const profit = (price - cost) * qty;
    rows.push([td[0],td[1],td[2],td[3],qty,price,td[6],td[7],cost,margin,profit]);
  });
  const esc = s => { s=(s??'').toString(); return /[",\n,]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; };
  const csv = rows.map(r => r.map(esc).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products-table.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

async function uploadManual(file){
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/products/manual-upload', { method: 'POST', body: fd });
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error(err.detail || ('HTTP '+res.status));
  }
  const data = await res.json();
  currentItems = data.items || [];
  renderTable(currentItems);
  try { await hydrateAvgCostsFromDB(currentItems); } catch(e){}
  const note = document.getElementById('note');
  if(note){ note.textContent = `Файл загружен: ${file.name}. Позиций: ${data.count||0}`; }
}

async function saveCurrentTableToDB(){
  if (!currentItems.length) return alert('Нет данных для сохранения');
  const payload = { items: currentItems.map(x => ({
    code: x.code || x.id || '',
    name: x.name || x.model || x.title || '',
    brand: x.brand || x.vendor || null,
    category: x.category || null,
    price: x.price || 0,
    quantity: x.qty || x.quantity || 0,
    active: (x.active===true) ? 1 : (x.active===false ? 0 : 1),
    barcode: x.barcode || null,
  })) };
  const r = await fetch('/products/db/upsert', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  if(r.ok){ alert(`Сохранено в БД: ${data.count||0}`); }
  else { alert('Ошибка: ' + (data.detail||r.status)); }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnLoad').addEventListener('click', loadProducts);
  document.getElementById('btnExport').addEventListener('click', exportCsvFromTable);
  document.getElementById('btnSaveToDB').addEventListener('click', saveCurrentTableToDB);
  document.getElementById('btnLoadDB').addEventListener('click', async () => {
    const onlyActive = document.getElementById('onlyActive').checked ? 1 : 0;
    const search = document.getElementById('search').value.trim();
    const r = await fetch(`/products/db/list?active_only=${onlyActive}&search=${encodeURIComponent(search)}`);
    const data = await r.json();
    currentItems = data.items || [];
    renderTable(currentItems);
  });

  const fi = document.getElementById('fileInput');
  fi.addEventListener('change', async ()=>{ if(fi.files && fi.files[0]){ try{ await uploadManual(fi.files[0]); } catch(e){ alert('Ошибка: '+e.message); } fi.value=''; }});

  const t = document.getElementById('themeToggle');
  if(t){ t.addEventListener('change', (e)=> document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light')); }

  loadProducts();
});

/* ======== Модалка партий закупок ======== */
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];
const modal = document.createElement('div');
modal.id = 'batchesModal';
modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; z-index:9999;';
modal.innerHTML = `
  <div style="background:var(--bg,#fff); padding:16px; border-radius:10px; width:640px; max-height:80vh; overflow:auto;">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3 id="bmTitle" style="margin:0;">Партии закупок</h3>
      <button id="bmClose" class="btn">×</button>
    </div>
    <div id="bmBody" style="margin-top:12px;">
      <table id="bmTable" class="table">
        <thead><tr><th>Дата</th><th>Кол-во</th><th>Закуп., KZT</th><th>Прим.</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="bmAddRow" class="btn">+ Добавить</button>
      <div style="margin-top:8px; font-size:12px; color:#666;">Средняя закупочная: <b id="bmAvg">—</b></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button id="bmSave" class="btn">Сохранить</button>
    </div>
  </div>`;
document.body.appendChild(modal);

let currentSKU = null;
function openBatchesModal(sku, title){
  currentSKU = sku;
  qs('#bmTitle').textContent = `Партии закупок — ${title || sku}`;
  const tbody = qs('#bmTable tbody'); tbody.innerHTML = '';
  qs('#bmAvg').textContent = '—';
  modal.style.display = 'flex';
  fetch(`/products/db/price-batches/${encodeURIComponent(sku)}`)
    .then(r => r.json())
    .then(data => {
      (data.batches||[]).forEach(addRowFromData);
      qs('#bmAvg').textContent = (data.avg_cost != null) ? data.avg_cost : '—';
    })
    .catch(console.error);
}
function closeBatchesModal(){ modal.style.display='none'; currentSKU=null; }
qs('#bmClose').onclick = closeBatchesModal;
qs('#bmAddRow').onclick = () => addRowFromData({});

function addRowFromData(row){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${row.date || new Date().toISOString().slice(0,10)}" /></td>
    <td><input type="number" min="0" step="1" value="${row.qty ?? ''}" style="width:90px"/></td>
    <td><input type="number" min="0" step="0.01" value="${row.unit_cost ?? ''}" style="width:110px"/></td>
    <td><input type="text" value="${row.note ?? ''}" /></td>
    <td>${row.id ? `<button class="btn btn-del" data-id="${row.id}">Удалить</button>` : ''}</td>
  `;
  qs('#bmTable tbody').appendChild(tr);
}

function gatherPayload(){
  const entries = qsa('#bmTable tbody tr').map(tr => {
    const [dEl,qEl,cEl,nEl] = qsa('input', tr);
    return {
      date: dEl.value || new Date().toISOString().slice(0,10),
      qty: Number(qEl.value||0),
      unit_cost: Number(cEl.value||0),
      note: nEl.value || null,
    };
  }).filter(e => e.qty>0 && e.unit_cost>0);
  return { entries };
}
qs('#bmSave').onclick = () => {
  if(!currentSKU) return;
  fetch(`/products/db/price-batches/${encodeURIComponent(currentSKU)}`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(gatherPayload())
  })
  .then(r=>r.json())
  .then(data=>{
    const avg = data.avg_cost != null ? Number(data.avg_cost) : 0;
    // применим новую среднюю закупочную в таблице
    const map = {}; map[currentSKU] = avg;
    applyAvgCostsToTable(map);
    closeBatchesModal();
  })
  .catch(console.error);
};

qs('#bmTable tbody').addEventListener('click', (e)=>{
  const btn = e.target.closest('.btn-del');
  if(!btn || !currentSKU) return;
  const id = btn.dataset.id;
  fetch(`/products/db/price-batches/${encodeURIComponent(currentSKU)}/${id}`, { method:'DELETE' })
    .then(r=>r.json())
    .then(data=>{
      btn.closest('tr').remove();
      const map = {}; map[currentSKU] = (data.avg_cost!=null?Number(data.avg_cost):0);
      applyAvgCostsToTable(map);
      qs('#bmAvg').textContent = (data.avg_cost!=null)?data.avg_cost:'—';
    })
    .catch(console.error);
});

function applyAvgCostsToTable(avgMap){
  const rows = qsa('#tbl tbody tr');
  rows.forEach(tr => {
    const sku = tr.cells?.[0]?.textContent?.trim();
    const input = tr.querySelector('input.cost-input');
    if(!sku || !input) return;
    if(avgMap[sku] != null){
      input.value = avgMap[sku];
      setCostLocal(sku, avgMap[sku]);
    }
  });
  // пересчитать маржу/прибыль
  renderTable(currentItems);
}
</script>
</body>
</html>
