<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Настройки — Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body data-theme="light" style="padding:24px;max-width:920px;margin:auto">
  <h1>Настройки</h1>
  <p class="muted">Параметры используются аналитикой и синхронизацией.</p>

  <form id="form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div><label>Shop name</label><input name="shop_name" placeholder="LeoXpress"/></div>
    <div><label>Partner ID</label><input name="partner_id" placeholder=""/></div>

    <div style="grid-column:1/3"><label>KASPI_TOKEN</label><input name="kaspi_token" placeholder="kaspi_xxx" /></div>

    <div><label>Amount fields (CSV)</label><input name="amount_fields" value="totalPrice"/></div>
    <div><label>Amount divisor</label><input name="amount_divisor" type="number" step="0.0001" value="1"/></div>

    <div><label>Date field default</label><input name="date_field_default" value="creationDate"/></div>
    <div><label>Business day start (HH:MM)</label><input name="business_day_start" value="20:00"/></div>

    <div><label>Use business day</label><input type="checkbox" name="use_business_day" checked/></div>
    <div><label>Store accept until</label><input name="store_accept_until" value="17:00"/></div>

    <div><label>City keys (CSV)</label><input name="city_keys" value="city,deliveryAddress.city"/></div>
    <div><label>Allowed origins (CSV)</label><input name="allowed_origins" value=""/></div>
  </form>

  <div style="margin-top:16px;display:flex;gap:12px">
    <button id="save">Сохранить</button>
    <span id="msg" class="muted"></span>
  </div>

  <script src="./lib/auth.js" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', async () => {
  const $ = s => document.querySelector(s);
  const msg = $('#msg'); // <p id="msg">
  const btnSave  = $('#saveBtn');   // <button id="saveBtn">
  const btnCheck = $('#checkBtn');  // <button id="checkBtn">
  if (!btnSave || !btnCheck) { console.error('Buttons not found'); return; }

  const jwt = await Auth.getToken();
  if (!jwt) { location.href = '/ui/login.html'; return; }

  // Пробуем загрузить текущие настройки (404 — это нормально до первой записи)
  try {
    const r = await fetch('/settings/me', { headers: { Authorization: 'Bearer ' + jwt } });
    if (r.ok) {
      const data = await r.json();
      // TODO: проставь значения в поля формы из data.value
    } else if (r.status !== 404) {
      msg.textContent = 'Ошибка загрузки: ' + r.status;
    }
  } catch (e) { msg.textContent = 'Сеть: ' + e; }

  btnSave.addEventListener('click', async () => {
    const payload = {
      shop_name: $('#shopName').value || 'LeoXpress',
      partner_id: $('#partnerId').value || '',
      kaspi_token: $('#kaspiToken').value, // ОБЯЗАТЕЛЬНО реальный токен
      amount_fields: 'totalPrice',
      amount_divisor: 1,
      date_field_default: 'creationDate',
      business_day_start: '20:00',
      use_business_day: true,
      store_accept_until: '17:00',
      city_keys: 'city,deliveryAddress.city',
      allowed_origins: ''
    };
    msg.textContent = 'Сохраняю...';
    const r = await fetch('/settings/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + jwt },
      body: JSON.stringify(payload)
    });
    msg.textContent = r.ok ? 'Сохранено' : 'Ошибка сохранения: ' + r.status;
  });

  btnCheck.addEventListener('click', async () => {
    msg.textContent = 'Проверка...';
    const r = await fetch('/settings/check', { headers: { Authorization: 'Bearer ' + jwt } });
    msg.textContent = r.ok ? 'Kaspi: OK' : 'Kaspi: ' + r.status;
  });
});
</script>
  <script>
    const $ = s => document.querySelector(s);
    (async function init(){
      await Auth.getSession() || (window.location.href='/ui/login.html');
      try{
        const r = await Auth.authedFetch('/settings/me');
        if (r.ok){
          const data = await r.json();
          for (const [k,v] of Object.entries(data)){
            const el = document.querySelector(`[name="${k}"]`);
            if (!el) continue;
            if (el.type === 'checkbox') el.checked = !!v;
            else el.value = v ?? '';
          }
        }
      }catch(e){ console.warn(e); }
    })();

    function readForm(){
      const o={};
      for (const el of document.querySelectorAll('#form input')){
        o[el.name] = (el.type==='checkbox')?el.checked:el.value.trim();
      }
      return o;
    }

    $('#save').onclick = async () => {
      $('#msg').textContent = 'Сохраняю...';
      try{
        const r = await Auth.authedFetch('/settings/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(readForm())
        });
        if (!r.ok) throw new Error(await r.text());

        // быстрый self-check и переход на главную
        const check = await Auth.authedFetch('/settings/check');
        const ok = check.ok ? (await check.json()).ok : false;
        $('#msg').textContent = ok ? 'OK — перенаправляю...' : 'Сохранено, но токен не прошёл проверку';
        if (ok) setTimeout(()=> window.location.href = '/ui/', 600);
      }catch(e){
        $('#msg').textContent = 'Ошибка: ' + (e?.message || e);
      }
    };
  </script>

</body>
</html>
