<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* –ü–∞–ª–∏—Ç—Ä–∞ –∏ —Ç–æ–∫–µ–Ω—ã  ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π */
    :root{ --bg:#0b0c0f; --fg:#e5e7eb; --muted:#9ca3af; --line:#2a2f3a; --card:#111318; --accent:#10b981; --danger:#ef4444; --warn:#f59e0b; }
    [data-theme="light"]{ --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff; --accent:#059669; --danger:#dc2626; --warn:#d97706; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}
    a{color:inherit}
    .muted{color:var(--muted)}

    /* –æ–±—â–∏–π –∫–∞—Ä–∫–∞—Å */
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;border-right:1px solid var(--line);padding:16px;background:var(--card)}
    .content{flex:1;min-width:0;padding:16px 18px}

    .brand{font-weight:800;letter-spacing:.3px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px;margin:6px 0 16px}
    .nav a,.nav button{padding:6px 8px;border-radius:8px;color:var(--fg);text-decoration:none;background:transparent;border:0;text-align:left;cursor:pointer}
    .nav a:hover,.nav button:hover{background:var(--bg)}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{height:32px;padding:0 12px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent); color:#031225; border-color:#06744e}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    input,select{height:36px;padding:0 12px;background:var(--card);color:var(--fg);border:1px solid var(--line);border-radius:10px}

    .shell{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:16px;margin:16px 0}
    h1{margin:0 0 12px}

    .card h2{font-size:16px;margin:0 0 8px}
    .hint{font-size:12px;color:var(--muted);margin:-4px 0 10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;background:var(--card);font-size:12px}

    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .footer{display:flex;gap:10px;align-items:center;margin-top:10px}

    .dot{width:8px;height:8px;border-radius:50%;background:#9ca3af;display:inline-block}
    .dot.ok{background:var(--accent)} .dot.warn{background:var(--warn)} .dot.err{background:var(--danger)}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">‚ö° LeoXpress</div>
      <nav class="nav">
        <a href="index.html">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
        <a href="stock.html">–ú–æ–π —Å–∫–ª–∞–¥</a>
        <a href="settings.html" aria-current="page">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <button id="btnSignOut" class="btn">–í—ã—Ö–æ–¥</button>
      </nav>
      <div class="row">
        <label class="row" style="gap:8px"><input type="checkbox" id="themeToggle"> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</label>
      </div>
    </aside>

    <main class="content">
      <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <div class="muted">–≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π, –±–∏–∑–Ω–µ—Å-–¥–Ω—ë–º –∏ FIFO‚Äë–º–æ—Å—Ç–æ–º.</div>

      <div class="grid">
        <!-- –ü–†–û–§–ò–õ–¨: email/phone, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞ -->
        <section class="shell card">
          <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
          <div class="hint">–ï—Å–ª–∏ –≤–æ—à–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ‚Äî –¥–æ–±–∞–≤—å—Ç–µ e‚Äëmail; –µ—Å–ª–∏ –ø–æ e‚Äëmail ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω. –¢–∞–∫ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±–æ–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.</div>

          <div class="row" style="margin-bottom:8px">
            <span class="pill"><b>–¢–µ–∫—É—â–∏–π e‚Äëmail:</b> <span id="curEmail">‚Äî</span></span>
            <span class="pill"><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <span id="curPhone">‚Äî</span></span>
          </div>

          <div id="blockPhone" style="display:none">
            <div class="field"><label>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</label>
              <div class="row">
                <input id="newPhone" class="grow" placeholder="+7XXXXXXXXXX" inputmode="tel" />
                <button id="btnLinkPhone" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
                <input id="codePhone" placeholder="–ö–æ–¥ –∏–∑ SMS" inputmode="numeric" maxlength="6" style="width:140px" />
                <button id="btnVerifyPhone" class="btn primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              </div>
            </div>
          </div>

          <div id="blockEmail" style="display:none">
            <div class="field"><label>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å e‚Äëmail</label>
              <div class="row">
                <input id="newEmail" class="grow" placeholder="you@example.com" type="email" />
                <button id="btnLinkEmail" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
                <input id="codeEmail" placeholder="–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞" style="width:160px" />
                <button id="btnVerifyEmail" class="btn primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              </div>
            </div>
          </div>

          <div id="acctMsg" class="row" style="gap:8px"><span class="dot"></span><span>–ì–æ—Ç–æ–≤–æ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º.</span></div>
        </section>

        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥ -->
        <section class="shell card">
          <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
          <div class="hint">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å.</div>
          <div class="row">
            <button id="btnCheck" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            <span id="checkMsg" class="row" style="gap:8px"><span class="dot"></span><span>‚Äî</span></span>
          </div>
          <div class="row" style="margin-top:8px">
            <a href="/ui/">‚üµ –ù–∞ –≥–ª–∞–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</a>
          </div>
        </section>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞ / Kaspi / –ë–∏–∑–Ω–µ—Å‚Äë–¥–µ–Ω—å -->
      <section class="shell">
        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞ –∏ —Ä–∞—Å—á—ë—Ç–æ–≤</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <div class="field"><label>Shop name</label><input name="shop_name" placeholder="LeoXpress" /></div>
            <div class="field"><label>Partner ID</label><input name="partner_id" placeholder="" /></div>
            <div class="field"><label>KASPI_TOKEN</label>
              <div class="row">
                <input name="kaspi_token" placeholder="kaspi_xxx" type="password" class="grow" />
                <button id="togglePwd" type="button" class="btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω">üôà</button>
              </div>
            </div>
          </div>
          <div>
            <div class="field"><label>Amount fields (CSV)</label><input name="amount_fields" value="totalPrice" /></div>
            <div class="field"><label>Amount divisor</label><input name="amount_divisor" type="number" step="0.0001" value="1" /></div>
            <div class="field"><label>Date field default</label><input name="date_field_default" value="creationDate" /></div>
          </div>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <div class="field"><label>Business day start (HH:MM)</label><input name="business_day_start" value="20:00" /></div>
            <div class="row" style="justify-content:space-between"><label>Use business day</label><input type="checkbox" name="use_business_day" checked /></div>
          </div>
          <div>
            <div class="field"><label>Store accept until</label><input name="store_accept_until" value="17:00" /></div>
            <div class="field"><label>Allowed origins (CSV)</label><input name="allowed_origins" value="" /></div>
          </div>
        </div>

        <div class="field"><label>City keys (CSV)</label><input name="city_keys" value="city,deliveryAddress.city" /></div>

        <div class="footer">
          <button id="save" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span id="msg" class="muted">‚Äî</span>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { Auth } from './lib/auth.js';

    const $ = (s) => document.querySelector(s);
    const setDot = (el, cls, text) => { const dot=el.querySelector('.dot'); if(dot) dot.className='dot '+(cls||''); const span=el.querySelector('span:nth-child(2)'); if(span) span.textContent=text; };

    // ‚Äî –¢–µ–º–∞: —á–∏—Ç–∞–µ–º/–ø–∏—à–µ–º –≤ localStorage, –∫–∞–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
    const THEME_KEY = 'app.theme';
    const applyTheme = (t) => document.body.setAttribute('data-theme', t || 'light');
    applyTheme(localStorage.getItem(THEME_KEY) || document.body.getAttribute('data-theme') || 'light');
    const themeToggle = $('#themeToggle');
    if(themeToggle){ themeToggle.checked = (document.body.getAttribute('data-theme') !== 'light'); themeToggle.addEventListener('change', e => { const t=e.target.checked?'dark':'light'; applyTheme(t); localStorage.setItem(THEME_KEY, t); }); }

    // ‚Äî –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π fetch
    window.authedFetch = async (input, init = {}) => {
      await Auth.ready; const headers = { ...(init.headers||{}), ...(await Auth.authHeader()) };
      const res = await fetch(input, { ...init, headers });
      if(res.status===401){ await Auth.signOutAndGoLogin(); throw new Error('Unauthorized'); }
      return res;
    };
    const AF = window.authedFetch;

    await Auth.ready; await Auth.requireAuth();
    $('#btnSignOut')?.addEventListener('click', Auth.signOutAndGoLogin);

    const sb = Auth.sb || Auth.client || window.supabase;

    // ‚Äî –ü—Ä–æ—Ñ–∏–ª—å –∏ —É—Å–ª–æ–≤–Ω—ã–π UI: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å
    async function refreshWho(){
      const { data:{ user } } = await sb.auth.getUser();
      $('#curEmail').textContent = user?.email || '‚Äî';
      $('#curPhone').textContent = user?.phone || '‚Äî';
      // –µ—Å–ª–∏ –≤–æ—à–ª–∏ –ø–æ e‚Äëmail ‚Äî –ø—Ä—è—á–µ–º –±–ª–æ–∫ e‚Äëmail –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∞; –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
      const hasEmail = !!user?.email; const hasPhone = !!user?.phone;
      $('#blockEmail').style.display = hasEmail ? 'none' : 'block';
      $('#blockPhone').style.display = hasPhone ? 'none' : 'block';
    }
    await refreshWho();

    // ‚Äî –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ç–æ–∫–µ–Ω–∞
    $('#togglePwd')?.addEventListener('click', () => {
      const inp = document.querySelector('input[name="kaspi_token"]');
      if(!inp) return; const t = inp.type==='password' ? 'text' : 'password'; inp.type=t; $('#togglePwd').textContent = t==='password' ? 'üôà' : 'üëÅÔ∏è';
    });

    // ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    async function loadSettings(){
      const r = await AF('/settings/me'); const m = $('#msg');
      if(r.ok){ const data = await r.json(); document.querySelectorAll('input[name]').forEach(el=>{ const k=el.name; if(!(k in data)) return; if(el.type==='checkbox') el.checked=!!data[k]; else el.value=(data[k]??''); }); m.textContent='–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'; }
      else if(r.status===404){ $('#msg').textContent='–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.'; }
      else { $('#msg').textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+r.status; }
    }
    await loadSettings();

    // ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function collect(){ const out={}; document.querySelectorAll('input[name]').forEach(el=>{ if(el.type==='checkbox') out[el.name]=!!el.checked; else if(el.type==='number'){ const n=Number(el.value); out[el.name]=Number.isFinite(n)?n:null; } else out[el.name]=(el.value??'').trim(); }); return out; }
    async function save(){
      const payload = collect(); const m=$('#msg'); $('#save').disabled=true; m.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
      if(!payload.kaspi_token){ m.textContent='–£–∫–∞–∂–∏—Ç–µ KASPI_TOKEN'; $('#save').disabled=false; return; }
      const r = await AF('/settings/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      if(!r.ok){ m.textContent='–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(await r.text().catch(()=>r.status)); $('#save').disabled=false; return; }
      const chk = await AF('/settings/check');
      if(chk.ok){ m.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é‚Ä¶'; setTimeout(()=>location.href='/ui/', 600); }
      else { m.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–µ –ø—Ä–æ—à–ª–∞: '+chk.status; $('#save').disabled=false; }
    }
    $('#save').addEventListener('click', save);

    // ‚Äî –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    $('#btnCheck').addEventListener('click', async()=>{ setDot($('#checkMsg'),'','–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶'); const r=await AF('/settings/check'); if(r.ok) setDot($('#checkMsg'),'ok','–¢–æ–∫–µ–Ω –ø—Ä–∏–Ω—è—Ç (200)'); else setDot($('#checkMsg'),'err',`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (${r.status})`); });

    // ‚Äî –ü—Ä–∏–≤—è–∑–∫–∞/–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    $('#btnLinkPhone')?.addEventListener('click', async()=>{
      const phone = $('#newPhone').value.trim(); if(!phone.startsWith('+')) return setDot($('#acctMsg'),'warn','–§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ E.164 (+7‚Ä¶)');
      try{ const { error } = await sb.auth.updateUser({ phone }); if(error) throw error; setDot($('#acctMsg'),'ok','–ö–æ–¥ SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∏–∂–µ.'); }
      catch(e){ setDot($('#acctMsg'),'err','–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS: '+(e?.message||e)); }
    });
    $('#btnVerifyPhone')?.addEventListener('click', async()=>{
      const phone=$('#newPhone').value.trim(); const token=$('#codePhone').value.trim();
      try{ const { error } = await sb.auth.verifyOtp({ phone, token, type:'phone_change' }); if(error) throw error; setDot($('#acctMsg'),'ok','–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω.'); await refreshWho(); }
      catch(e){ setDot($('#acctMsg'),'err','–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω: '+(e?.message||e)); }
    });

    // ‚Äî –ü—Ä–∏–≤—è–∑–∫–∞/–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è e‚Äëmail
    $('#btnLinkEmail')?.addEventListener('click', async()=>{
      const email=$('#newEmail').value.trim(); if(!email.includes('@')) return setDot($('#acctMsg'),'warn','–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e‚Äëmail');
      try{ const { error } = await sb.auth.updateUser({ email }); if(error) throw error; setDot($('#acctMsg'),'ok','–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É. –í–≤–µ–¥–∏—Ç–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.'); }
      catch(e){ setDot($('#acctMsg'),'err','–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: '+(e?.message||e)); }
    });
    $('#btnVerifyEmail')?.addEventListener('click', async()=>{
      const email=$('#newEmail').value.trim(); const token=$('#codeEmail').value.trim();
      try{ const { error } = await sb.auth.verifyOtp({ email, token, type:'email_change' }); if(error) throw error; setDot($('#acctMsg'),'ok','E‚Äëmail –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω.'); await refreshWho(); }
      catch(e){ setDot($('#acctMsg'),'err','–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e‚Äëmail: '+(e?.message||e)); }
    });
  </script>
</body>
</html>
