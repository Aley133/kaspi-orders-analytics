<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Настройки магазина — Kaspi</title>
<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;max-width:720px;margin:32px auto;padding:0 16px}input,button{font:inherit;padding:10px 12px;border-radius:8px;border:1px solid #ddd}label{display:block;margin:10px 0}button{cursor:pointer}</style>
</head><body>
<h1>Первичная настройка</h1>
<ol>
<li><b>Partner ID</b> — числовой ID магазина в Kaspi (см. кабинет продавца → профиль/интеграция).</li>
<li><b>Kaspi Token</b> — токен доступа к API (кабинет продавца → интеграция → API токен).</li>
</ol>
<form id="f">
<label>Partner ID <input name="partner_id" type="number" required></label>
<label>Название магазина <input name="shop_name" type="text" placeholder="ИП Ромашка"></label>
<label>Kaspi Token <input name="kaspi_token" type="password" required></label>
<label>Город (city_id) <input name="city_id" type="number" placeholder="по желанию"></label>
<label>Начало бизнес-дня <input name="business_day_start" value="20:00"></label>
<label>Часовой пояс <input name="timezone" value="Asia/Almaty"></label>
<label>Мин. маржа, % <input name="min_margin_pct" type="number" step="0.01"></label>
<label>Автопереценка <input name="auto_reprice" type="checkbox"></label>
<div style="margin-top:12px"><button type="submit">Продолжить</button></div>
</form>


<script type="module">
import { fetchAuthed } from './lib/auth.js';
const qp = new URLSearchParams(location.search);
const next = qp.get('next') || '/ui/';
const form = document.getElementById('f');
form.addEventListener('submit', async (e) => {
e.preventDefault();
const fd = new FormData(form);
const payload = {
partner_id: fd.get('partner_id') ? Number(fd.get('partner_id')) : null,
shop_name: fd.get('shop_name') || null,
kaspi_token: fd.get('kaspi_token') || null,
city_id: fd.get('city_id') ? Number(fd.get('city_id')) : null,
business_day_start:fd.get('business_day_start') || null,
timezone: fd.get('timezone') || null,
min_margin_pct: fd.get('min_margin_pct') ? Number(fd.get('min_margin_pct')) : null,
auto_reprice: form.auto_reprice.checked,
};
const r = await fetchAuthed('/settings/me', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload),
});
if (!r.ok) return alert('Save failed: ' + await r.text());
location.href = next;
});
</script>
</body></html>
