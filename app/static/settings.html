<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Настройки — Kaspi Orders Analytics</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .container{max-width:820px;margin:24px auto;padding:16px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 2fr;gap:12px;align-items:center;margin-bottom:12px}
    label{font-weight:600}
    input,select{width:100%;padding:10px;border:1px solid #334155;border-radius:10px;background:#0b1220;color:#e5e7eb}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}
    button{padding:10px 16px;border-radius:10px;border:1px solid #334155;background:#1f7aee;color:#fff;cursor:pointer}
    .note{font-size:12px;color:#9ca3af}
    body{background:#0b1220;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  </style>
</head>
<body>
  <div class="container">
    <h1 style="color:#e5e7eb">Настройки магазина</h1>
    <p class="note">После входа укажите параметры Kaspi. Токен хранится в базе и больше не запрашивается.</p>

    <div class="card">
      <div class="row">
        <label for="partner_id">ID магазина (PARTNER_ID / MERCHANT_ID)</label>
        <input id="partner_id" type="number" placeholder="напр., 30295031"/>
      </div>
      <div class="row">
        <label for="shop_name">Название магазина</label>
        <input id="shop_name" type="text" placeholder="напр., LeoXpress"/>
      </div>
      <div class="row">
        <label for="kaspi_token">Kaspi API Token</label>
        <input id="kaspi_token" type="text" placeholder="вставьте токен (оставьте пустым, чтобы не менять)"/>
      </div>
      <div class="row">
        <label for="city_id">Город (city_id)</label>
        <input id="city_id" type="number" placeholder="напр., 196220100"/>
      </div>
      <div class="row">
        <label for="bds">Начало бизнес-дня</label>
        <input id="bds" type="time" value="20:00"/>
      </div>
      <div class="row">
        <label for="tz">Часовой пояс</label>
        <input id="tz" type="text" value="Asia/Almaty"/>
      </div>
      <div class="row">
        <label for="min_margin">Мин. маржа, %</label>
        <input id="min_margin" type="number" step="0.01" placeholder="напр., 10"/>
      </div>
      <div class="row">
        <label for="auto_reprice">Автопереоценка</label>
        <select id="auto_reprice">
          <option value="">Не менять</option>
          <option value="true">Включить</option>
          <option value="false">Выключить</option>
        </select>
      </div>

      <div class="actions">
        <button id="saveBtn">Сохранить</button>
      </div>
    </div>
  </div>
<script src="/ui/lib/auth.js"></script>
<script>
  async function requireSession() {
    const ok = await window.__auth.requireAuth();
    if (!ok) return null;
    return { access_token: window.__auth.getToken() };
  }
  function authHeader(session) {
    return { 'Authorization': `Bearer ${session.access_token}`, 'Content-Type': 'application/json' };
  }
  async function loadSettings(session) {
    const res = await window.__auth.authFetch('/settings/me');
    if (res.status === 404) return;
    const s = await res.json();
    if (s.partner_id) partner_id.value = s.partner_id;
    if (s.shop_name) shop_name.value = s.shop_name;
    if (s.kaspi_token_masked) kaspi_token.placeholder = s.kaspi_token_masked + ' (оставьте пустым, чтобы не менять)';
    if (s.city_id) city_id.value = s.city_id;
    if (s.business_day_start) bds.value = s.business_day_start;
    if (s.timezone) tz.value = s.timezone;
    if (s.min_margin_pct != null) min_margin.value = s.min_margin_pct;
    if (s.auto_reprice != null) auto_reprice.value = String(s.auto_reprice);
  }
  async function saveSettings(session) {
    const payload = {
      partner_id: partner_id.value ? Number(partner_id.value) : null,
      shop_name: shop_name.value || null,
      kaspi_token: kaspi_token.value || null,
      city_id: city_id.value ? Number(city_id.value) : null,
      business_day_start: bds.value || null,
      timezone: tz.value || null,
      min_margin_pct: min_margin.value ? Number(min_margin.value) : null,
      auto_reprice: auto_reprice.value === "" ? null : (auto_reprice.value === "true")
    };
    const res = await window.__auth.authFetch('/settings/me', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) { alert(await res.text()); return; }
    location.href = '/ui/';
  }
  (async () => {
    const session = await requireSession(); if (!session) return;
    await loadSettings(session);
    document.getElementById('saveBtn').addEventListener('click', () => saveSettings(session));
  })();
</script>
</body>
</html>
