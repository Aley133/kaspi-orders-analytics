<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { padding: 24px; max-width: 920px; margin: auto; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    form > div { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; opacity: .8; }
    .row { display: flex; gap: 12px; align-items: center; margin-top: 16px; }
    .note { margin-top: 8px; font-size: 13px; opacity: .9; }
    .muted { opacity: .7; }
    button { height: 34px; padding: 0 14px; border: 1px solid var(--line); background: var(--card); color: var(--fg); border-radius: 8px; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .pwd { display: flex; gap: 8px; align-items: center; }
  </style>
</head>
<body data-theme="light">
  <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
  <p class="muted">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π, –±–∏–∑–Ω–µ—Å-–¥–Ω—ë–º –∏ FIFO-–º–æ—Å—Ç–æ–º.</p>

  <form id="form">
    <div>
      <label>Shop name</label>
      <input name="shop_name" placeholder="LeoXpress" />
    </div>

    <div>
      <label>Partner ID</label>
      <input name="partner_id" placeholder="" />
    </div>

    <div style="grid-column: 1/3">
      <label>KASPI_TOKEN</label>
      <div class="pwd">
        <input name="kaspi_token" placeholder="kaspi_xxx" type="password" style="width: 100%" />
        <button id="togglePwd" type="button" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω">üôà</button>
      </div>
    </div>

    <div>
      <label>Amount fields (CSV)</label>
      <input name="amount_fields" value="totalPrice" />
    </div>

    <div>
      <label>Amount divisor</label>
      <input name="amount_divisor" type="number" step="0.0001" value="1" />
    </div>

    <div>
      <label>Date field default</label>
      <input name="date_field_default" value="creationDate" />
    </div>

    <div>
      <label>Business day start (HH:MM)</label>
      <input name="business_day_start" value="20:00" />
    </div>

    <div>
      <label>Use business day</label>
      <input type="checkbox" name="use_business_day" checked />
    </div>

    <div>
      <label>Store accept until</label>
      <input name="store_accept_until" value="17:00" />
    </div>

    <div>
      <label>City keys (CSV)</label>
      <input name="city_keys" value="city,deliveryAddress.city" />
    </div>

    <div>
      <label>Allowed origins (CSV)</label>
      <input name="allowed_origins" value="" />
    </div>
  </form>

  <div class="row">
    <button id="save" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <span id="msg" class="note muted"></span>
  </div>

  <!-- –ú–æ–¥—É–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç -->
  <script type="module">
    import { Auth } from './lib/auth.js';

    // --- –ù–∞–¥—ë–∂–Ω—ã–π authedFetch: –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É, –∂–¥—ë—Ç Auth –≤–Ω—É—Ç—Ä–∏ ---
    window.authedFetch = async (input, init = {}) => {
      await Auth.ready;
      try {
        const headers = { ...(init.headers || {}), ...(await Auth.authHeader()) };
        const res = await fetch(input, { ...init, headers });
        if (res.status === 401) {
          await Auth.signOutAndGoLogin();
          throw new Error('Unauthorized');
        }
        return res;
      } catch (e) {
        if (String(e?.message || e).includes('Unauthorized')) {
          await Auth.signOutAndGoLogin();
        }
        throw e;
      }
    };
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∞–ª–∏–∞—Å—ã
    window.AF = (...args) => window.authedFetch(...args);
    window.af = window.authedFetch;
    globalThis.authedFetch = window.authedFetch;
    globalThis.AF = window.AF;

    // –¢—Ä–µ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    await Auth.ready;
    await Auth.requireAuth();
    document.getElementById('btnSignOut')?.addEventListener('click', Auth.signOutAndGoLogin);

    // --- DOM helpers ---
    const $ = (s) => document.querySelector(s);
    const form    = $('#form');
    const msg     = $('#msg');
    const btnSave = $('#save');
    const btnEye  = $('#togglePwd');
    const kaspiIn = form.querySelector('input[name="kaspi_token"]');

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω
    btnEye?.addEventListener('click', () => {
      const t = kaspiIn.type === 'password' ? 'text' : 'password';
      kaspiIn.type = t;
      btnEye.textContent = t === 'password' ? 'üôà' : 'üëÅÔ∏è';
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    try {
      const r = await AF('/settings/me');
      if (r.ok) {
        const data = await r.json();
        for (const [k, v] of Object.entries(data)) {
          const el = form.querySelector(`[name="${k}"]`);
          if (!el) continue;
          if (el.type === 'checkbox') el.checked = !!v;
          else el.value = v ?? '';
        }
        msg.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
      } else if (r.status === 404) {
        msg.textContent = '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
      } else {
        msg.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + r.status;
      }
    } catch (e) {
      msg.textContent = '–°–µ—Ç—å: ' + (e?.message || e);
    }

    // –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ–º —Ç–∏–ø–æ–≤
    function readForm() {
      const out = {};
      form.querySelectorAll('input').forEach((el) => {
        if (!el.name) return;
        if (el.type === 'checkbox') {
          out[el.name] = !!el.checked;
        } else if (el.type === 'number') {
          const n = Number(el.value);
          out[el.name] = Number.isFinite(n) ? n : null;
        } else {
          out[el.name] = (el.value ?? '').trim();
        }
      });
      return out;
    }

    async function saveSettings() {
      btnSave.disabled = true;
      msg.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';

      try {
        const payload = readForm();
        if (!payload.kaspi_token) {
          msg.textContent = '–£–∫–∞–∂–∏—Ç–µ KASPI_TOKEN';
          btnSave.disabled = false;
          return;
        }

        const r = await AF('/settings/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!r.ok) {
          const t = await r.text().catch(() => String(r.status));
          msg.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + t;
          btnSave.disabled = false;
          return;
        }

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        const chk = await AF('/settings/check');
        if (chk.ok) {
          msg.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é...';
          setTimeout(() => (location.href = '/ui/'), 600);
        } else {
          msg.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–µ –ø—Ä–æ—à–ª–∞: ' + chk.status;
          btnSave.disabled = false;
        }
      } catch (e) {
        msg.textContent = '–û—à–∏–±–∫–∞: ' + (e?.message || e);
        btnSave.disabled = false;
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ –∏ –ø–æ Enter –≤ —Ñ–æ—Ä–º–µ
    btnSave.addEventListener('click', (e) => { e.preventDefault(); saveSettings(); });
    form.addEventListener('submit', (e) => { e.preventDefault(); saveSettings(); });
  </script>
</body>
</html>
