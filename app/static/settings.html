<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Настройки — Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body data-theme="light" style="padding:24px;max-width:920px;margin:auto">
  <h1>Настройки</h1>
  <p class="muted">Параметры используются аналитикой и синхронизацией.</p>

  <form id="form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div><label>Shop name</label><input name="shop_name" placeholder="LeoXpress"/></div>
    <div><label>Partner ID</label><input name="partner_id" placeholder=""/></div>

    <div style="grid-column:1/3"><label>KASPI_TOKEN</label><input name="kaspi_token" placeholder="kaspi_xxx" /></div>

    <div><label>Amount fields (CSV)</label><input name="amount_fields" value="totalPrice"/></div>
    <div><label>Amount divisor</label><input name="amount_divisor" type="number" step="0.0001" value="1"/></div>

    <div><label>Date field default</label><input name="date_field_default" value="creationDate"/></div>
    <div><label>Business day start (HH:MM)</label><input name="business_day_start" value="20:00"/></div>

    <div><label>Use business day</label><input type="checkbox" name="use_business_day" checked/></div>
    <div><label>Store accept until</label><input name="store_accept_until" value="17:00"/></div>

    <div><label>City keys (CSV)</label><input name="city_keys" value="city,deliveryAddress.city"/></div>
    <div><label>Allowed origins (CSV)</label><input name="allowed_origins" value=""/></div>
  </form>

  <div style="margin-top:16px;display:flex;gap:12px">
   <button id="save" type="button">Сохранить</button>
    <span id="msg" class="muted"></span>
  </div>

 <script src="./lib/auth.js" defer></script>
<script src="./lib/auth.js" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', async () => {
  const $ = s => document.querySelector(s);
  const form    = $('#form');
  const msg     = $('#msg');
  const btnSave = $('#save');

  // 1) Требуем авторизацию
  const session = await Auth.getSession();
  if (!session) { location.href = '/ui/login.html'; return; }

  // 2) Тянем сохранённые настройки (404 — ок, значит ещё не создавали)
  try {
    const r = await Auth.authedFetch('/settings/me');
    if (r.ok) {
      const data = await r.json();
      for (const [k, v] of Object.entries(data)) {
        const el = form.querySelector(`[name="${k}"]`);
        if (!el) continue;
        if (el.type === 'checkbox') el.checked = !!v;
        else el.value = v ?? '';
      }
      msg.textContent = 'Настройки загружены';
    } else if (r.status === 404) {
      msg.textContent = 'Нет сохранённых настроек — заполните форму и нажмите «Сохранить».';
    } else {
      msg.textContent = 'Ошибка загрузки: ' + r.status;
    }
  } catch (e) {
    msg.textContent = 'Сеть: ' + (e?.message || e);
  }

  // Сериализация формы с корректным приведением типов
  function readForm() {
    const out = {};
    form.querySelectorAll('input').forEach(el => {
      if (!el.name) return;
      if (el.type === 'checkbox') {
        out[el.name] = !!el.checked;
      } else if (el.type === 'number') {
        const n = Number(el.value);
        out[el.name] = Number.isFinite(n) ? n : null;
      } else {
        out[el.name] = el.value.trim();
      }
    });
    return out;
  }

  // 3) Сохранение
  btnSave.addEventListener('click', async (e) => {
    e.preventDefault();
    msg.textContent = 'Сохраняю...';

    try {
      const payload = readForm();
      if (!payload.kaspi_token) { msg.textContent = 'Укажите KASPI_TOKEN'; return; }

      const r = await Auth.authedFetch('/settings/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!r.ok) {
        const t = await r.text().catch(()=>String(r.status));
        msg.textContent = 'Ошибка сохранения: ' + t;
        return;
      }

      // 4) Быстрая проверка токена
      const chk = await Auth.authedFetch('/settings/check');
      if (chk.ok) {
        msg.textContent = 'Сохранено. Перенаправляю...';
        setTimeout(() => location.href = '/ui/', 600);
      } else {
        msg.textContent = 'Сохранено, но проверка токена не прошла: ' + chk.status;
      }
    } catch (e) {
      msg.textContent = 'Ошибка: ' + (e?.message || e);
    }
  });
});
</script>

</body>
</html>
