<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Настройки — Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body data-theme="light" style="padding:24px;max-width:920px;margin:auto">
  <h1>Настройки</h1>
  <p class="muted">Параметры используются аналитикой и синхронизацией.</p>

  <form id="form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div><label>Shop name</label><input name="shop_name" placeholder="LeoXpress"/></div>
    <div><label>Partner ID</label><input name="partner_id" placeholder=""/></div>

    <div style="grid-column:1/3"><label>KASPI_TOKEN</label><input name="kaspi_token" placeholder="kaspi_xxx" /></div>

    <div><label>Amount fields (CSV)</label><input name="amount_fields" value="totalPrice"/></div>
    <div><label>Amount divisor</label><input name="amount_divisor" type="number" step="0.0001" value="1"/></div>

    <div><label>Date field default</label><input name="date_field_default" value="creationDate"/></div>
    <div><label>Business day start (HH:MM)</label><input name="business_day_start" value="20:00"/></div>

    <div><label>Use business day</label><input type="checkbox" name="use_business_day" checked/></div>
    <div><label>Store accept until</label><input name="store_accept_until" value="17:00"/></div>

    <div><label>City keys (CSV)</label><input name="city_keys" value="city,deliveryAddress.city"/></div>
    <div><label>Allowed origins (CSV)</label><input name="allowed_origins" value=""/></div>
  </form>

  <div style="margin-top:16px;display:flex;gap:12px">
    <button id="save">Сохранить</button>
    <span id="msg" class="muted"></span>
  </div>

 <script src="./lib/auth.js" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', async () => {
  const $ = s => document.querySelector(s);
  const form   = $('#form');
  const msg    = $('#msg');
  const btnSave = $('#save');

  // Требуем авторизацию
  const session = await Auth.getSession();
  if (!session) { location.href = '/ui/login.html'; return; }

  // Подтягиваем текущие настройки (404 — ок до первой записи)
  try {
    const r = await Auth.authedFetch('/settings/me');
    if (r.ok) {
      const data = await r.json();
      for (const [k, v] of Object.entries(data)) {
        const el = form.querySelector(`[name="${k}"]`);
        if (!el) continue;
        if (el.type === 'checkbox') el.checked = !!v;
        else el.value = v ?? '';
      }
    }
  } catch (e) { console.warn(e); }

  function readForm() {
    const out = {};
    form.querySelectorAll('input').forEach(el => {
      out[el.name] = el.type === 'checkbox'
        ? el.checked
        : (el.type === 'number' ? Number(el.value) : el.value.trim());
    });
    return out;
  }

  btnSave.addEventListener('click', async () => {
    msg.textContent = 'Сохраняю...';
    try {
      const payload = readForm();
      if (!payload.kaspi_token) { msg.textContent = 'Укажите KASPI_TOKEN'; return; }

      const r = await Auth.authedFetch('/settings/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) { msg.textContent = 'Ошибка сохранения: ' + (await r.text()); return; }

      const check = await Auth.authedFetch('/settings/check');
      if (check.ok) {
        msg.textContent = 'Сохранено. Перенаправляю...';
        setTimeout(() => location.href = '/ui/', 600);
      } else {
        msg.textContent = 'Сохранено, но проверка токена не прошла: ' + check.status;
      }
    } catch (e) {
      msg.textContent = 'Ошибка: ' + (e?.message || e);
    }
  });
});
</script>

</body>
</html>
