<!doctype html><html lang="ru"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Настройки — Kaspi</title>
</head><body>
  <h1>Первичная настройка</h1>
  <form id="f">
    <label>Partner ID <input name="partner_id" type="number" required></label><br>
    <label>Shop name <input name="shop_name" type="text"></label><br>
    <label>Kaspi Token <input name="kaspi_token" type="password" required></label><br>
    <label>City ID <input name="city_id" type="number"></label><br>
    <label>Business day start <input name="business_day_start" value="20:00"></label><br>
    <label>Timezone <input name="timezone" value="Asia/Almaty"></label><br>
    <label>Min margin, % <input name="min_margin_pct" type="number" step="0.01"></label><br>
    <label>Auto reprice <input name="auto_reprice" type="checkbox"></label><br>
    <button type="submit">Сохранить</button>
  </form>
  <script type="module">
    const form = document.getElementById('f');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const payload = {
        partner_id:        fd.get('partner_id') ? Number(fd.get('partner_id')) : null,
        shop_name:         fd.get('shop_name') || null,
        kaspi_token:       fd.get('kaspi_token') || null,
        city_id:           fd.get('city_id') ? Number(fd.get('city_id')) : null,
        business_day_start:fd.get('business_day_start') || null,
        timezone:          fd.get('timezone') || null,
        min_margin_pct:    fd.get('min_margin_pct') ? Number(fd.get('min_margin_pct')) : null,
        auto_reprice:      form.auto_reprice.checked,
      };
      const r = await fetch('/settings/me', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload),
      });
      if (!r.ok) {
        alert('Save failed: ' + await r.text());
        return;
      }
      const next = new URLSearchParams(location.search).get('next') || '/ui/';
      location.href = next;
    });
  </script>
</body></html>
