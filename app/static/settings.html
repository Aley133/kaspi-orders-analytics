<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî Kaspi Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --bg:#0b1020; --fg:#e7edf7; --muted:#9fb0c3; --card:#11162a; --line:#27314a;
      --pri:#4aa3ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --chip:#1b2338; --chip-fg:#c9d7ea;
    }
    html,body{background:var(--bg); color:var(--fg)}
    body{padding:28px; max-width:1024px; margin:auto; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    h1{font-size:24px; margin:0 0 14px}
    .muted{color:var(--muted)}

    /* layout */
    .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .toolbar .who{display:flex; gap:10px; align-items:center}
    .toolbar .badge{background:var(--chip); color:var(--chip-fg); padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px}

    .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px}

    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
    .card h2{font-size:16px; margin:0 0 10px}
    .card .hint{font-size:12px; color:var(--muted); margin:-4px 0 12px}

    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:12px}
    .field label{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}

    input, select{height:36px; padding:0 12px; color:var(--fg); background:#0f1527; border:1px solid var(--line); border-radius:10px; outline:none}
    input[type="checkbox"]{height:auto}
    button{height:36px; padding:0 14px; border-radius:10px; border:1px solid var(--line); color:var(--fg); background:#121a31; cursor:pointer}
    button.primary{background:var(--pri); color:#031225; border-color:#2d7ad1}
    button.ghost{background:transparent}
    button[disabled]{opacity:.6; cursor:not-allowed}

    .pwd{display:flex; gap:8px; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#0f1527; font-size:12px}
    .status{display:flex; align-items:center; gap:8px; font-size:13px}
    .dot{width:8px; height:8px; border-radius:50%; background:#64748b}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--err)}

    .section-title{font-weight:600; margin:2px 0 8px}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}

    .footer{display:flex; gap:10px; align-items:center; margin-top:10px}
    .link{color:var(--pri); text-decoration:none}
  </style>
</head>
<body>
  <div class="toolbar">
    <div>
      <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <div class="muted">–≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π, –±–∏–∑–Ω–µ—Å-–¥–Ω—ë–º –∏ FIFO‚Äë–º–æ—Å—Ç–æ–º.</div>
    </div>
    <div class="who">
      <span id="who" class="badge">‚Ä¶</span>
      <button id="btnSignOut" class="ghost" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="grid">
    <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: e‚Äëmail / —Ç–µ–ª–µ—Ñ–æ–Ω -->
    <section class="card">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞: –µ—Å–ª–∏ –∑–∞—à–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ‚Äî –¥–æ–±–∞–≤—å—Ç–µ e‚Äëmail, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.</div>

      <div class="field">
        <div class="row">
          <div class="pill"><strong>–¢–µ–∫—É—â–∏–π e‚Äëmail:</strong> <span id="curEmail">‚Äî</span></div>
          <div class="pill"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="curPhone">‚Äî</span></div>
        </div>
      </div>

      <div class="section-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</div>
      <div class="row">
        <input id="newPhone" class="grow" placeholder="+7XXXXXXXXXX" inputmode="tel" />
        <button id="btnLinkPhone">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
        <input id="codePhone" placeholder="–ö–æ–¥ –∏–∑ SMS" inputmode="numeric" maxlength="6" style="width:140px" />
        <button id="btnVerifyPhone" class="primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>

      <div class="section-title" style="margin-top:12px">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å e‚Äëmail</div>
      <div class="row">
        <input id="newEmail" class="grow" placeholder="you@example.com" type="email" />
        <button id="btnLinkEmail">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
        <input id="codeEmail" placeholder="–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞" style="width:160px" />
        <button id="btnVerifyEmail" class="primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>

      <div id="acctMsg" class="status" style="margin-top:10px"><span class="dot"></span><span>–ì–æ—Ç–æ–≤–æ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º.</span></div>
    </section>

    <!-- –°–∏—Å—Ç–µ–º–Ω–æ–µ / –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ -->
    <section class="card">
      <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
      <div class="hint">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å.</div>
      <div class="row">
        <button id="btnCheck" class="ghost">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <span id="checkMsg" class="status"><span class="dot"></span><span>‚Äî</span></span>
      </div>
      <div class="row" style="margin-top:8px">
        <a class="link" href="/ui/">‚üµ –ù–∞ –≥–ª–∞–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</a>
      </div>
    </section>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞ / Kaspi / –ë–∏–∑–Ω–µ—Å‚Äë–¥–µ–Ω—å -->
  <section class="card" style="margin-top:16px">
    <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞ –∏ —Ä–∞—Å—á—ë—Ç–æ–≤</h2>

    <div class="split">
      <div>
        <div class="field">
          <label>Shop name</label>
          <input name="shop_name" placeholder="LeoXpress" />
        </div>
        <div class="field">
          <label>Partner ID</label>
          <input name="partner_id" placeholder="" />
        </div>
        <div class="field">
          <label>KASPI_TOKEN</label>
          <div class="row pwd">
            <input name="kaspi_token" placeholder="kaspi_xxx" type="password" class="grow" />
            <button id="togglePwd" type="button" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω">üôà</button>
          </div>
        </div>
      </div>

      <div>
        <div class="field">
          <label>Amount fields (CSV)</label>
          <input name="amount_fields" value="totalPrice" />
        </div>
        <div class="field">
          <label>Amount divisor</label>
          <input name="amount_divisor" type="number" step="0.0001" value="1" />
        </div>
        <div class="field">
          <label>Date field default</label>
          <input name="date_field_default" value="creationDate" />
        </div>
      </div>
    </div>

    <div class="split">
      <div>
        <div class="field">
          <label>Business day start (HH:MM)</label>
          <input name="business_day_start" value="20:00" />
        </div>
        <div class="field row" style="gap:10px">
          <label style="margin-right:auto">Use business day</label>
          <input type="checkbox" name="use_business_day" checked />
        </div>
      </div>
      <div>
        <div class="field">
          <label>Store accept until</label>
          <input name="store_accept_until" value="17:00" />
        </div>
        <div class="field">
          <label>Allowed origins (CSV)</label>
          <input name="allowed_origins" value="" />
        </div>
      </div>
    </div>

    <div class="field" style="margin-top:8px">
      <label>City keys (CSV)</label>
      <input name="city_keys" value="city,deliveryAddress.city" />
    </div>

    <div class="footer">
      <button id="save" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="msg" class="muted">‚Äî</span>
    </div>
  </section>

  <script type="module">
    import { Auth } from './lib/auth.js';

    // ------------- Helpers -------------
    const $ = (s) => document.querySelector(s);
    const msg = (node, text, cls) => { const dot=node.querySelector('.dot'); const span=node.querySelector('span:nth-child(2)'); dot.className='dot '+(cls||''); span.textContent=text; };

    // provide authedFetch globally
    window.authedFetch = async (input, init={}) => {
      await Auth.ready; const headers={...(init.headers||{}), ...(await Auth.authHeader())};
      const r = await fetch(input,{...init, headers}); if(r.status===401){ await Auth.signOutAndGoLogin(); throw new Error('Unauthorized'); } return r;
    };
    const AF = window.authedFetch;

    // Require auth, show who
    await Auth.ready; await Auth.requireAuth();
    $('#btnSignOut')?.addEventListener('click', Auth.signOutAndGoLogin);

    // Try to obtain supabase client from Auth or window
    const sb = Auth.sb || Auth.client || window.supabase;

    async function refreshWho(){
      try{
        const { data:{ user } } = await (sb?.auth?.getUser?.() ?? {data:{user:null}});
        $('#curEmail').textContent = user?.email || '‚Äî';
        $('#curPhone').textContent = user?.phone || '‚Äî';
        const label = user?.email ? `–í–æ—à–ª–∏ –∫–∞–∫ ${user.email}` : (user?.phone ? `–í–æ—à–ª–∏ –∫–∞–∫ ${user.phone}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        $('#who').textContent = label;
      }catch(e){ $('#who').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'; }
    }

    await refreshWho();

    // Toggle kaspi token visibility
    $('#togglePwd').addEventListener('click', () => {
      const inp = document.querySelector('input[name="kaspi_token"]');
      const t = inp.type==='password' ? 'text' : 'password';
      inp.type=t; $('#togglePwd').textContent = t==='password' ? 'üôà' : 'üëÅÔ∏è';
    });

    // Load settings
    const form = document.querySelector('section.card + section.card + section.card input') ? document.querySelector('body') : document.body; // noop guard
    const formRoot = document.querySelector('section.card + section.card + section.card'); // last card
    const formEl = document.querySelector('section.card + section.card + section.card'); // for scope only

    async function loadSettings(){
      const r = await AF('/settings/me');
      const msgNode = $('#msg');
      if(r.ok){
        const data = await r.json();
        document.querySelectorAll('input[name]').forEach(el=>{
          const k = el.name; if(!(k in data)) return; const v = data[k];
          if(el.type==='checkbox') el.checked = !!v; else el.value = (v ?? '').toString();
        });
        msgNode.textContent='–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
      } else if (r.status===404){
        msgNode.textContent='–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
      } else {
        msgNode.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+r.status;
      }
    }
    await loadSettings();

    function collect(){
      const out={};
      document.querySelectorAll('input[name]').forEach(el=>{
        if(el.type==='checkbox') out[el.name]=!!el.checked;
        else if(el.type==='number'){ const n=Number(el.value); out[el.name]=Number.isFinite(n)?n:null; }
        else out[el.name]=(el.value??'').trim();
      });
      return out;
    }

    async function save(){
      const payload = collect();
      const m = $('#msg');
      $('#save').disabled=true; m.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
      if(!payload.kaspi_token){ m.textContent='–£–∫–∞–∂–∏—Ç–µ KASPI_TOKEN'; $('#save').disabled=false; return; }
      const r = await AF('/settings/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(!r.ok){ m.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(await r.text().catch(()=>r.status)); $('#save').disabled=false; return; }
      const chk = await AF('/settings/check');
      if(chk.ok){ m.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é‚Ä¶'; setTimeout(()=>location.href='/ui/', 600); }
      else { m.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–µ –ø—Ä–æ—à–ª–∞: '+chk.status; $('#save').disabled=false; }
    }

    $('#save').addEventListener('click', save);

    // Check token quickly
    $('#btnCheck').addEventListener('click', async()=>{
      const n = $('#checkMsg'); msg(n,'–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶','');
      const r = await AF('/settings/check');
      if(r.ok) msg(n,'–¢–æ–∫–µ–Ω –ø—Ä–∏–Ω—è—Ç (200).','ok'); else msg(n,`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (${r.status}).`,'err');
    });

    // ---------- Link / verify phone ----------
    $('#btnLinkPhone').addEventListener('click', async()=>{
      const phone = $('#newPhone').value.trim(); if(!phone.startsWith('+')) return msg($('#acctMsg'),'–§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ E.164 (+7‚Ä¶)', 'warn');
      try{
        const { error } = await sb.auth.updateUser({ phone });
        if(error) throw error; msg($('#acctMsg'),'–ö–æ–¥ SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª.','ok');
      }catch(e){ msg($('#acctMsg'),'–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS: '+(e?.message||e),'err'); }
    });

    $('#btnVerifyPhone').addEventListener('click', async()=>{
      const phone = $('#newPhone').value.trim(); const token = $('#codePhone').value.trim();
      try{
        const { error } = await sb.auth.verifyOtp({ phone, token, type:'phone_change' });
        if(error) throw error; msg($('#acctMsg'),'–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω.','ok'); await refreshWho();
      }catch(e){ msg($('#acctMsg'),'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω: '+(e?.message||e),'err'); }
    });

    // ---------- Link / verify email ----------
    $('#btnLinkEmail').addEventListener('click', async()=>{
      const email = $('#newEmail').value.trim(); if(!email.includes('@')) return msg($('#acctMsg'),'–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e‚Äëmail','warn');
      try{
        const { error } = await sb.auth.updateUser({ email });
        if(error) throw error; msg($('#acctMsg'),'–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e‚Äëmail¬ª.','ok');
      }catch(e){ msg($('#acctMsg'),'–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –Ω–∞ e‚Äëmail: '+(e?.message||e),'err'); }
    });

    $('#btnVerifyEmail').addEventListener('click', async()=>{
      const email = $('#newEmail').value.trim(); const token = $('#codeEmail').value.trim();
      try{
        const { error } = await sb.auth.verifyOtp({ email, token, type:'email_change' });
        if(error) throw error; msg($('#acctMsg'),'E‚Äëmail –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω.','ok'); await refreshWho();
      }catch(e){ msg($('#acctMsg'),'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e‚Äëmail: '+(e?.message||e),'err'); }
    });
  </script>
</body>
</html>
