<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Вход — Kaspi Orders Analytics</title>
<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;max-width:520px;margin:48px auto;padding:0 16px}input,button{font:inherit;padding:10px 12px;border-radius:8px;border:1px solid #ddd}button{cursor:pointer}</style>
</head><body>
<h1>Вход</h1>
<p>Укажи номер телефона — пришлём SMS-код.</p>
<form id="f-phone">
<input name="phone" placeholder="+7 777 123 45 67" required style="width:100%">
<div style="margin-top:12px"><button>Получить код</button></div>
</form>


<form id="f-code" style="display:none;margin-top:24px">
<input name="code" placeholder="Код из SMS" inputmode="numeric" maxlength="6" required style="width:100%">
<div style="margin-top:12px"><button>Войти</button></div>
</form>


<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js';
const meta = await (await fetch('/auth/meta')).json();
const supabase = createClient(meta.supabase_url, meta.supabase_anon_key);
window.supabase = supabase;


const qp = new URLSearchParams(location.search);
const next = qp.get('next') || '/ui/';


const fPhone = document.getElementById('f-phone');
const fCode = document.getElementById('f-code');
let phoneE164 = '';


fPhone.addEventListener('submit', async (e) => {
e.preventDefault();
let p = new FormData(fPhone).get('phone').toString().trim();
// простая нормализация: +7XXXXXXXXXX
p = p.replace(/\D+/g, '');
if (p.startsWith('8')) p = '7' + p.slice(1);
if (!p.startsWith('7')) p = '7' + p;
phoneE164 = '+' + p;
const { error } = await supabase.auth.signInWithOtp({ phone: phoneE164, options: { channel: 'sms' } });
if (error) return alert(error.message);
fPhone.style.display = 'none';
fCode.style.display = '';
});


fCode.addEventListener('submit', async (e) => {
e.preventDefault();
const code = new FormData(fCode).get('code').toString().trim();
const { data, error } = await supabase.auth.verifyOtp({ phone: phoneE164, token: code, type: 'sms' });
if (error) return alert(error.message);
location.href = next; // дальше ensureSessionAndSettings решит куда вести
});
</script>
</body></html>
