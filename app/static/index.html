<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaspi Orders Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* маленькие утилиты */
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;background:var(--card);font-size:12px}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#9ca3af}
    .dot.on{background:#10b981}
    .dot.warn{background:#f59e0b}
    .dot.err{background:#ef4444}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .note{margin:8px 0 12px;padding:8px 10px;border-radius:8px;display:none}
    .note.ok{display:block;background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .note.err{display:block;background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a class="nav-item" href="stock.html">Мой склад</a>
        <a class="nav-item" href="#">Предзаказ</a>
        <a class="nav-item" href="#">Демпинг</a>
        <a class="nav-item" href="#">WhatsApp Рассылка</a>
      </nav>
      <div class="theme-switch">
        <label class="switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <span>Тёмная тема</span>
      </div>
    </aside>

    <div class="content">
      <h1>Аналитика заказов Kaspi</h1>

      <form id="f" class="filters">
        <div class="row">
          <label>Начало</label>
          <input type="date" id="start" required>
          <label>Конец</label>
          <input type="date" id="end" required>
          <label>Часовой пояс</label>
          <input type="text" id="tz" value="Asia/Almaty">
          <label>Поле даты</label>
          <select id="date_field"></select>
        </div>
        <div class="row">
          <label>Статусы (включить)</label>
          <input type="text" id="states" placeholder="через запятую, напр. NEW,DELIVERED">
          <label class="chk">
            <input type="checkbox" id="exclude_states" checked>
            Исключить CANCELED
          </label>
        </div>
        <div class="row">
          <label class="chk">
            <input type="checkbox" id="use_bd" checked>
            День магазина
          </label>
          <label>Начало дня</label>
          <input type="time" id="bd_start" value="20:00" step="60">
          <button type="submit" class="btn" id="btn-run">Показать</button>
        </div>
        <div id="bdInfo" class="muted"></div>
      </form>

      <div id="note" class="note"></div>

      <section class="kpi">
        <div class="kpi-item"><div class="kpi-label">Период</div>
          <div class="kpi-value" id="periodLabel">—</div>
          <div class="kpi-sub">до <span id="periodCutoff">—:—</span></div>
        </div>
        <div class="kpi-item"><div class="kpi-label">Заказы</div>
          <div class="kpi-value" id="kpiOrders">0</div>
        </div>
        <div class="kpi-item"><div class="kpi-label">Оборот</div>
          <div class="kpi-value" id="kpiAmount">0</div>
        </div>
      </section>

      <!-- ======== KPI Прибыли (FIFO) + график + таблицы ======== -->
      <section class="shell">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h2 style="margin:0">Прибыль (FIFO)</h2>
          <div class="row" style="gap:10px;align-items:center">
            <span id="profitKeyBadge" class="chip" title="Ключ Kaspi для защищённых эндпоинтов FIFO">
              <span class="dot"></span><span>ключ не задан</span>
            </span>
            <span id="profitSyncChip" class="chip" title="Статус синхронизации">
              <span class="dot"></span><span>статус неизвестен</span>
            </span>
            <button type="button" class="btn secondary" id="btnProfitApiKey">API-Key</button>
            <label for="profitGroup">Группировка</label>
            <select id="profitGroup">
              <option value="day">День</option>
              <option value="week">Неделя</option>
              <option value="month">Месяц</option>
            </select>
            <button type="button" class="btn secondary" id="btnProfitSync">Синхронизировать</button>
            <button type="button" class="btn secondary" id="btnProfitRebuild" title="Пересчитать списания FIFO за период">Перестроить FIFO</button>
            <button type="button" class="btn" id="btnProfitSyncRebuild">Синхронизировать + Перестроить</button>
          </div>
        </div>

        <div id="profitDbInfo" class="muted" style="margin:6px 0 10px"></div>

        <div class="kpi" style="margin-top:10px">
          <div class="kpi-item"><div class="kpi-label">Выручка</div><div class="kpi-value" id="kpiPRevenue">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Комиссия</div><div class="kpi-value" id="kpiPCommission">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Себестоимость</div><div class="kpi-value" id="kpiPCost">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Прибыль</div><div class="kpi-value" id="kpiPProfit">0</div></div>
        </div>

        <div id="profitChartHolder" style="margin-top:8px">
          <canvas id="profitChart"></canvas>
        </div>
        <div id="profitEmpty" class="muted" style="display:none;padding:8px 0">Нет данных для выбранного периода</div>

        <div class="row" style="gap:16px; margin-top:16px; align-items:flex-start; flex-wrap:wrap">
          <div style="flex:1; min-width:320px">
            <h3 style="margin:0 0 6px">Таблица периодов</h3>
            <table id="tbl-profit" class="table">
              <thead><tr><th>Период</th><th>Выручка</th><th>Комиссия</th><th>Себестоимость</th><th>Прибыль</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="flex:1; min-width:320px">
            <h3 style="margin:0 0 6px">Топ SKU по прибыли</h3>
            <table id="tbl-profit-sku" class="table">
              <thead><tr><th>SKU</th><th>Выручка</th><th>Комиссия</th><th>Себестоимость</th><th>Прибыль</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
      <!-- ======== /FIFO ======== -->

      <section class="shell">
        <h2>Топ города</h2>
        <div id="chart-cities"><canvas id="cities"></canvas></div>
      </section>

      <section class="shell">
        <h2>Состояния (диагностика)</h2>
        <div id="statesBox" class="pillbox"></div>
      </section>

      <section class="shell">
        <h2>Таблица: Дни</h2>
        <table id="tbl-days" class="table">
          <thead><tr><th>Дата</th><th>Кол-во</th><th>Оборот</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="shell">
        <h2>Номера заказов (для сверки)</h2>
        <div id="ids"></div>
      </section>
    </div>
  </div>

<script>
const nf = new Intl.NumberFormat('ru-RU');
function fmt(n){ return nf.format(Math.round((Number(n) + Number.EPSILON) * 100) / 100); }
function tableFill(id, rows){
  const tb = document.querySelector(`#${id} tbody`);
  tb.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    for(const c of r){
      const td = document.createElement('td'); td.textContent = c; tr.appendChild(td);
    }
    tb.appendChild(tr);
  }
}
function setNote(msg, ok=false){
  const el = document.getElementById('note');
  el.textContent = msg;
  el.className = 'note ' + (ok ? 'ok' : 'err');
}
</script>

<script>
async function loadMeta(){
  try {
    const r = await fetch('/meta');
    if(!r.ok) throw new Error();
    const meta = await r.json();
    const sel = document.getElementById('date_field');
    sel.innerHTML = '';
    (meta.date_field_options || ['creationDate']).forEach(v=>{
      const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
    });
    sel.value = meta.date_field_default || 'creationDate';
    document.getElementById('tz').value = meta.timezone || 'Asia/Almaty';
    document.getElementById('bd_start').value = meta.business_day_start || '20:00';
  } catch(e){ /* ignore */ }
  const today = new Date(); const iso = d=>d.toISOString().slice(0,10);
  document.getElementById('start').value = iso(today);
  document.getElementById('end').value = iso(today);
}

let citiesChart = null;
let profitChart = null;

async function run(e){
  if(e) e.preventDefault();

  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const tz = document.getElementById('tz').value || 'Asia/Almaty';
  const date_field = document.getElementById('date_field').value;
  const states = document.getElementById('states').value;
  const exc = document.getElementById('exclude_states').checked ? 'CANCELED' : '';
  const use_bd = document.getElementById('use_bd')?.checked ? '1' : '0';
  const bd_start = document.getElementById('bd_start')?.value || '';

  const p = new URLSearchParams();
  p.set('start', start); p.set('end', end); p.set('tz', tz);
  p.set('date_field', date_field); if(states) p.set('states', states);
  if(exc) p.set('exclude_states', exc);
  p.set('use_bd', use_bd); if(bd_start) p.set('business_day_start', bd_start);

  const r = await fetch(`/orders/analytics?${p.toString()}`);
  if(!r.ok) throw new Error('analytics failed');
  const data = await r.json();

  // KPI
  window.APP_CURRENCY = data.currency || 'KZT';
  document.getElementById('kpiOrders').textContent = fmt(data.total_orders);
  document.getElementById('kpiAmount').textContent = `${fmt(data.total_amount)} ${window.APP_CURRENCY}`;
  document.getElementById('periodLabel').textContent = `${data.range.start} → ${data.range.end}`;

  const cutoffEl = document.getElementById('periodCutoff');
  if(cutoffEl){ cutoffEl.textContent = (use_bd==='1' ? (bd_start || '20:00') : '24:00'); }
  const bdInfo = document.getElementById('bdInfo');
  if(bdInfo){
    bdInfo.textContent = (use_bd==='1' ? `День магазина: ${bd_start||'20:00'} → ${bd_start||'20:00'}` : 'День магазина: выключен');
  }

  // Состояния
  const sb = document.getElementById('statesBox');
  sb.innerHTML = '';
  const entries = Object.entries(data.state_breakdown||{}).sort((a,b)=>b[1]-a[1]);
  for(const [k,v] of entries){
    const span = document.createElement('span');
    span.className='pill';
    span.textContent=`${k}: ${v}`;
    sb.appendChild(span);
  }
  if(entries.length===0){ sb.innerHTML = '<div class="muted">Нет данных</div>'; }

  // Таблица дней
  tableFill('tbl-days', (data.days||[]).map(d=>[d.x, d.count, `${fmt(d.amount)} ${window.APP_CURRENCY}`]));

  // Топ города
  const labels = (data.cities||[]).map(c=>c.city);
  const counts = (data.cities||[]).map(c=>c.count);
  const holder = document.getElementById('chart-cities');
  holder.innerHTML = '<canvas id="cities"></canvas>';
  if(labels.length===0){
    holder.innerHTML = '<div class="muted" style="padding:12px">Нет данных по городам</div>';
  } else {
    const ctx = document.getElementById('cities').getContext('2d');
    if(citiesChart) citiesChart.destroy();
    citiesChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Заказы', data: counts }] },
      options: { responsive:true, plugins: { legend: { display:false } } }
    });
  }

  await loadIds();
  await loadProfitFIFO();             // KPI + график + таблицы
  await checkProfitStatus(data);      // индикатор синхронизации
}

/* ====== Номера заказов ====== */
async function loadIds(){
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const tz = document.getElementById('tz').value || 'Asia/Almaty';
  const date_field = document.getElementById('date_field').value;
  const states = document.getElementById('states').value;
  const exc = document.getElementById('exclude_states').checked ? 'CANCELED' : '';
  const use_bd = document.getElementById('use_bd')?.checked ? '1' : '0';
  const bd_start = document.getElementById('bd_start')?.value || '';
  const order = 'asc';

  const params = new URLSearchParams();
  params.set('start', start); params.set('end', end); params.set('tz', tz);
  params.set('date_field', date_field); if(states) params.set('states', states);
  if(exc) params.set('exclude_states', exc);
  params.set('use_bd', use_bd); if(bd_start) params.set('business_day_start', bd_start);
  params.set('order', order); params.set('grouped', '1'); params.set('limit', '100000');

  const r = await fetch(`/orders/ids?${params.toString()}`);
  if(!r.ok) throw new Error('ids failed');
  const data = await r.json();
  const currency = data.currency || window.APP_CURRENCY || 'KZT';

  const container = document.getElementById('ids');
  container.innerHTML = '';

  const totalCount = (typeof data.period_total_count === 'number') ? data.period_total_count : (data.items||[]).length;
  const totalAmount = (typeof data.period_total_amount === 'number') ? data.period_total_amount : (data.items||[]).reduce((a,it)=>a+(Number(it.amount)||0),0);
  const summary = document.createElement('div');
  summary.className = 'ids-summary';
  summary.innerHTML = `<span>Итого за период:</span> <b>${fmt(totalCount)}</b><span>шт.</span> <span>·</span> <b>${fmt(totalAmount)}</b> <span>${currency}</span>`;
  container.appendChild(summary);

  const bar = document.createElement('div');
  bar.className='ids-actions';
  const btnCopy = document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Скопировать номера';
  btnCopy.onclick = () => {
    const all = (data.items||[]).map(it=>it.number).join('\n');
    navigator.clipboard.writeText(all);
  };
  const btnCsv = document.createElement('a'); btnCsv.className='btn'; btnCsv.textContent='Скачать CSV';
  const csvParams = new URLSearchParams(params); csvParams.delete('grouped'); csvParams.set('limit','100000');
  btnCsv.href = `/orders/ids.csv?${csvParams.toString()}`; btnCsv.setAttribute('download','ids.csv');

  const btnExpand = document.createElement('button'); btnExpand.className='btn'; btnExpand.textContent='Раскрыть всё';
  const btnCollapse = document.createElement('button'); btnCollapse.className='btn'; btnCollapse.textContent='Свернуть всё';

  bar.appendChild(btnCopy); bar.appendChild(btnCsv); bar.appendChild(btnExpand); bar.appendChild(btnCollapse);
  container.appendChild(bar);

  const wrapper = document.createElement('div');
  wrapper.className='ids-groups';
  container.appendChild(wrapper);

  const detailsList = [];
  for(const group of (data.groups || [])){
    const det = document.createElement('details');
    det.open = true;

    const dayTotal = (typeof group.total_amount === 'number') ? group.total_amount : group.items.reduce((acc, it) => acc + (Number(it.amount) || 0), 0);

    const sum = document.createElement('summary');
    sum.textContent = `${group.day}  —  ${group.items.length} шт. · ${fmt(dayTotal)} ${currency}`;
    det.appendChild(sum);

    const pre = document.createElement('pre');
    pre.style.whiteSpace='pre-wrap';
    pre.textContent = group.items.map(it=>`${it.number}\t${it.state}\t${it.date.slice(0,16).replace('T',' ')}\t${it.amount}`).join('\n');
    det.appendChild(pre);

    detailsList.push(det);
    wrapper.appendChild(det);
  }

  btnExpand.onclick = ()=> detailsList.forEach(d=>d.open=true);
  btnCollapse.onclick = ()=> detailsList.forEach(d=>d.open=false);
}

/* ====== Блок FIFO ====== */
/* Ключ и автоподстановка X-API-Key/ ?api_key= только для /profit/* */
(() => {
  const KEY = "KASPI_API_KEY";
  const badge = ()=>document.getElementById('profitKeyBadge');
  function refreshBadge(){
    const v = localStorage.getItem(KEY) || "";
    const el = badge(); if(!el) return;
    el.querySelector('.dot').className = 'dot ' + (v ? 'on' : '');
    el.querySelector('span:last-child').textContent = v ? 'ключ установлен' : 'ключ не задан';
  }
  window.KASPI_API_KEY = localStorage.getItem(KEY) || ""; refreshBadge();

  const origFetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    try{
      const urlStr = typeof input === 'string' ? input : (input && input.url) || '';
      if (urlStr.startsWith('/profit/')) {
        init = init || {};
        const k = window.KASPI_API_KEY || '';
        let headers = init.headers instanceof Headers ? init.headers : new Headers(init.headers || {});
        if (k) headers.set('X-API-Key', k);
        init.headers = headers;
        if (k) {
          const u = new URL(urlStr, location.origin);
          if (!u.searchParams.has('api_key')) u.searchParams.set('api_key', k);
          if (typeof input === 'string') input = u.pathname + u.search; else input = new Request(u.toString(), init);
        }
      }
    }catch(e){}
    return origFetch(input, init);
  };

  window.setApiKey = function(k){
    localStorage.setItem(KEY, k || '');
    window.KASPI_API_KEY = k || '';
    refreshBadge();
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnProfitApiKey');
    if(btn){
      btn.addEventListener('click', ()=>{
        const v = prompt('Введите X-API-Key (сохранится в этом браузере):', window.KASPI_API_KEY||'');
        if(v!==null){ setApiKey(v.trim()); alert('Сохранено. Повторите действие.'); }
      });
    }
  });
})();


async function postProfitWithFallback(path1, path2, params){
  const qs = params ? ('?' + params.toString()) : '';
  // 1) пробуем первый путь
  let r = await fetch(path1 + qs, { method:'POST' });
  if(r.status === 404){
    // 2) пробуем второй путь
    r = await fetch(path2 + qs, { method:'POST' });
  }
  if(r.status===401 || r.status===403){
    const v = prompt('Укажите X-API-Key для блока FIFO:', window.KASPI_API_KEY||'');
    if(v!==null){ window.setApiKey(v.trim()); return postProfitWithFallback(path1, path2, params); }
    throw new Error(await r.text() || 'Unauthorized');
  }
  if(!r.ok) throw new Error((await r.text()) || r.statusText || ('HTTP ' + r.status));
  return r.json();
}
  
async function fetchProfitJSON(url, opts, _retry){
  const r = await fetch(url, opts||{});
  if(r.status===401 || r.status===403){
    if(!_retry){
      const v = prompt('Укажите X-API-Key для блока FIFO:', window.KASPI_API_KEY||'');
      if(v!==null){ window.setApiKey(v.trim()); return fetchProfitJSON(url, opts, true); }
    }
    throw new Error(await r.text() || 'Unauthorized');
  }
  if(!r.ok){
    const body = await r.text();
    throw new Error(body || r.statusText || ('HTTP '+r.status));
  }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

function setFifoKPIs(total, cur){
  const t = total || {revenue:0, commission:0, cost:0, profit:0};
  document.getElementById('kpiPRevenue').textContent   = `${fmt(t.revenue||0)} ${cur}`;
  document.getElementById('kpiPCommission').textContent= `${fmt(t.commission||0)} ${cur}`;
  document.getElementById('kpiPCost').textContent      = `${fmt(t.cost||0)} ${cur}`;
  document.getElementById('kpiPProfit').textContent    = `${fmt(t.profit||0)} ${cur}`;
}

function drawProfitChart(rows, cur){
  const empty = document.getElementById('profitEmpty');
  const holder = document.getElementById('profitChartHolder');
  const ctx = document.getElementById('profitChart').getContext('2d');
  if(profitChart){ profitChart.destroy(); profitChart=null; }
  if(!rows.length){ empty.style.display='block'; holder.style.display='none'; return; }
  empty.style.display='none'; holder.style.display='block';
  const labels = rows.map(r=>r.period);
  const values = rows.map(r=>Number(r.profit||0));
  profitChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Прибыль', data: values }] },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>`Прибыль: ${fmt(ctx.parsed.y)} ${cur}` } } },
      scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true } }
    }
  });
}

async function pingProfitDb(){
  try{
    const info = await fetchProfitJSON('/profit/db/ping');
    const driver = info?.driver || (info?.db_path?.startsWith('postgres') ? 'pg' : 'sqlite');
    document.getElementById('profitDbInfo').textContent = `FIFO DB: ${driver}`;
  }catch(e){
    document.getElementById('profitDbInfo').textContent = '';
  }
}

/* ---- операции: sync / rebuild ---- */
function buildSyncParams(){
  const start = document.getElementById('start').value;
  const end   = document.getElementById('end').value;
  const tz = document.getElementById('tz').value || 'Asia/Almaty';
  const date_field = document.getElementById('date_field').value;
  const states = document.getElementById('states').value;
  const exc = document.getElementById('exclude_states').checked ? 'CANCELED' : '';
  const use_bd = document.getElementById('use_bd')?.checked ? '1' : '0';
  const bd_start = document.getElementById('bd_start')?.value || '20:00';

  const p = new URLSearchParams({ start, end, tz, date_field, use_bd, business_day_start: bd_start });
  if(states) p.set('states', states);
  if(exc) p.set('exclude_states', exc);
  return p;
}

async function syncProfit(){
  const df = document.getElementById('start').value;
  const dt = document.getElementById('end').value;
  if(!df || !dt){ setNote('Сначала задайте период (начало/конец).'); return; }
  try{
    const p = buildSyncParams();
    const res = await postProfitWithFallback('/profit/sync', '/profit/bridge/sync', p);
    setNote(`Синхронизация FIFO: заказов=${res?.synced_orders||0}, вставлено позиций=${res?.items_inserted||0}`, true);
    await loadProfitFIFO();
    await checkProfitStatus(); // обновим индикатор
  }catch(e){
    setNote('Синхронизация не удалась: ' + e.message);
  }
}

async function rebuildFifo(){
  const df = document.getElementById('start').value;
  const dt = document.getElementById('end').value;
  if(!df || !dt){ setNote('Сначала задайте период (начало/конец).'); return; }
  try{
    const p = new URLSearchParams({ date_from: df, date_to: dt });
    const res = await fetchProfitJSON('/profit/rebuild-ledger?' + p.toString(), { method:'POST' });
    setNote(`FIFO перестроен. Добавлено списаний: ${res?.recomputed||0}`, true);
    await loadProfitFIFO();
    await checkProfitStatus();
  }catch(e){
    setNote('Перестроение FIFO не удалось: ' + e.message);
  }
}

async function syncAndRebuild(){
  await syncProfit();
  // если sync прошёл — rebuild:
  try{
    const df = document.getElementById('start').value;
    const dt = document.getElementById('end').value;
    const p = new URLSearchParams({ date_from: df, date_to: dt });
    const res = await fetchProfitJSON('/profit/rebuild-ledger?' + p.toString(), { method:'POST' });
    setNote(`Синхр.+пересчёт выполнены. Списаний: ${res?.recomputed||0}`, true);
    await loadProfitFIFO();
    await checkProfitStatus();
  }catch(e){
    // setNote уже показан в syncProfit при ошибке sync
  }
}

/* ---- статус синхронизации: чип как в "Мой склад" ---- */
function setSyncChip(state, text){
  const el = document.getElementById('profitSyncChip');
  const dot = el.querySelector('.dot');
  dot.className = 'dot ' + (state==='ok' ? 'on' : state==='warn' ? 'warn' : state==='err' ? 'err' : '');
  el.querySelector('span:last-child').textContent = text;
  el.title = text;
}

async function checkProfitStatus(analyticsData){
  try{
    const df = document.getElementById('start').value;
    const dt = document.getElementById('end').value;
    if(!df || !dt){ setSyncChip('warn','нет периода'); return; }

    const ordersCount = (analyticsData && typeof analyticsData.total_orders==='number')
      ? analyticsData.total_orders
      : (await (await fetch(`/orders/analytics?start=${df}&end=${dt}`)).json()).total_orders;

    const p = new URLSearchParams({ date_from: df, date_to: dt, group_by: 'total', use_bd: (document.getElementById('use_bd')?.checked ? '1':'0'), bd_start: (document.getElementById('bd_start')?.value||'20:00') });
    const sum = await fetchProfitJSON('/profit/summary?' + p.toString());
    const t = sum.total || {revenue:0,commission:0,cost:0,profit:0};

    if((t.revenue||0) > 0 || (t.cost||0) > 0 || (t.commission||0) > 0 || (t.profit||0) !== 0){
      setSyncChip('ok','синхронизировано');
    }else if(ordersCount>0){
      setSyncChip('warn','требуется синхронизация/перестроение');
    }else{
      setSyncChip('','нет заказов в периоде');
    }
  }catch(e){
    setSyncChip('err','ошибка проверки статуса');
  }
}

/* ====== Загрузка KPI/график/таблицы FIFO ====== */
async function loadProfitFIFO(){
  const df = document.getElementById('start').value;
  const dt = document.getElementById('end').value;
  if(!df || !dt) return;

  const use_bd   = document.getElementById('use_bd')?.checked ? '1' : '0';
  const bd_start = document.getElementById('bd_start')?.value || '20:00';
  const group_by = document.getElementById('profitGroup')?.value || 'day';

  try{
    // summary
    const p = new URLSearchParams({ date_from: df, date_to: dt, group_by, use_bd, bd_start });
    const sum = await fetchProfitJSON('/profit/summary?' + p.toString());
    const cur = sum.currency || window.APP_CURRENCY || 'KZT';
    setFifoKPIs(sum.total, cur);
    drawProfitChart(sum.rows||[], cur);

    // таблица периодов
    tableFill('tbl-profit', (sum.rows||[]).map(r=>[
      r.period, `${fmt(r.revenue)} ${cur}`, `${fmt(r.commission)} ${cur}`, `${fmt(r.cost)} ${cur}`, `${fmt(r.profit)} ${cur}`
    ]));

    // топ sku
    const s = new URLSearchParams({ date_from: df, date_to: dt, limit: 50 });
    const top = await fetchProfitJSON('/profit/by-sku?' + s.toString());
    tableFill('tbl-profit-sku', (top.rows||[]).map(x=>[
      x.sku, `${fmt(x.revenue)} ${cur}`, `${fmt(x.commission)} ${cur}`, `${fmt(x.cost)} ${cur}`, `${fmt(x.profit)} ${cur}`
    ]));
  }catch(e){
    console.warn('FIFO:', e);
    setFifoKPIs({revenue:0,commission:0,cost:0,profit:0}, window.APP_CURRENCY||'KZT');
    drawProfitChart([], window.APP_CURRENCY||'KZT');
    tableFill('tbl-profit', []);
    tableFill('tbl-profit-sku', []);
  }
}
/* ====== /FIFO ====== */

document.addEventListener('DOMContentLoaded', async () => {
  await loadMeta();
  document.getElementById('f').addEventListener('submit', run);
  document.getElementById('themeToggle').addEventListener('change', (e)=>{
    document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
  });
  document.getElementById('profitGroup').addEventListener('change', loadProfitFIFO);
  document.getElementById('btnProfitRebuild').addEventListener('click', rebuildFifo);
  document.getElementById('btnProfitSync').addEventListener('click', syncProfit);
  document.getElementById('btnProfitSyncRebuild').addEventListener('click', syncAndRebuild);
  await pingProfitDb();
  run(); // initial
});
</script>
</body>
</html>
