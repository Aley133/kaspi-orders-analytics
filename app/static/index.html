<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kaspi — Dashboard</title>
  <link rel="stylesheet" href="/ui/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="shell">
    <header class="top">
      <h1>Добрый день, LeoXpress</h1>
      <div class="tabs">
        <button class="btn" data-span="7">Неделя</button>
        <button class="btn active" data-span="30">Месяц</button>
      </div>
    </header>

    <form id="f" class="controls">
      <label>Начало <input id="start" type="date" required></label>
      <label>Конец <input id="end" type="date" required></label>
      <label>State(ы) <input id="states" placeholder="NEW,DELIVERY"></label>
      <label>Исключить <input id="exclude_states" placeholder="CANCELED"></label>
      <label>Дата по полю 
        <input id="date_field" list="fields" placeholder="plannedDeliveryDate">
        <datalist id="fields"></datalist>
      </label>
      <button class="btn primary" type="submit">Показать</button>
    </form>

    <div id="kpis" class="kpis"></div>

    <section class="panel">
      <h2>Динамика</h2>
      <div class="chartbox"><canvas id="trend"></canvas></div>
      <div class="legend"><span class="l1">Текущий период</span><span class="l2">Пред. период</span></div>
    </section>

    <section class="grid2">
      <div class="panel">
        <h2>Заказы по дням</h2>
        <div class="chartbox"><canvas id="count"></canvas></div>
      </div>
      <div class="panel">
        <h2>Топ городов</h2>
        <div class="chartbox"><canvas id="cities"></canvas></div>
      </div>
    </section>

    <section class="panel">
      <h2>Таблица: Дни</h2>
      <div id="tbl-days"></div>
    </section>
  </div>

<script>
const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Almaty";
const today = new Date();
const yyyy = today.getFullYear(), mm = String(today.getMonth()+1).padStart(2,'0'), dd = String(today.getDate()).padStart(2,'0');
const endDefault = `${yyyy}-${mm}-${dd}`;
const startDate = new Date(today.getTime() - 29*24*3600*1000);
const sy = startDate.getFullYear(), sm = String(startDate.getMonth()+1).padStart(2,'0'), sd = String(startDate.getDate()).padStart(2,'0');
const startDefault = `${sy}-${sm}-${sd}`;
document.getElementById('start').value = startDefault;
document.getElementById('end').value = endDefault;

let META = {};
fetch('/meta').then(r=>r.json()).then(m=>{
  META = m;
  (m.date_field_options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; document.getElementById('fields').appendChild(o); });
  document.getElementById('date_field').value = m.date_field_default || 'plannedDeliveryDate';
});

function fmt(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
let charts = {};
function draw(id, type, labels, series, label, extra={}){
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  charts[id] = new Chart(ctx, {
    type,
    data: { labels, datasets: series },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, ...extra }
  });
}

function table(id, headers, rows){
  const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=>`<td class="${i===r.length-1?'r':''}">${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
  document.getElementById(id).innerHTML = `<table>${thead}${tbody}</table>`;
}

async function run(e){
  if (e) e.preventDefault();
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const states = document.getElementById('states').value.trim();
  const exclude_states = document.getElementById('exclude_states').value.trim();
  const date_field = document.getElementById('date_field').value.trim() || (META.date_field_default||'plannedDeliveryDate');
  const q = `start=${start}&end=${end}&tz=${encodeURIComponent(tz)}&date_field=${encodeURIComponent(date_field)}${states?`&states=${encodeURIComponent(states)}`:''}${exclude_states?`&exclude_states=${encodeURIComponent(exclude_states)}`:''}&with_prev=true`;
  const r = await fetch('/orders/analytics?'+q); const t = await r.text(); let data;
  try{ data = JSON.parse(t);} catch{ alert(t); return; }

  // KPIs
  document.getElementById('kpis').innerHTML = `
    <div class="card"><div class="k">Период</div><div class="v">${data.range.start} → ${data.range.end}</div></div>
    <div class="card"><div class="k">Всего заказов</div><div class="v">${fmt(data.total_orders)}</div></div>
    <div class="card"><div class="k">Оборот</div><div class="v">${fmt(data.total_amount)} ${data.currency}</div></div>
    <div class="card"><div class="k">Дата по полю</div><div class="v">${data.date_field}</div></div>`;

  const labels = data.days.map(d=>d.x);
  const curCounts = data.days.map(d=>d.count);
  const prevCounts = data.prev_days.map(d=>d.count);
  draw('trend','line',labels,[
    {label:'Текущий', data:curCounts, tension:.35},
    {label:'Предыдущий', data:prevCounts, borderDash:[4,4], tension:.35}
  ], 'Динамика');

  draw('count','bar',labels,[{label:'Заказы', data:curCounts}], 'Заказы по дням', {plugins:{legend:{display:false}}});

  const cityLabels = data.cities.map(c=>c.city);
  const cityCounts = data.cities.map(c=>c.count);
  draw('cities','bar',cityLabels,[{label:'Заказы', data:cityCounts}], 'Топ городов', {plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:true,maxTicksLimit:12}}}});

  table('tbl-days', ['Дата','Кол-во','Оборот'], data.days.map(d=>[d.x, d.count, fmt(d.amount)+' '+data.currency]));
}

document.getElementById('f').addEventListener('submit', run);
run();
</script>
</body>
</html>
