<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Kaspi ‚Äî Dashboard</title>
<link href="/ui/style.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>(function(){
  try{
    var saved = localStorage.getItem('theme');
    var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(saved==='dark' || (!saved && prefersDark)) document.documentElement.classList.add('dark');
  }catch(e){}
})();</script></head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">‚ö° LeoXpress</div>
      <nav>
        <a class="nav-item" href="#">–ú–æ–π —Å–∫–ª–∞–¥</a>
        <a class="nav-item" href="#">–ü—Ä–µ–¥–∑–∞–∫–∞–∑</a>
        <a class="nav-item" href="#">–î–µ–º–ø–∏–Ω–≥</a>
        <a class="nav-item" href="#">WhatsApp –†–∞—Å—Å—ã–ª–∫–∞</a>
      </nav>
    </aside>
    <div class="content">
<div class="shell">
<header class="top">
<h1>–î–æ–±—Ä—ã–π –¥–µ–Ω—å, LeoXpress</h1>
<div class="tabs">
<button class="btn preset" data-mode="created">–ü—Ä–∏—à–ª–æ —Å–µ–≥–æ–¥–Ω—è</button>
<button class="btn preset" data-mode="planned">–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</button>
<button class="btn preset" data-mode="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</button>
<button class="btn preset" data-mode="kaspi_pack">Kaspi: –£–ø–∞–∫–æ–≤–∫–∞ (–¥–æ 20:00)</button>
</div>
<button class="btn theme-toggle" id="themeToggle" type="button">üåì –¢–µ–º–∞</button></header>
<form class="controls" id="f">
<label>–ù–∞—á–∞–ª–æ <input id="start" required="" type="date"/></label>
<label>–ö–æ–Ω–µ—Ü <input id="end" required="" type="date"/></label>
<label>–¥–æ –≤—Ä–µ–º–µ–Ω–∏ <input id="end_time" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 20:00"/></label>
<label>State(—ã) <input id="states" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä NEW,DELIVERY"/></label>
<label><input checked="" id="excCanceled" type="checkbox"/> –ò—Å–∫–ª—é—á–∏—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</label>
<label>–î–∞—Ç–∞ –ø–æ –ø–æ–ª—é 
        <input id="date_field" list="fields" placeholder="creationDate"/>
<datalist id="fields"></datalist>
</label>
<button class="btn primary" type="submit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
<div class="muted" id="bdInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∞–≥–∞–∑–∏–Ω–∞‚Ä¶</div></form>
<div class="kpis" id="kpis"></div>
<section class="panel">
<h2>–î–∏–Ω–∞–º–∏–∫–∞</h2>
<div class="chartbox"><canvas id="trend"></canvas></div>
<div class="legend"><span class="l1">–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</span><span class="l2">–ü—Ä–µ–¥. –ø–µ—Ä–∏–æ–¥</span></div>
</section>
<section class="grid2">
<div class="panel">
<h2>–ó–∞–∫–∞–∑—ã –ø–æ –¥–Ω—è–º</h2>
<div class="chartbox"><canvas id="count"></canvas></div>
</div>
<div class="panel">
<h2>–¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤</h2>
<div class="chartbox"><canvas id="cities"></canvas></div>
</div>
</section>
<section class="panel">
<h2>–°–æ—Å—Ç–æ—è–Ω–∏—è (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</h2>
<div id="tbl-states"></div>
</section>
<section class="panel">
<div class="flexrow">
<h2>–ù–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è —Å–≤–µ—Ä–∫–∏)</h2>
<div class="actions">
<button class="btn" id="copyIds">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä–∞</button>
<a class="btn" download="" id="csvLink">–°–∫–∞—á–∞—Ç—å CSV</a>
</div>
</div>
<div id="idsTable"></div>
</section>
<section class="panel">
<h2>–¢–∞–±–ª–∏—Ü–∞: –î–Ω–∏</h2>
<div id="tbl-days"></div>
</section>
</div>
<script>
const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Almaty";
const today = new Date();
const yyyy = today.getFullYear(), mm = String(today.getMonth()+1).padStart(2,'0'), dd = String(today.getDate()).padStart(2,'0');
const endDefault = `${yyyy}-${mm}-${dd}`;
const startDate = new Date(today.getTime() - 6*24*3600*1000);
const sy = startDate.getFullYear(), sm = String(startDate.getMonth()+1).padStart(2,'0'), sd = String(startDate.getDate()).padStart(2,'0');
const startDefault = `${sy}-${sm}-${sd}`;
document.getElementById('start').value = startDefault;
document.getElementById('end').value = endDefault;

let META = {};
fetch('/meta').then(r=>r.json()).then(m=>{
  META = m;
  (m.date_field_options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; document.getElementById('fields').appendChild(o); });
  document.getElementById('date_field').value = m.date_field_default || 'creationDate';
});

function fmt(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
let charts = {};
function draw(id, type, labels, series, extra={}){
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  charts[id] = new Chart(ctx, { type, data:{ labels, datasets:series }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, ...extra } });
}

function table(id, headers, rows){
  const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r=>`<tr>${r.map((c,i)=>`<td class="${i===r.length-1?'r':''}">${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
  document.getElementById(id).innerHTML = `<table>${thead}${tbody}</table>`;
}

function applyPreset(mode){
  const start = new Date();
  const yyyy = start.getFullYear(), mm = String(start.getMonth()+1).padStart(2,'0'), dd = String(start.getDate()).padStart(2,'0');
  const todayStr = `${yyyy}-${mm}-${dd}`;
  document.getElementById('start').value = todayStr;
  document.getElementById('end').value = todayStr;
  document.getElementById('end_time').value = '';
  document.getElementById('states').value = '';
  document.getElementById('excCanceled').checked = true;

  if (mode === 'created'){ document.getElementById('date_field').value = 'creationDate'; }
  if (mode === 'planned'){ document.getElementById('date_field').value = 'plannedDeliveryDate'; }
  if (mode === 'delivered'){ document.getElementById('date_field').value = 'deliveryDate'; }
  if (mode === 'kaspi_pack'){ 
    document.getElementById('date_field').value = 'plannedShipmentDate'; 
    document.getElementById('states').value = 'KASPI_DELIVERY,ARCHIVE';
    document.getElementById('end_time').value = '20:00';
  }
  run();
}
document.querySelectorAll('.preset').forEach(b=> b.addEventListener('click', e=> applyPreset(e.target.dataset.mode)));

function buildQuery(base){
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const end_time = document.getElementById('end_time').value.trim();
  const states = document.getElementById('states').value.trim();
  const excCanceled = document.getElementById('excCanceled').checked;
  const date_field = document.getElementById('date_field').value.trim() || (META.date_field_default||'creationDate');
  const q = `start=${start}&end=${end}&tz=${encodeURIComponent(tz)}&date_field=${encodeURIComponent(date_field)}${states?`&states=${encodeURIComponent(states)}`:''}&exclude_canceled=${excCanceled}${end_time?`&end_time=${encodeURIComponent(end_time)}`:''}`;
  return base + q;
}

async function loadIds(){
  const url = buildQuery('/orders/ids?');
  const r = await fetch(url); const t = await r.text(); let data;
  try{ data = JSON.parse(t);} catch{ alert(t); return; }
  const rows = data.items.map(it => [it.number, it.state, it.date.replace('T',' ').slice(0,16), it.amount, it.city]);
  table('idsTable', ['–ù–æ–º–µ—Ä','State','–î–∞—Ç–∞','–°—É–º–º–∞','–ì–æ—Ä–æ–¥'], rows);
  const csvHref = buildQuery('/orders/ids.csv?');
  document.getElementById('csvLink').href = csvHref;
  document.getElementById('copyIds').onclick = () => {
    const all = data.items.map(it=>it.number).join('\n');
    navigator.clipboard.writeText(all);
  };
}

async function run(e){
  if (e) e.preventDefault();
  const url = buildQuery('/orders/analytics?') + '&with_prev=true';
  const r = await fetch(url); const t = await r.text(); let data;
  try{ data = JSON.parse(t);} catch{ alert(t); return; }

  document.getElementById('kpis').innerHTML = `
    <div class="card"><div class="k">–ü–µ—Ä–∏–æ–¥</div><div class="v">${data.range.start} ‚Üí ${data.range.end}${document.getElementById('end_time').value?` –¥–æ ${document.getElementById('end_time').value}`:''}</div></div>
    <div class="card"><div class="k">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div><div class="v">${fmt(data.total_orders)}</div></div>
    <div class="card"><div class="k">–û–±–æ—Ä–æ—Ç</div><div class="v">${fmt(data.total_amount)} ${data.currency}</div></div>
    <div class="card"><div class="k">–î–∞—Ç–∞ –ø–æ –ø–æ–ª—é</div><div class="v">${data.date_field}</div></div>`;

  const labels = data.days.map(d=>d.x);
  const curCounts = data.days.map(d=>d.count);
  const prevCounts = data.prev_days.map(d=>d.count);
  draw('trend','line',labels,[{label:'–¢–µ–∫—É—â–∏–π', data:curCounts, tension:.35},{label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π', data:prevCounts, borderDash:[4,4], tension:.35}], {plugins:{legend:{display:true}}});
  draw('count','bar',labels,[{label:'–ó–∞–∫–∞–∑—ã', data:curCounts}], {plugins:{legend:{display:false}}});

  const cityLabels = data.cities.map(c=>c.city);
  const cityCounts = data.cities.map(c=>c.count);
  draw('cities','bar',cityLabels,[{label:'–ó–∞–∫–∞–∑—ã', data:cityCounts}], {plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:true,maxTicksLimit:12}}}});

  const stRows = Object.entries(data.state_breakdown).sort((a,b)=>b[1]-a[1]).map(([s,c])=>[s,c]);
  table('tbl-states', ['State','–ö–æ–ª-–≤–æ'], stRows);

  table('tbl-days', ['–î–∞—Ç–∞','–ö–æ–ª-–≤–æ','–û–±–æ—Ä–æ—Ç'], data.days.map(d=>[d.x, d.count, fmt(d.amount)+' '+data.currency]));

  await loadIds();
  const use_bd = document.getElementById('use_bd')?.checked;
  const bd_start = document.getElementById('bd_start')?.value||'20:00';
  const el = document.getElementById('bdInfo');
  if(el){ el.textContent = use_bd?(`–î–µ–Ω—å –º–∞–≥–∞–∑–∏–Ω–∞: ${bd_start} ‚Üí ${bd_start}`):'–î–µ–Ω—å –º–∞–≥–∞–∑–∏–Ω–∞: –≤—ã–∫–ª—é—á–µ–Ω'; }
}

document.getElementById('f').addEventListener('submit', run);
run();
</script>
<script>
document.getElementById('themeToggle')?.addEventListener('click', ()=>{
  const el = document.documentElement;
  const isDark = el.classList.toggle('dark');
  try{ localStorage.setItem('theme', isDark?'dark':'light'); }catch(e){}
});

async function showBDInfo(){
  try{
    const r = await fetch('/meta'); if(!r.ok) throw 0;
    const data = await r.json();
    const el = document.getElementById('bdInfo');
    if(!el) return;
    if(data.use_business_day){
      el.textContent = `–î–µ–Ω—å –º–∞–≥–∞–∑–∏–Ω–∞: ${data.business_day_start} ‚Üí ${data.business_day_start} (–ø–æ ${data.timezone})`;
    }else{
      el.textContent = '–î–µ–Ω—å –º–∞–≥–∞–∑–∏–Ω–∞: –≤—ã–∫–ª—é—á–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–±—ã—á–Ω—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ —Å—É—Ç–∫–∏)';
    }
  }catch(e){
    const el = document.getElementById('bdInfo');
    if(el) el.textContent = '';
  }
}
showBDInfo();
</script></body>
    </div>
  </div>
</html>
