<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaspi Orders Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b0c0f; --fg:#e5e7eb; --muted:#9ca3af; --line:#2a2f3a; --card:#111318; --accent:#10b981;
      --danger:#ef4444; --warn:#f59e0b;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff; --accent:#059669;
      --danger:#dc2626; --warn:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;border-right:1px solid var(--line);padding:16px;background:var(--card)}
    .content{flex:1;min-width:0;padding:16px 18px}

    .brand{font-weight:800;letter-spacing:.3px;margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:6px;margin:6px 0 16px}
    .nav a{padding:6px 8px;border-radius:8px;color:var(--fg);text-decoration:none}
    .nav a:hover{background:var(--bg)}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .filters input,.filters select{height:32px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:8px;padding:0 10px}
    .btn{height:32px;padding:0 12px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:8px;cursor:pointer}
    .btn.secondary{opacity:.9}
    .btn[disabled]{opacity:.5;pointer-events:none}

    .shell{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:12px;margin:16px 0}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi-item{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:170px}
    .kpi-label{font-size:12px;color:var(--muted)}
    .kpi-value{font-size:22px;font-weight:700}
    .kpi-sub{font-size:12px;color:var(--muted)}

    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;background:var(--card);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#9ca3af;display:inline-block}
    .dot.on{background:var(--accent)} .dot.warn{background:var(--warn)} .dot.err{background:var(--danger)}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:top;text-align:left}
    .table thead th{font-size:12px;color:var(--muted);font-weight:600}
    .nowrap{white-space:nowrap}
    .codes-cell{max-width:520px;white-space:normal;word-break:break-word}
    .clickable{cursor:pointer;text-decoration:underline}

    .order-table{width:100%;border-collapse:collapse;margin:6px 0 12px}
    .order-table th,.order-table td{padding:6px 8px;border-bottom:1px solid var(--line);font-size:13px}

    .note{margin:8px 0 12px;padding:10px 12px;border-radius:10px;display:none;position:relative}
    .note.ok,.note.progress{display:block;background:color-mix(in oklab, var(--accent) 14%, transparent);border:1px solid color-mix(in oklab, var(--accent) 48%, transparent);color:var(--fg)}
    .note.err{display:block;background:color-mix(in oklab, var(--danger) 14%, transparent);border:1px solid color-mix(in oklab, var(--danger) 48%, transparent);color:var(--fg)}
    .note .small{font-size:12px;color:var(--muted)}
    .note.progress{position:sticky; top:8px; z-index:6000; box-shadow:0 8px 24px rgba(0,0,0,.15)}

    .progress {height:12px;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:rgba(255,255,255,.06);margin-top:6px}
    .progress .bar{height:100%;width:0%;background:var(--accent);transition:width .2s cubic-bezier(.4,0,.2,1)}

    #topLoader{position:sticky; top:0; left:0; right:0; height:3px; z-index:7000; background:transparent}
    #topLoader .bar{height:100%; width:0%; background:var(--accent); transition:width .2s cubic-bezier(.4,0,.2,1)}

    .ids-summary{margin:8px 0}
    .ids-actions{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    .ids-groups details{margin:8px 0}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;margin:2px 4px 0 0;background:var(--card)}
    .matrix-sku a{display:inline-block;margin:2px 8px 2px 0}
    .theme-switch{display:flex;align-items:center;gap:8px;margin-top:auto}
    .switch{position:relative;display:inline-block;width:40px;height:20px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px;transition:.2s}
    .slider:before{position:absolute;content:"";height:16px;width:16px;left:2px;top:2px;background:white;border-radius:50%;transition:.2s}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    body,.note{-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}

    .status-control{position:relative;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chips .chip{cursor:default}
    .chips .chip .x{cursor:pointer;opacity:.8;margin-left:6px}
    .status-menu{position:absolute;top:110%;left:0;z-index:5000;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px;width:320px;box-shadow:0 12px 30px rgba(0,0,0,.22);display:none}
    .status-menu.open{display:block}
    .status-grid{max-height:320px;overflow:auto;margin:6px 0;display:grid;grid-template-columns:1fr;gap:2px}
    .status-grid label{display:flex;align-items:center;gap:8px;padding:4px 6px}
    .menu-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
  </style>
</head>
<body data-theme="light">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">⚡ LeoXpress</div>
      <nav class="nav">
        <a href="stock.html">Мой склад</a>
        <a href="#">Предзаказ</a>
        <a href="#">Демпинг</a>
        <a href="#">WhatsApp Рассылка</a>
      </nav>
      <div class="theme-switch">
        <label class="switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label>
        <span>Тёмная тема</span>
      </div>
    </aside>

    <main class="content">
      <div id="topLoader"><div class="bar"></div></div>

      <h1 style="margin:0 0 12px">Аналитика заказов Kaspi</h1>

      <!-- ФИЛЬТРЫ -->
      <form id="f" class="filters shell" style="margin-top:12px">
        <div class="row">
          <label>Начало</label><input type="date" id="start" required>
          <label>Конец</label><input type="date" id="end" required>
          <label>Часовой пояс</label><input type="text" id="tz" value="Asia/Almaty" style="width:140px">
          <label>Поле даты</label><select id="date_field" style="width:220px"></select>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="status-control">
            <label>Статусы (включить)</label>
            <input type="text" id="states" placeholder="через запятую: Новый, Доставлен…" style="min-width:320px" />
            <button class="btn secondary" id="btnStates" type="button">Выбрать</button>
            <div id="statusChips" class="chips"></div>

            <div id="statusMenu" class="status-menu">
              <div style="font-weight:600">Выберите статусы</div>
              <div class="status-grid" id="statusGrid"></div>
              <div class="menu-actions">
                <button class="btn secondary" type="button" id="btnStatusesAll">Все</button>
                <button class="btn secondary" type="button" id="btnStatusesClear">Очистить</button>
                <button class="btn" type="button" id="btnStatusesApply">Готово</button>
              </div>
            </div>
          </div>

          <label class="chk"><input type="checkbox" id="exclude_states" checked> Исключить CANCELED</label>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="chk"><input type="checkbox" id="use_bd" checked> День магазина</label>
          <label>Начало дня</label><input type="time" id="bd_start" value="20:00" step="60">
          <label>Режим дня</label>
          <select id="assign_mode" title="Как определяем, к какому дню относится заказ" style="width:220px">
            <option value="smart">Умный: приём до HH:MM + бизнес-день</option>
            <option value="business">Бизнес-день (до времени «Начало дня»)</option>
            <option value="raw">По выбранному полю даты (без сдвигов)</option>
          </select>
          <label>Приём до</label><input type="time" id="store_until" value="17:00" step="60" title="Заказы после этого времени и без комплектации идут на завтра">
          <label>Обогащение</label>
          <select id="enrich_scope" title="Глубина обогащения SKU" style="width:180px">
            <option value="none">Не обогащать</option>
            <option value="last_day">За последний день</option>
            <option value="last_week">За последнюю неделю</option>
            <option value="last_month">За последний месяц</option>
            <option value="all" selected>За весь период</option>
          </select>

          <span id="bdInfo" class="muted"></span>
          <button type="submit" class="btn" id="btn-run" style="margin-left:auto">Показать</button>
        </div>
      </form>

      <div id="note" class="note"></div>

      <!-- KPI ПЕРИОДА -->
      <section class="kpi">
        <div class="kpi-item"><div class="kpi-label">Период</div><div class="kpi-value" id="periodLabel">—</div><div class="kpi-sub">до <span id="periodCutoff">—:—</span></div></div>
        <div class="kpi-item"><div class="kpi-label">Заказы</div><div class="kpi-value" id="kpiOrders">0</div></div>
        <div class="kpi-item"><div class="kpi-label">Оборот</div><div class="kpi-value" id="kpiAmount">0</div></div>
      </section>

      <!-- БЛОК FIFO -->
      <section class="shell">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h2 style="margin:0">Прибыль (FIFO)</h2>
          <div class="row" style="gap:10px;align-items:center">
            <span id="profitKeyBadge" class="chip" title="Ключ для защищённых эндпоинтов"><span class="dot"></span><span>ключ не задан</span></span>
            <span id="profitSyncChip" class="chip" title="Статус синхронизации"><span class="dot"></span><span>статус неизвестен</span></span>
            <button type="button" class="btn secondary" id="btnProfitApiKey">API-Key</button>
            <label for="profitGroup">Группировка</label>
            <select id="profitGroup"><option value="day">День</option><option value="week">Неделя</option><option value="month">Месяц</option></select>
            <button type="button" class="btn secondary" id="btnProfitSync">Синхронизировать</button>
            <button type="button" class="btn secondary" id="btnProfitRebuild" title="Пересчитать списания FIFO за период">Перестроить FIFO</button>
            <button type="button" class="btn" id="btnProfitSyncRebuild">Синхронизировать + Перестроить</button>
          </div>
        </div>

        <div id="profitDbInfo" class="muted" style="margin:6px 0 10px"></div>

        <div class="kpi" style="margin-top:10px">
          <div class="kpi-item"><div class="kpi-label">Выручка</div><div class="kpi-value" id="kpiPRevenue">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Комиссия</div><div class="kpi-value" id="kpiPCommission">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Себестоимость</div><div class="kpi-value" id="kpiPCost">0</div></div>
          <div class="kpi-item"><div class="kpi-label">Прибыль</div><div class="kpi-value" id="kpiPProfit">0</div></div>
        </div>

        <div id="profitChartHolder" style="margin-top:8px"><canvas id="profitChart"></canvas></div>
        <div id="profitEmpty" class="muted" style="display:none;padding:8px 0">Нет данных для выбранного периода</div>

        <div class="row" style="gap:16px; margin-top:16px; align-items:flex-start; flex-wrap:wrap">
          <div style="flex:1; min-width:340px">
            <h3 style="margin:0 0 6px">Таблица периодов</h3>
            <table id="tbl-profit" class="table">
              <thead><tr>
                <th>Период</th><th>Выручка</th><th>Комиссия</th><th>Себестоимость</th><th>Прибыль</th><th>Номера заказа</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="flex:1; min-width:340px">
            <h3 style="margin:0 0 6px">Топ SKU по прибыли <span class="muted">(кликните SKU — покажем номера заказов)</span></h3>
            <table id="tbl-profit-sku" class="table">
              <thead><tr><th>SKU</th><th>Выручка</th><th>Комиссия</th><th>Себестоимость</th><th>Прибыль</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="shell" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Заказы по SKU</h3>
            <div class="row">
              <input type="text" id="skuSearch" placeholder="введите SKU" style="min-width:260px">
              <button class="btn" id="btnSkuSearch" type="button">Показать</button>
              <button class="btn secondary" id="btnSkuClear" type="button">Очистить</button>
            </div>
          </div>
          <div id="skuOrdersInfo" class="muted" style="margin:8px 0"></div>
          <div id="skuOrders"></div>
        </div>
      </section>

      <!-- МАТРИЦА: № заказа → SKU -->
      <section class="shell">
        <h3 style="margin:0 0 6px">Привязка: № заказа → SKU</h3>
        <div id="orderSkuMatrix" class="muted">Пусто…</div>
      </section>

      <!-- ГОРОДА / ДИАГНОСТИКА -->
      <section class="shell">
        <h2>Топ города</h2>
        <div id="chart-cities"><canvas id="cities"></canvas></div>
      </section>

      <section class="shell">
        <h2>Состояния (диагностика)</h2>
        <div id="statesBox" class="pillbox"></div>
      </section>

      <section class="shell">
        <h2>Номера заказов (для сверки)</h2>
        <div id="ids"></div>
      </section>
    </main>
  </div>

<script>
/* ─────────── ХЕЛПЕРЫ ─────────── */
const nf = new Intl.NumberFormat('ru-RU');
function fmt(n){ return nf.format(Math.round((Number(n) + Number.EPSILON) * 100) / 100); }

let BUSY = false;
function setBusy(on){
  BUSY = !!on;
  for(const id of ['btnProfitSync','btnProfitRebuild','btnProfitSyncRebuild','btn-run','btnSkuSearch']){
    const b = document.getElementById(id);
    if(!b) continue;
    b.disabled = on;
    b.dataset.label ??= b.textContent;
    b.textContent = on ? ('⏳ ' + b.dataset.label) : b.dataset.label;
  }
}

function setTopLoader(p){
  const bar = document.querySelector('#topLoader .bar');
  if(bar) bar.style.width = (p>0 ? `${Math.min(100, Math.max(2, Math.round(p*100)))}%` : '0%');
}

function setNote(msg, mode='ok'){
  const el = document.getElementById('note');
  el.className = 'note ' + (mode==='progress' ? 'progress' : mode);
  if(mode==='progress'){
    el.innerHTML = `
      <div style="font-weight:600">${msg}</div>
      <div class="small" id="jobText">Подготовка…</div>
      <div class="progress"><div class="bar" id="jobBar" style="width:0%"></div></div>
      <div class="row" style="margin-top:6px">
        <button class="btn secondary" id="btnCancelJob" type="button">Отменить</button>
      </div>`;
    setTopLoader(0.04);
  }else{
    el.textContent = msg;
    setTopLoader(0);
  }
  el.style.display = 'block';
}
function updateProgress(phase, done, total, pct, msg){
  const t = document.getElementById('jobText');
  const b = document.getElementById('jobBar');
  const txt = `${phase==='scan'?'Выгружаем номера заказов':'Обогащаем SKU'} — ${done}/${Math.max(1,total)} · ${Math.round(pct*100)}%` + (msg?` · ${msg}`:'');
  if(t) t.textContent = txt;
  if(b) b.style.width = `${Math.max(1, Math.round(pct*100))}%`;
  setTopLoader(pct);
}
function hideNote(){ const el=document.getElementById('note'); el.style.display='none'; el.textContent=''; el.className='note'; setTopLoader(0); }
window.addEventListener('error', e => setNote(e?.error?.message || e.message || 'Ошибка', 'err'));
window.addEventListener('unhandledrejection', e => setNote(e?.reason?.message || String(e.reason) || 'Ошибка', 'err'));

function fmtMs(ms){
  if(!ms && ms!==0) return '';
  try{
    const tz = document.getElementById('tz')?.value || 'Asia/Almaty';
    const d  = new Date(Number(ms));
    const parts = new Intl.DateTimeFormat('ru-RU', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).formatToParts(d);
    const g = k => parts.find(p=>p.type===k)?.value || '';
    return `${g('year')}-${g('month')}-${g('day')} ${g('hour')}:${g('minute')}`;
  }catch(_){ return new Date(Number(ms)).toISOString().slice(0,16).replace('T',' '); }
}
</script>

<script>
/* ─────────── UI/STATE ─────────── */
let citiesChart=null, profitChart=null;
window.APP_CURRENCY='KZT';
window.__ordersByPeriod={};
window.__orderToSkus={};
let CURRENT_JOB_ID=null;

/* ─────────── multiselect статусов ─────────── */
const STATUS_DICT = {
  NEW: 'Новый',
  APPROVED_BY_BANK: 'Оплата подтверждена',
  ACCEPTED_BY_MERCHANT: 'Принят магазином',
  READY_FOR_SHIPMENT: 'Готов к отгрузке',
  KASPI_DELIVERY: 'Kaspi Доставка (передан)',
  DELIVERED: 'Доставлен',
  ARCHIVE: 'Завершён (архив)',
  ARCHIVED: 'Архив (история)',
  RETURNED: 'Возврат',
  CANCELED: 'Отменён',
};
const STATUS_ORDER = ['NEW','APPROVED_BY_BANK','ACCEPTED_BY_MERCHANT','READY_FOR_SHIPMENT','KASPI_DELIVERY','DELIVERED','ARCHIVE','ARCHIVED','RETURNED','CANCELED'];
const LABEL_TO_CODE = Object.fromEntries(Object.entries(STATUS_DICT).map(([k,v])=>[v.toLowerCase(),k]));

window.STATUS_SELECTED = new Set();

function ruLabel(code){ return STATUS_DICT[code] || code; }

function renderStatusGrid(){
  const g=document.getElementById('statusGrid'); g.innerHTML='';
  STATUS_ORDER.forEach(code=>{
    const id='st_'+code;
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" id="${id}" value="${code}"> <span>${ruLabel(code)}</span>`;
    lab.querySelector('input').checked = window.STATUS_SELECTED.has(code);
    lab.querySelector('input').addEventListener('change', (e)=>{
      if(e.target.checked) window.STATUS_SELECTED.add(code); else window.STATUS_SELECTED.delete(code);
      renderStatusChips(); syncStatesInput();
    });
    g.appendChild(lab);
  });
}
function renderStatusChips(){
  const box=document.getElementById('statusChips'); box.innerHTML='';
  if(window.STATUS_SELECTED.size===0){ box.innerHTML='<span class="muted">ничего не выбрано</span>'; return; }
  [...window.STATUS_SELECTED].forEach(code=>{
    const c=document.createElement('span'); c.className='chip'; c.innerHTML=`${ruLabel(code)}<span class="x" title="убрать">×</span>`;
    c.querySelector('.x').onclick=()=>{ window.STATUS_SELECTED.delete(code); renderStatusChips(); renderStatusGrid(); syncStatesInput(); };
    box.appendChild(c);
  });
}
function normalizeStatesValue(val){
  if(!val) return '';
  const merged = new Set();
  val.split(/[\s,;]+/).filter(Boolean).forEach(raw=>{
    const t = raw.trim();
    const code = LABEL_TO_CODE[t.toLowerCase()] || t.toUpperCase();
    merged.add(code);
  });
  return [...merged].join(',');
}
function syncStatesInput(){
  const inp=document.getElementById('states');
  const manual = normalizeStatesValue((inp.value||'').trim());
  const fromSet = [...window.STATUS_SELECTED];
  const merged = new Set();
  if(manual){ manual.split(',').forEach(x=>merged.add(x)); }
  fromSet.forEach(x=>merged.add(x));
  inp.value = [...merged].filter(Boolean).join(',');
}
function openStatusMenu(){
  const m=document.getElementById('statusMenu');
  m.classList.add('open'); renderStatusGrid();
  const close=(ev)=>{ if(!m.contains(ev.target) && !document.getElementById('btnStates').contains(ev.target)){ m.classList.remove('open'); document.removeEventListener('click', close, true); } };
  setTimeout(()=>document.addEventListener('click', close, true),0);
}

const DATE_FIELD_LABELS = {
  creationDate: 'Создание заказа',
  plannedShipmentDate: 'План передачи',
  shipmentDate: 'Фактическая передача',
  deliveryDate: 'Фактическая доставка'
};

async function loadMeta(){
  try {
    const meta = await fetch('/meta').then(r=>r.json());
    const sel = document.getElementById('date_field');
    sel.innerHTML = '';
    (meta.date_field_options || ['creationDate']).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=DATE_FIELD_LABELS[v] || v; sel.appendChild(o);
    });
    sel.value = meta.date_field_default || 'creationDate';
    document.getElementById('tz').value = meta.timezone || 'Asia/Almaty';
    document.getElementById('bd_start').value = meta.business_day_start || '20:00';
    document.getElementById('store_until').value = meta.store_accept_until || '17:00';
  } catch(_){}
  const today = new Date(); const iso = d=>d.toISOString().slice(0,10);
  document.getElementById('start').value = iso(today);
  document.getElementById('end').value   = iso(today);

  renderStatusChips();
}

function uiModeHint(){
  const use_bd = document.getElementById('use_bd')?.checked;
  const bd = document.getElementById('bd_start').value || '20:00';
  const cutoff = document.getElementById('store_until').value || '17:00';
  const mode = document.getElementById('assign_mode').value;
  const el = document.getElementById('bdInfo');
  if(mode==='smart') el.textContent = `Умный режим: приём до ${cutoff}; доставленные — бизнес-день ${bd}`;
  else if(mode==='business') el.textContent = `Бизнес-день: ${bd} → ${bd}`;
  else el.textContent = 'Режим: по выбранному полю даты';
  if(!use_bd) el.textContent += ' · День магазина: выключен';
}

async function run(e){
  if(e) e.preventDefault();
  try{
    setBusy(true);
    const start = document.getElementById('start').value;
    const end   = document.getElementById('end').value;
    const tz    = document.getElementById('tz').value || 'Asia/Almaty';
    const date_field = document.getElementById('date_field').value;
    const states = normalizeStatesValue(document.getElementById('states').value);
    document.getElementById('states').value = states;
    const exc    = document.getElementById('exclude_states').checked ? 'CANCELED' : '';
    const use_bd = document.getElementById('use_bd')?.checked ? '1' : '0';
    const bd_start = document.getElementById('bd_start')?.value || '';
    const assign_mode = document.getElementById('assign_mode').value || 'smart';
    const store_until = document.getElementById('store_until').value || '17:00';

    const p = new URLSearchParams({ start, end, tz, date_field, use_bd, assign_mode, store_accept_until: store_until });
    if(states) p.set('states', states); if(exc) p.set('exclude_states', exc);
    if(bd_start) p.set('business_day_start', bd_start);

    const data = await fetch(`/orders/analytics?${p.toString()}`).then(r=>r.json());

    window.APP_CURRENCY = data.currency || 'KZT';
    document.getElementById('kpiOrders').textContent = fmt(data.total_orders||0);
    document.getElementById('kpiAmount').textContent = `${fmt(data.total_amount||0)} ${window.APP_CURRENCY}`;
    document.getElementById('periodLabel').textContent = `${data.range?.start||start} → ${data.range?.end||end}`;
    document.getElementById('periodCutoff').textContent = (use_bd==='1' ? (bd_start || '20:00') : '24:00');
    uiModeHint();

    // состояния
    const sb = document.getElementById('statesBox');
    sb.innerHTML = '';
    const entries = Object.entries(data.state_breakdown||{}).sort((a,b)=>b[1]-a[1]);
    entries.forEach(([k,v])=>{ const span=document.createElement('span'); span.className='pill'; span.textContent=`${k}: ${v}`; sb.appendChild(span); });
    if(!entries.length) sb.innerHTML = '<div class="muted">Нет данных</div>';

    // города
    const labels = (data.cities||[]).map(c=>c.city);
    const counts = (data.cities||[]).map(c=>c.count);
    const holder = document.getElementById('chart-cities');
    holder.innerHTML = labels.length ? '<canvas id="cities"></canvas>' : '<div class="muted" style="padding:12px">Нет данных по городам</div>';
    if(labels.length && typeof Chart!=='undefined'){
      try{ if(citiesChart) citiesChart.destroy(); }catch(_){}
      const ctx = document.getElementById('cities').getContext('2d');
      citiesChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Заказы',data:counts}]},options:{responsive:true,plugins:{legend:{display:false}}}});
    }

    // ——— ПОЛНАЯ СИНХРОНИЗАЦИЯ МОСТА + визуализация ———
    await runIdsJob();          // async выгрузка номеров (+обогащение)
    await loadProfitFIFO();     // FIFO KPI/таблицы
    await renderOrderSkuMatrix(); // матрица заказ→SKU
    await checkProfitStatus(data);

    setNote('Данные обновлены', 'ok');
  }catch(err){ setNote('Ошибка загрузки: ' + (err?.message || err), 'err'); }
  finally{ setBusy(false); }
}
</script>

<script>
/* ─────────── НОМЕРА ЗАКАЗОВ: async-джоба + мост + рендер ─────────── */
function buildOrderItemsTable(group, currency){
  const table = document.createElement('table'); table.className = 'order-table';
  table.innerHTML = `
    <thead><tr>
      <th class="nowrap">№ заказа</th><th>SKU</th><th>Название</th><th class="nowrap">Qty</th>
      <th class="nowrap">Сумма строки</th><th class="nowrap">Состояние</th><th class="nowrap">Время</th>
    </tr></thead><tbody></tbody>`;
  const tb = table.querySelector('tbody');

  for(const o of (group.items||[])){
    const lines = (o.items && o.items.length)
      ? o.items.map(li=>({sku:String(li.sku||''),title:String(li.title||''),qty:Number(li.qty||1),sum:Number(li.total_price ?? li.amount ?? li.unit_price ?? 0)}))
      : [{sku:String(o.sku||''),title:String(o.title||o.name||''),qty:1,sum:Number(o.amount||0)}];

    for(const li of lines){
      const tr=document.createElement('tr');
      [ String(o.number||''), li.sku||'', li.title||'', String(li.qty||1),
        `${fmt(li.sum||0)} ${currency}`, o.state||'', (String(o.date||'').slice(0,16).replace('T',' ')||'') ]
      .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      tb.appendChild(tr);
    }
  }
  return table;
}

/* → СИНХРОНИЗАЦИЯ МОСТА: из результата ids.async соберём плоские строки и отправим в /profit/bridge/sync-by-ids */
async function syncBridgeFromIdsData(data){
  try{
    const items = [];
    for(const g of (data.groups||[])){
      for(const o of (g.items||[])){
        const orderId   = String(o.id ?? o.order_id ?? o.number ?? '').trim();
        const orderCode = String(o.number ?? o.order_code ?? '').trim() || null;
        const state     = String(o.state||'').trim() || null;
        const date      = o.date_ms ?? o.date ?? null;

        let idx = 0;
        const lines = Array.isArray(o.items) && o.items.length
          ? o.items
          : (o.sku ? [{ sku:o.sku, qty:1, total_price:o.amount, title:o.title||o.name }] : []);

        for(const li of (lines||[])){
          const skuRaw = li.sku ?? li.code ?? '';
          const sku = String(skuRaw ?? '').trim();
          const qty = Number(li.qty ?? 1) || 1;
          const total = Number(li.total_price ?? li.amount ?? li.unit_price ?? 0) || 0;
          const unit  = (Number(li.unit_price ?? 0) || (qty>0 ? total/qty : 0));
          items.push({
            id: orderId,
            code: orderCode,
            date: date,
            state: state,
            sku: sku || null,
            title: (li.title ?? li.name ?? null),
            qty: qty,
            unit_price: unit,
            total_price: total,
            line_index: idx++,
          });
        }
      }
    }
    if(!items.length) return;

    const res = await fetch('/profit/bridge/sync-by-ids', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(items)
    });
    if(!res.ok) throw new Error(await res.text()||res.statusText);
    const j = await res.json();
    console.log('bridge sync:', j);
  }catch(e){
    console.warn('bridge sync failed:', e);
    setNote('Синхронизация моста не удалась: ' + (e.message||e), 'err');
  }
}

async function renderOrderSkuMatrix(){
  const df=document.getElementById('start').value;
  const dt=document.getElementById('end').value;
  const box=document.getElementById('orderSkuMatrix');
  box.innerHTML='Загружаем…';

  try{
    const url = '/profit/bridge/by-orders-margins?' + new URLSearchParams({
      date_from: df, date_to: dt, state: 'KASPI_DELIVERY', order: 'asc'
    }).toString();
    const data = await fetchProfitJSON(url);
    const cur = window.APP_CURRENCY || 'KZT';

    if(!data.orders?.length){ box.classList.add('muted'); box.textContent='Нет данных'; return; }

    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML=`<thead>
      <tr><th style="width:200px">№ заказа</th><th>SKU</th>
          <th>Выручка</th><th>Комиссия</th><th>Себестоимость</th><th>Прибыль</th></tr>
    </thead><tbody></tbody>`;
    const tb=tbl.querySelector('tbody');

    window.__ordersByPeriod = window.__ordersByPeriod || {};

    for(const ord of data.orders){
      for(const it of (ord.items||[])){
        const tr=document.createElement('tr');

        const tdNum=document.createElement('td'); tdNum.textContent = ord.order_code || ord.order_id || ''; tr.appendChild(tdNum);

        const tdSku=document.createElement('td'); tdSku.className='matrix-sku';
        const a=document.createElement('a'); a.textContent=it.sku||''; a.href='#';
        a.onclick=(e)=>{ e.preventDefault(); showOrdersForSKU(it.sku); };
        tdSku.appendChild(a); tr.appendChild(tdSku);

        const cols=[it.total_price, it.commission, it.cost, it.profit]
          .map(v => `${fmt(v||0)} ${cur}`);
        for(const v of cols){ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); }

        tb.appendChild(tr);
      }
    }

    box.classList.remove('muted'); box.innerHTML=''; box.appendChild(tbl);
  }catch(e){
    box.className='muted'; box.textContent='Ошибка: ' + (e.message||e);
  }
}

function buildParams(){
  const start = document.getElementById('start').value;
  const end   = document.getElementById('end').value;
  const tz    = document.getElementById('tz').value || 'Asia/Almaty';
  const date_field = document.getElementById('date_field').value;
  const states = normalizeStatesValue(document.getElementById('states').value);
  document.getElementById('states').value = states;
  const exc    = document.getElementById('exclude_states').checked ? 'CANCELED' : '';
  const use_bd = document.getElementById('use_bd')?.checked ? '1' : '0';
  const bd_start = document.getElementById('bd_start')?.value || '';
  const assign_mode = document.getElementById('assign_mode').value || 'smart';
  const store_until = document.getElementById('store_until').value || '17:00';
  const enrich_scope = document.getElementById('enrich_scope').value || 'all';

  const p = new URLSearchParams({
    start,end,tz,date_field,order:'asc',grouped:'1',limit:'0',with_items:'1',
    use_bd,business_day_start:bd_start,assign_mode,store_accept_until:store_until,items_mode:'all',enrich_scope
  });
  if(states) p.set('states', states); if(exc) p.set('exclude_states', exc);
  return p;
}

async function runIdsJob(){
  if(CURRENT_JOB_ID){
    try{ await fetch(`/jobs/${CURRENT_JOB_ID}`, {method:'DELETE'}); }catch(_){}
    CURRENT_JOB_ID = null;
  }

  setNote('Готовим данные…', 'progress');
  setBusy(true);

  const params = buildParams();
  const res = await fetch(`/orders/ids.async?${params.toString()}`, {method:'POST'});
  if(!res.ok){ const txt = await res.text(); setNote(txt || res.statusText, 'err'); setBusy(false); return; }
  const { job_id } = await res.json();
  CURRENT_JOB_ID = job_id;

  const cancelBtn = document.getElementById('btnCancelJob');
  if(cancelBtn) cancelBtn.onclick = async () => {
    try{ await fetch(`/jobs/${job_id}`, {method:'DELETE'}); }catch(_){}
  };

  let done=false, errored=false;
  while(!done && !errored){
    await new Promise(r=>setTimeout(r, 700));
    let st;
    try{
      const r = await fetch(`/jobs/${job_id}`);
      if(!r.ok){ throw new Error(await r.text()||r.statusText); }
      st = await r.json();
    }catch(e){
      errored=true; setNote('Ошибка статуса: '+(e.message||e), 'err'); break;
    }

    if(st.status==='error'){ errored=true; setNote('Ошибка: '+(st.message||'неизвестно'), 'err'); break; }
    if(st.status==='canceled'){ errored=true; setNote('Операция отменена', 'err'); break; }

    updateProgress(st.phase, st.done||0, st.total||1, Math.max(0, Math.min(1, st.progress||0)), st.message||'');

    if(st.status==='done'){
      done=true;
      const rr = await fetch(`/jobs/${job_id}/result`);
      const data = await rr.json();
      CURRENT_JOB_ID=null;

      // ← новая обязательная часть: прокидываем строки в мост
      await syncBridgeFromIdsData(data);

      await renderIdsResult(data);
      break;
    }
  }

  setBusy(false);
}

async function renderIdsResult(data){
  window.__ordersByPeriod = {};
  for(const g of (data.groups||[])){
    const nums = (g.items||[]).map(it=>it.number).filter(Boolean);
    window.__ordersByPeriod[g.day] = Array.from(new Set(nums));
  }

  window.__orderToSkus = {};
  for(const g of (data.groups||[])){
    for(const o of (g.items||[])){
      const arr = Array.isArray(o.items)&&o.items.length
        ? o.items.map(li=>String(li.sku||'').trim()).filter(Boolean)
        : (o.sku ? [String(o.sku)] : []);
      if(!arr.length) continue;
      const key = String(o.number||'').trim(); if(!key) continue;
      window.__orderToSkus[key] = Array.from(new Set([...(window.__orderToSkus[key]||[]), ...arr]));
    }
  }

  const container = document.getElementById('ids'); container.innerHTML='';
  const currency = data.currency || window.APP_CURRENCY || 'KZT';
  const totalCount = (typeof data.period_total_count === 'number') ? data.period_total_count : (data.items||[]).length;
  const totalAmount = (typeof data.period_total_amount === 'number') ? data.period_total_amount : (data.items||[]).reduce((a,it)=>a+(Number(it.amount)||0),0);

  const summary = document.createElement('div'); summary.className='ids-summary';
  summary.innerHTML = `<span>Итого за период:</span> <b>${fmt(totalCount)}</b><span> шт.</span> · <b>${fmt(totalAmount)}</b> <span>${currency}</span>`;
  container.appendChild(summary);

  const bar = document.createElement('div'); bar.className='ids-actions';
  const btnCopy=document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Скопировать номера';
  btnCopy.onclick=()=>{ try{ const all=(data.items||[]).map(it=>it.number).join('\n'); navigator.clipboard?.writeText(all); setNote('Скопировано', 'ok'); }catch(_){ setNote('Не удалось скопировать', 'err'); } };
  const btnCsv=document.createElement('a'); btnCsv.className='btn'; btnCsv.textContent='Скачать CSV';

  const params = buildParams(); params.set('grouped','0'); params.set('with_items','0'); params.set('limit','100000');
  btnCsv.href=`/orders/ids.csv?${params.toString()}`; btnCsv.setAttribute('download','ids.csv');

  const btnExpand=document.createElement('button'); btnExpand.className='btn'; btnExpand.textContent='Раскрыть всё';
  const btnCollapse=document.createElement('button'); btnCollapse.className='btn'; btnCollapse.textContent='Свернуть всё';
  bar.append(btnCopy,btnCsv,btnExpand,btnCollapse); container.appendChild(bar);

  const wrapper=document.createElement('div'); wrapper.className='ids-groups'; container.appendChild(wrapper);
  const detailsList=[];
  for(const group of (data.groups||[])){
    const det=document.createElement('details'); det.open=true;
    const dayTotal=(typeof group.total_amount==='number')?group.total_amount:group.items.reduce((acc,it)=>acc+(Number(it.amount)||0),0);
    const sum=document.createElement('summary'); sum.textContent=`${group.day} — ${group.items.length} шт. · ${fmt(dayTotal)} ${currency}`;
    det.appendChild(sum); det.appendChild(buildOrderItemsTable(group, currency));
    detailsList.push(det); wrapper.appendChild(det);
  }
  btnExpand.onclick=()=>detailsList.forEach(d=>d.open=true);
  btnCollapse.onclick=()=>detailsList.forEach(d=>d.open=false);

  setNote('Данные обновлены', 'ok');
}
</script>

<script>
/* ─────────── FIFO: ключ/инъекции + API-хелперы ─────────── */
(()=> {
  const KEY="KASPI_API_KEY";
  const badge=()=>document.getElementById('profitKeyBadge');
  function refreshBadge(){ const v=localStorage.getItem(KEY)||""; const el=badge(); el.querySelector('.dot').className='dot ' + (v ? 'on' : ''); el.querySelector('span:last-child').textContent = v ? 'ключ установлен' : 'ключ не задан'; }
  window.KASPI_API_KEY=localStorage.getItem(KEY)||""; refreshBadge();

  const origFetch=window.fetch.bind(window);
  window.fetch=function(input,init){
    try{
      let urlStr=typeof input==='string'?input:(input&&input.url)||'';
      if(urlStr.startsWith('/profit/')){
        init=init||{};
        const k=window.KASPI_API_KEY||'';
        let headers=init.headers instanceof Headers?init.headers:new Headers(init.headers||{});
        if(k) headers.set('X-API-Key',k);
        init.headers=headers;
        if(k){ const u=new URL(urlStr,location.origin); if(!u.searchParams.has('api_key')) u.searchParams.set('api_key',k);
          input=(typeof input==='string')?(u.pathname+u.search):new Request(u.toString(),init);
        }
      }
    }catch(_){}
    return origFetch(input,init);
  };

  window.setApiKey=function(k){ localStorage.setItem(KEY,k||''); window.KASPI_API_KEY=k||''; refreshBadge(); };

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('btnProfitApiKey')?.addEventListener('click', ()=>{
      const v=prompt('Введите X-API-Key (сохранится в этом браузере):', window.KASPI_API_KEY||'');
      if(v!==null){ setApiKey(v.trim()); alert('Сохранено. Повторите действие.'); }
    });
  });
})();

async function fetchProfitJSON(url, opts, _retry){
  const r=await fetch(url, opts||{});
  if(r.status===401||r.status===403){
    if(!_retry){ const v=prompt('Укажите X-API-Key для блока FIFO:', window.KASPI_API_KEY||''); if(v!==null){ window.setApiKey(v.trim()); return fetchProfitJSON(url, opts, true); } }
    throw new Error(await r.text()||'Unauthorized');
  }
  if(!r.ok){ const body=await r.text(); throw new Error(body||r.statusText||('HTTP '+r.status)); }
  const ct=r.headers.get('content-type')||''; return ct.includes('application/json')?r.json():r.text();
}

function setFifoKPIs(total,cur){
  const t=total||{revenue:0,commission:0,cost:0,profit:0};
  document.getElementById('kpiPRevenue').textContent   = `${fmt(t.revenue||0)} ${cur}`;
  document.getElementById('kpiPCommission').textContent= `${fmt(t.commission||0)} ${cur}`;
  document.getElementById('kpiPCost').textContent      = `${fmt(t.cost||0)} ${cur}`;
  document.getElementById('kpiPProfit').textContent    = `${fmt(t.profit||0)} ${cur}`;
}

function drawProfitChart(rows,cur){
  const empty=document.getElementById('profitEmpty'); const holder=document.getElementById('profitChartHolder'); const canvas=document.getElementById('profitChart');
  if(!canvas||typeof Chart==='undefined'){ if(empty) empty.style.display='block'; if(holder) holder.style.display='none'; return; }
  const ctx=canvas.getContext('2d'); if(profitChart){ try{ profitChart.destroy(); }catch(_){ } profitChart=null; }
  if(!(rows||[]).length){ if(empty) empty.style.display='block'; if(holder) holder.style.display='none'; return; }
  if(empty) empty.style.display='none'; if(holder) holder.style.display='block';
  profitChart=new Chart(ctx,{ type:'bar',
    data:{ labels:(rows||[]).map(r=>r.period), datasets:[{ label:'Прибыль', data:(rows||[]).map(r=>Number(r.profit||0)) }] },
    options:{ responsive:true, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>`Прибыль: ${fmt(c.parsed.y)} ${cur}` } } }, scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true } } }
  });
}

async function pingProfitDb(){
  try{ const info=await fetchProfitJSON('/profit/db/ping'); const driver=info?.driver||(info?.db_path?.startsWith('postgres')?'pg':'sqlite');
    document.getElementById('profitDbInfo').textContent = `FIFO DB: ${driver}${info?.fallback_enabled?' · fallback:on':''}`;
  }catch(_){ document.getElementById('profitDbInfo').textContent=''; }
}
</script>

<script>
/* ─────────── FIFO: операции ─────────── */
async function syncProfit(){
  const start=document.getElementById('start').value;
  const end  =document.getElementById('end').value;
  if(!start||!end){ setNote('Сначала задайте период (начало/конец).', 'err'); return; }

  const tz=document.getElementById('tz').value||'Asia/Almaty';
  const date_field=document.getElementById('date_field').value;
  const use_bd=document.getElementById('use_bd')?.checked ? '1':'0';
  const bd_start=document.getElementById('bd_start')?.value||'20:00';

  try{
    const qs=new URLSearchParams({ start,end,tz,date_field,states:'KASPI_DELIVERY',exclude_states:'CANCELED',use_bd,business_day_start:bd_start,order:'asc',grouped:'0',limit:'100000',with_items:'1',items_mode:'all' });
    const ids=await (await fetch('/orders/ids?'+qs.toString())).json();

    const orders=(ids.items||[]).filter(x=>x.state==='KASPI_DELIVERY').map(x=>{
      const lines = Array.isArray(x.items)&&x.items.length
        ? x.items.filter(li=>li&&li.sku).map(li=>({sku:String(li.sku),qty:Number(li.qty||1),unit_price:Number(li.unit_price ?? (li.total_price && li.qty ? li.total_price/li.qty : 0))}))
        : (x.sku ? [{ sku:String(x.sku), qty:1, unit_price:Number(x.amount||0) }] : []);
      return { id:x.id, date:x.date, customer:null, items:lines };
    }).filter(o=>o.items.length);

    if(!orders.length){ setNote('Нет заказов KASPI_DELIVERY с позициями в выбранном периоде', 'err'); return; }

    const up=await fetch('/profit/orders/upsert-bulk',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({orders}) });
    if(!up.ok) throw new Error(await up.text()||up.statusText);
    const upRes=await up.json();

    const rb=await fetch(`/profit/rebuild-ledger?date_from=${start}&date_to=${end}`,{method:'POST'});
    if(!rb.ok) throw new Error(await rb.text()||rb.statusText);
    const rbRes=await rb.json();

    setNote(`Синхронизация FIFO: заказов=${upRes.orders_inserted+upRes.orders_updated}, позиций=${upRes.items_inserted}, списаний=${rbRes.recomputed}`, 'ok');

    await runIdsJob(); await loadProfitFIFO(); await renderOrderSkuMatrix(); await checkProfitStatus();
  }catch(e){ setNote('Синхронизация не удалась: ' + (e.message||e), 'err'); }
}

async function rebuildFifo(){
  if(BUSY) return;
  const df=document.getElementById('start').value;
  const dt=document.getElementById('end').value;
  if(!df||!dt){ setNote('Сначала задайте период (начало/конец).', 'err'); return; }
  setBusy(true);
  try{
    const p=new URLSearchParams({date_from:df,date_to:dt});
    const res=await fetchProfitJSON('/profit/rebuild-ledger?'+p.toString(),{method:'POST'});
    setNote(`FIFO перестроен. Добавлено списаний: ${res?.recomputed||0}`, 'ok');
    await runIdsJob(); await loadProfitFIFO(); await renderOrderSkuMatrix(); await checkProfitStatus();
  }catch(e){ setNote('Перестроение FIFO не удалось: ' + e.message, 'err'); }
  finally{ setBusy(false); }
}

async function syncAndRebuild(){
  await syncProfit(); if(BUSY) return; setBusy(true);
  try{
    const df=document.getElementById('start').value; const dt=document.getElementById('end').value;
    const p=new URLSearchParams({date_from:df,date_to:dt});
    const res=await fetchProfitJSON('/profit/rebuild-ledger?'+p.toString(),{method:'POST'});
    setNote(`Синхр.+пересчёт выполнены. Списаний: ${res?.recomputed||0}`, 'ok');
    await runIdsJob(); await loadProfitFIFO(); await renderOrderSkuMatrix(); await checkProfitStatus();
  }catch(e){ setNote('Пересчёт не удался: ' + e.message, 'err'); }
  finally{ setBusy(false); }
}
</script>

<script>
/* ─────────── FIFO: статус + KPI + таблицы + Заказы по SKU ─────────── */
function setSyncChip(state,text){
  const el=document.getElementById('profitSyncChip'); const dot=el.querySelector('.dot');
  dot.className='dot ' + (state==='ok'?'on':state==='warn'?'warn':state==='err'?'err':'');
  el.querySelector('span:last-child').textContent=text; el.title=text;
}

async function checkProfitStatus(analyticsData){
  try{
    const df=document.getElementById('start').value; const dt=document.getElementById('end').value;
    if(!df||!dt){ setSyncChip('warn','нет периода'); return; }
    const p=new URLSearchParams({ date_from:df, date_to:dt, group_by:'total', use_bd:(document.getElementById('use_bd')?.checked?'1':'0'), bd_start:(document.getElementById('bd_start')?.value||'20:00') });
    const sum=await fetchProfitJSON('/profit/summary?'+p.toString());
    const t=sum.total||{revenue:0,commission:0,cost:0,profit:0};

    if((t.revenue||0)>0 || (t.cost||0)>0 || (t.commission||0)>0 || (t.profit||0)!==0) setSyncChip('ok','синхронизировано');
    else setSyncChip('','нет данных FIFO в периоде');
  }catch(_){ setSyncChip('err','ошибка проверки статуса'); }
}

async function loadProfitFIFO(){
  const df=document.getElementById('start').value;
  const dt=document.getElementById('end').value;
  if(!df||!dt) return;

  const use_bd=document.getElementById('use_bd')?.checked?'1':'0';
  const bd_start=document.getElementById('bd_start')?.value||'20:00';
  const group_by=document.getElementById('profitGroup')?.value||'day';

  try{
    const p=new URLSearchParams({date_from:df,date_to:dt,group_by,use_bd,bd_start});
    const sum=await fetchProfitJSON('/profit/summary?'+p.toString());
    const cur=sum.currency||window.APP_CURRENCY||'KZT';
    setFifoKPIs(sum.total,cur); drawProfitChart(sum.rows||[], cur);

    const tb=document.querySelector('#tbl-profit tbody'); tb.innerHTML='';
    for(const r of (sum.rows||[])){
      const tr=document.createElement('tr');
      const nums=(window.__ordersByPeriod && window.__ordersByPeriod[r.period]) ? window.__ordersByPeriod[r.period] : [];
      [ r.period, `${fmt(r.revenue)} ${cur}`, `${fmt(r.commission)} ${cur}`, `${fmt(r.cost)} ${cur}`, `${fmt(r.profit)} ${cur}` ]
       .forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      const tdCodes=document.createElement('td'); tdCodes.textContent = nums.length ? nums.join(', ') : '—'; tdCodes.className='codes-cell'; tr.appendChild(tdCodes);
      tb.appendChild(tr);
    }

    const top = await fetchProfitJSON('/profit/by-sku?'+new URLSearchParams({date_from:df,date_to:dt,limit:50}).toString());
    const tbSku=document.querySelector('#tbl-profit-sku tbody'); tbSku.innerHTML='';
    for(const row of (top.rows||[])){
      const tr=document.createElement('tr');
      const skuTd=document.createElement('td'); skuTd.textContent=row.sku; skuTd.className='clickable'; skuTd.title='Показать номера заказов этого SKU';
      skuTd.addEventListener('click',()=>showOrdersForSKU(row.sku)); tr.appendChild(skuTd);
      [row.revenue,row.commission,row.cost,row.profit].forEach(v=>{ const td=document.createElement('td'); td.textContent=`${fmt(v)} ${cur}`; tr.appendChild(td); });
      tbSku.appendChild(tr);
    }
  }catch(e){
    console.warn('FIFO:',e);
    setFifoKPIs({revenue:0,commission:0,cost:0,profit:0}, window.APP_CURRENCY||'KZT');
    drawProfitChart([], window.APP_CURRENCY||'KZT');
    document.querySelector('#tbl-profit tbody').innerHTML='';
    document.querySelector('#tbl-profit-sku tbody').innerHTML='';
  }
}

async function showOrdersForSKU(sku){
  if(!sku){ setNote('Укажите SKU', 'err'); return; }
  const df=document.getElementById('start').value;
  const dt=document.getElementById('end').value;
  const info=document.getElementById('skuOrdersInfo');
  const holder=document.getElementById('skuOrders');
  info.textContent=`SKU: ${sku} · период ${df} — ${dt}`; holder.innerHTML='';
  try{
    setBusy(true);
    const data=await fetchProfitJSON('/profit/bridge/list?'+new URLSearchParams({sku,date_from:df,date_to:dt,limit:100000}).toString());
    const rows=data.items || data.rows || [];
    if(!rows.length){ holder.innerHTML='<div class="muted">Ничего не найдено</div>'; return; }
    const tbl=document.createElement('table'); tbl.className='table';
    tbl.innerHTML=`<thead><tr><th>№ заказа</th><th>SKU</th><th>Название</th><th>Qty</th><th>Сумма строки</th><th>Состояние</th><th>Время</th></tr></thead><tbody></tbody>`;
    const tb=tbl.querySelector('tbody');
    for(const r of rows){
      const tr=document.createElement('tr');
      [ r.order_code||r.order_id||'', r.sku||'', r.title||'', String(r.qty||1),
        fmt(r.total_price||r.unit_price||0)+' '+(window.APP_CURRENCY||'KZT'),
        r.state||'', r.date||fmtMs(r.date_utc_ms) ]
      .forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      tb.appendChild(tr);
    }
    holder.appendChild(tbl);
    (document.getElementById('skuSearch')||{}).value=sku;
  }catch(e){ holder.innerHTML=`<div class="muted">Ошибка: ${e.message||e}</div>`; }
  finally{ setBusy(false); }
}
</script>

<script>
/* ─────────── BOOT ─────────── */
document.addEventListener('DOMContentLoaded', async () => {
  try{
    await loadMeta();

    document.getElementById('btnStates')?.addEventListener('click', openStatusMenu);
    document.getElementById('btnStatusesAll')?.addEventListener('click', ()=>{
      STATUS_ORDER.forEach(k=>window.STATUS_SELECTED.add(k));
      renderStatusGrid(); renderStatusChips(); syncStatesInput();
    });
    document.getElementById('btnStatusesClear')?.addEventListener('click', ()=>{
      window.STATUS_SELECTED.clear(); renderStatusGrid(); renderStatusChips(); syncStatesInput();
    });
    document.getElementById('btnStatusesApply')?.addEventListener('click', ()=>{
      document.getElementById('statusMenu').classList.remove('open'); syncStatesInput();
    });

    document.getElementById('states')?.addEventListener('blur', ()=>{
      document.getElementById('states').value = normalizeStatesValue(document.getElementById('states').value);
    });

    document.getElementById('f')?.addEventListener('submit', run);
    document.getElementById('themeToggle')?.addEventListener('change', (e)=>{ document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light'); });
    document.getElementById('profitGroup')?.addEventListener('change', loadProfitFIFO);
    document.getElementById('btnProfitRebuild')?.addEventListener('click', rebuildFifo);
    document.getElementById('btnProfitSync')?.addEventListener('click', syncProfit);
    document.getElementById('btnProfitSyncRebuild')?.addEventListener('click', syncAndRebuild);
    document.getElementById('btnSkuSearch')?.addEventListener('click', ()=>showOrdersForSKU((document.getElementById('skuSearch')?.value||'').trim()));
    document.getElementById('btnSkuClear')?.addEventListener('click', ()=>{ document.getElementById('skuSearch').value=''; document.getElementById('skuOrders').innerHTML=''; document.getElementById('skuOrdersInfo').textContent=''; });

    ['use_bd','bd_start','assign_mode','store_until'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('change', uiModeHint);
    });

    uiModeHint();
    await pingProfitDb();
    await run(); // initial
  }catch(e){ setNote('Ошибка инициализации: ' + (e?.message||e), 'err'); }
});
</script>
</body>
</html>
