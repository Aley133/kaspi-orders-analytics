<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaspi Debug — SKU/Title Probe</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 16px;color:#111}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
    label{font-size:12px;color:#555}
    input,select,button{padding:8px;border:1px solid #ddd;border-radius:8px}
    button{background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #111}
    .muted{color:#666}
    .card{border:1px solid #eee;border-radius:10px;padding:12px;margin:12px 0}
    table{width:100%;border-collapse:collapse;margin:6px 0}
    th,td{border-bottom:1px solid #eee;padding:6px 8px;text-align:left;vertical-align:top}
    pre{background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;white-space:pre-wrap}
    .k{color:#6b21a8}
    .v{color:#111}
  </style>
</head>
<body>
  <h1>Kaspi Debug — поиск SKU/названия по номеру заказа</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Номер заказа</label><br/>
        <input id="orderNumber" placeholder="например, 623903299" style="min-width:220px">
      </div>
      <div>
        <label>Начало (YYYY-MM-DD)</label><br/>
        <input id="start" type="date">
      </div>
      <div>
        <label>Конец (YYYY-MM-DD)</label><br/>
        <input id="end" type="date">
      </div>
      <div>
        <label>Поле даты</label><br/>
        <select id="date_field">
          <option>creationDate</option>
          <option>plannedShipmentDate</option>
          <option>shipmentDate</option>
          <option>deliveryDate</option>
        </select>
      </div>
      <div class="row" style="align-self:flex-end">
        <button id="btnFind">Найти</button>
        <button class="secondary" id="btnSample">10 примеров</button>
      </div>
    </div>
    <div class="muted">Сервис берёт твой KASPI_TOKEN из переменных окружения, как и основной бэкенд.</div>
  </div>

  <div id="out"></div>

<script>
function el(tag, cls){ const n=document.createElement(tag); if(cls) n.className=cls; return n; }
function kvTable(obj, title){
  const card = el('div','card');
  if(title){ const h=el('div'); h.innerHTML='<b>'+title+'</b>'; card.appendChild(h); }
  const table = el('table');
  const thead = el('thead'); thead.innerHTML='<tr><th>Ключ</th><th>Значение</th></tr>'; table.appendChild(thead);
  const tb = el('tbody');
  for(const [k,v] of Object.entries(obj||{})){
    const tr = el('tr');
    const td1 = el('td'); td1.innerHTML = '<span class="k">'+k+'</span>'; tr.appendChild(td1);
    const td2 = el('td'); td2.innerHTML = '<span class="v">'+String(v)+'</span>'; tr.appendChild(td2);
    tb.appendChild(tr);
  }
  table.appendChild(tb);
  card.appendChild(table);
  return card;
}

async function call(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function renderItems(items){
  const out = document.getElementById('out');
  out.innerHTML = '';
  if(!items || items.length===0){
    out.innerHTML = '<div class="card">Ничего не найдено в заданном периоде.</div>';
    return;
  }
  for(const it of items){
    const card = el('div','card');
    const h = el('div');
    h.innerHTML = `<b>Заказ:</b> ${it.number} &nbsp; <span class="muted">(order_id: ${it.order_id}, state: ${it.state || '—'})</span>`;
    card.appendChild(h);

    card.appendChild(kvTable(it.top_level_sku_candidates || {}, 'Верхнеуровневые кандидаты SKU (прямо в attributes)'));

    const h2 = el('div'); h2.innerHTML = '<b>Позиции ('+(it.entries_count||0)+')</b>'; card.appendChild(h2);

    if((it.entries||[]).length === 0){
      const p = el('div'); p.className='muted'; p.textContent='Список позиций не найден. Смотри attrs_raw ниже.';
      card.appendChild(p);
    }

    (it.entries||[]).forEach((e)=>{
      const sub = el('div','card');
      sub.style.background='#fbfbff';
      sub.style.borderColor='#eef';
      const t = el('div');
      t.innerHTML = `<b>Позиция #${e.index}</b>`;
      sub.appendChild(t);

      sub.appendChild(kvTable(e.title_candidates || {}, 'Кандидаты названия товара'));
      sub.appendChild(kvTable(e.sku_candidates || {}, 'Кандидаты SKU (артикулов)'));

      const pre = el('pre');
      pre.textContent = JSON.stringify(e.raw || {}, null, 2);
      sub.appendChild(pre);

      card.appendChild(sub);
    });

    const d = el('details');
    d.open = false;
    const sum = el('summary'); sum.textContent='Показать attrs_raw заказа';
    d.appendChild(sum);
    const pre = el('pre'); pre.textContent = JSON.stringify(it.attrs_raw || {}, null, 2);
    d.appendChild(pre);
    card.appendChild(d);

    out.appendChild(card);
  }
}

document.getElementById('btnFind').addEventListener('click', async ()=>{
  const number = document.getElementById('orderNumber').value.trim();
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const date_field = document.getElementById('date_field').value;
  if(!number || !start || !end){ alert('Заполни номер, начало и конец.'); return; }
  const url = `/debug/order-by-number?` + new URLSearchParams({ number, start, end, date_field }).toString();
  try{
    const data = await call(url);
    renderItems(data.items || []);
  }catch(e){
    alert('Ошибка: ' + e.message);
  }
});

document.getElementById('btnSample').addEventListener('click', async ()=>{
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const date_field = document.getElementById('date_field').value;
  if(!start || !end){ alert('Задай период.'); return; }
  const url = `/debug/sample?` + new URLSearchParams({ start, end, date_field }).toString();
  try{
    const data = await call(url);
    renderItems(data.items || []);
  }catch(e){
    alert('Ошибка: ' + e.message);
  }
});

// дефолтные даты — сегодня
(function(){
  const today = new Date();
  const iso = d => d.toISOString().slice(0,10);
  document.getElementById('start').value = iso(today);
  document.getElementById('end').value = iso(today);
})();
</script>
</body>
</html>

